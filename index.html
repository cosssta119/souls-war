<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souls Online - Wyszukiwarka Kontr-Formacji</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nunito:wght@400;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #1a1a1a;
            --bg-input: #252525;
            --accent-gold: #d4af37;
            --accent-red: #8b0000;
            --accent-green: #2e7d32;
            --accent-purple: #6a1b9a;
            --accent-blue: #1e3a5f;
            --text-light: #e8e8e8;
            --text-muted: #888;
            --border: #333;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
        }
        
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--accent-gold); }
        
        header {
            text-align: center;
            padding: 12px 0;
            border-bottom: 2px solid var(--accent-gold);
            margin-bottom: 15px;
        }
        
        header h1 { font-size: 1.3rem; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); cursor: pointer; }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.75rem;
        }
        
        .status-item { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: #4caf50; }
        .status-dot.offline { background: #f44336; }
        
        .admin-badge { background: var(--accent-purple); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px; }
        
        /* Nawigacja */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--accent-gold);
            display: flex;
            z-index: 100;
        }
        
        .nav-btn {
            flex: 1;
            padding: 10px 5px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.65rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.3s;
        }
        
        .nav-btn span.icon { font-size: 1.2rem; }
        .nav-btn.active { color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
        .nav-btn.admin-only { display: none; }
        .nav-btn.admin-only.show { display: flex; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Sekcje */
        .section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        
        .section h2 {
            font-size: 0.95rem;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Inputy */
        .autocomplete-wrapper { position: relative; margin-bottom: 10px; }
        .autocomplete-wrapper label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 3px; }
        
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        input:focus, select:focus { outline: none; border-color: var(--accent-gold); }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        .autocomplete-list.show { display: block; }
        
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .autocomplete-item:hover { background: rgba(212, 175, 55, 0.2); color: var(--accent-gold); }
        .autocomplete-item .race { font-size: 0.7rem; color: var(--text-muted); margin-left: 5px; }
        
        /* Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid .full-width { grid-column: 1 / -1; }
        
        /* Przyciski */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-gold), #b8962e);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-input); color: var(--text-light); border: 1px solid var(--border); }
        .btn-success { background: linear-gradient(135deg, var(--accent-green), #1b5e20); color: white; }
        .btn-danger { background: linear-gradient(135deg, #c62828, #8b0000); color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.8rem; width: auto; margin-top: 0; }
        .btn-admin { background: linear-gradient(135deg, var(--accent-purple), #4a148c); color: white; }
        
        /* Filtry */
        .filter-bar { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .filter-btn {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active { background: var(--accent-gold); color: var(--bg-dark); border-color: var(--accent-gold); }
        
        .search-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        
        /* Wyniki */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .results-header h3 { font-size: 0.9rem; }
        .results-count { font-size: 0.8rem; color: var(--text-muted); }
        
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .result-card:hover { border-color: var(--accent-gold); transform: translateX(5px); }
        
        .result-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .result-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
        
        .match-score { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .match-6, .match-5 { background: #2e7d32; }
        .match-4 { background: #f9a825; color: #000; }
        .match-3 { background: #ef6c00; }
        .match-2 { background: #c62828; }
        
        .result-name { font-size: 0.9rem; margin-bottom: 5px; }
        .result-heroes { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }
        .matched-hero { color: #4caf50; font-weight: 600; }
        
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: 5px; }
        .user-badge { background: var(--accent-purple); color: white; }
        .base-badge { background: var(--accent-blue); color: white; }
        
        /* Formacja */
        .formation-view {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        
        .formation-title {
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .formation-grid { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 10px; }
        .formation-row { display: flex; gap: 8px; justify-content: center; }
        
        .hero-slot {
            width: 70px;
            height: 45px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            text-align: center;
            padding: 3px;
        }
        
        .hero-slot.filled { border-color: var(--accent-gold); background: linear-gradient(135deg, #2a2a2a, #1a1a1a); }
        
        .pet-slot {
            width: 90px;
            height: 40px;
            background: var(--bg-input);
            border: 2px dashed var(--accent-blue);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-top: 5px;
        }
        
        .pet-slot.filled { border-style: solid; border-color: var(--accent-gold); }
        
        .vs-divider { text-align: center; padding: 15px 0; font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--accent-red); }
        .my-formation .formation-title { color: #4caf50; }
        .enemy-formation .formation-title { color: #f44336; }
        
        /* ID Lookup */
        .id-lookup { display: flex; gap: 10px; margin-bottom: 15px; }
        .id-lookup input { flex: 1; }
        .id-lookup .btn { width: auto; padding: 12px 20px; margin-top: 0; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state p { font-size: 0.9rem; }
        
        /* Add form */
        .add-form-section { margin-bottom: 20px; }
        .add-form-section h3 { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .form-row .autocomplete-wrapper { flex: 1; margin-bottom: 0; }
        
        /* Stats */
        .stats-bar { display: flex; justify-content: space-around; padding: 10px; background: var(--bg-input); border-radius: 8px; margin-bottom: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--accent-gold); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); }
        
        /* Database list */
        .database-list { max-height: 60vh; overflow-y: auto; }
        
        .db-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }
        
        .db-item:hover { border-color: var(--accent-gold); }
        .db-item-info { flex: 1; }
        .db-item-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .db-item-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
        .db-item-name { font-size: 0.9rem; }
        .db-item-details { font-size: 0.7rem; color: var(--text-muted); line-height: 1.4; }
        .db-item-actions { display: flex; gap: 5px; margin-left: 10px; }
        
        /* Info box */
        .info-box {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 3px solid var(--accent-gold);
        }
        
        .info-box strong { color: var(--accent-gold); }
        .info-box.success { border-left-color: var(--accent-green); }
        .info-box.error { border-left-color: #c62828; }
        .info-box.admin { border-left-color: var(--accent-purple); background: rgba(106, 27, 154, 0.1); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            max-width: 90%;
        }
        
        .toast.show { opacity: 1; }
        .toast.error { background: #c62828; }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Admin panel */
        .admin-section { border: 2px solid var(--accent-purple); }
        .admin-section h2 { color: var(--accent-purple); }
        
        .entity-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .entity-item:last-child { border-bottom: none; }
        .entity-name { flex: 1; }
        .entity-race { font-size: 0.75rem; color: var(--text-muted); margin-left: 10px; }
        
        .add-entity-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .add-entity-form input, .add-entity-form select { flex: 1; }
        .add-entity-form .btn { width: auto; margin-top: 0; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 20px;
        }
        
        .modal.hidden { display: none; }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            border: 2px solid var(--accent-gold);
        }
        
        .modal-content h2 { text-align: center; margin-bottom: 20px; }
        
        /* Responsive */
        @media (max-width: 360px) {
            .hero-slot { width: 60px; height: 40px; font-size: 0.6rem; }
            .form-row { flex-direction: column; }
            .nav-btn { font-size: 0.6rem; }
            .nav-btn span.icon { font-size: 1rem; }
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="color: var(--accent-gold);">≈Åadowanie danych...</div>
    </div>
    
    <!-- Admin login modal -->
    <div class="modal hidden" id="admin-modal">
        <div class="modal-content">
            <h2>üîê Panel Administratora</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.85rem;">Wpisz has≈Ço administratora</p>
            <input type="password" id="admin-password" placeholder="Has≈Ço..." style="margin-bottom: 10px;">
            <button class="btn btn-admin" onclick="tryAdminLogin()">ZALOGUJ</button>
            <button class="btn btn-secondary" onclick="closeAdminModal()">Anuluj</button>
        </div>
    </div>

    <header>
        <h1 onclick="headerClick()">‚öîÔ∏è SOULS ONLINE ‚öîÔ∏è</h1>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 3px;">
            Wyszukiwarka Kontr-Formacji
            <span class="admin-badge" id="admin-badge" style="display: none;">ADMIN</span>
        </p>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">≈ÅƒÖczenie...</span>
            </div>
            <div class="status-item">
                <span>üìä <span id="total-count">0</span> formacji</span>
            </div>
        </div>
    </header>
    
    <!-- Tab: Wyszukiwarka -->
    <div id="tab-search" class="tab-content active">
        <div class="section">
            <h2>üîç Szukaj kontr-formacji</h2>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;">
                Wpisz sk≈Çad przeciwnika ‚Äî znajdƒô Twoje zwyciƒôskie formacje
            </p>
            
            <div class="form-grid">
                <div class="autocomplete-wrapper">
                    <label>Pozycja 1</label>
                    <input type="text" id="search-pos1" placeholder="np. Taros" autocomplete="off" data-type="hero">
                    <div class="autocomplete-list" id="list-search-pos1"></div>
                </div>
                <div class="autocomplete-wrapper">
                    <label>Pozycja 2</label>
                    <input type="text" id="search-pos2" placeholder="np. Solina" autocomplete="off" data-type="hero">
                    <div class="autocomplete-list" id="list-search-pos2"></div>
                </div>
                <div class="autocomplete-wrapper">
                    <label>Pozycja 3</label>
                    <input type="text" id="search-pos3" placeholder="np. Roze" autocomplete="off" data-type="hero">
                    <div class="autocomplete-list" id="list-search-pos3"></div>
                </div>
                <div class="autocomplete-wrapper">
                    <label>Pozycja 4</label>
                    <input type="text" id="search-pos4" placeholder="np. Nebula" autocomplete="off" data-type="hero">
                    <div class="autocomplete-list" id="list-search-pos4"></div>
                </div>
                <div class="autocomplete-wrapper">
                    <label>Pozycja 5</label>
                    <input type="text" id="search-pos5" placeholder="np. Lena" autocomplete="off" data-type="hero">
                    <div class="autocomplete-list" id="list-search-pos5"></div>
                </div>
                <div class="autocomplete-wrapper">
                    <label>Pet</label>
                    <input type="text" id="search-pet" placeholder="np. Silbren" autocomplete="off" data-type="pet">
                    <div class="autocomplete-list" id="list-search-pet"></div>
                </div>
            </div>
            
            <button class="btn" onclick="searchFormations()">üîç SZUKAJ</button>
            <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 8px;">‚úñ Wyczy≈õƒá</button>
        </div>
        
        <div id="results-section">
            <div class="empty-state">
                <p>Wpisz postacie przeciwnika i kliknij "Szukaj"</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Baza danych -->
    <div id="tab-database" class="tab-content">
        <div class="section">
            <h2>üìö Pe≈Çna baza formacji</h2>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-total">0</div>
                    <div class="stat-label">Wszystkich</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-base">0</div>
                    <div class="stat-label">Bazowych</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-user">0</div>
                    <div class="stat-label">Dodanych</div>
                </div>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all" onclick="setDbFilter('all')">Wszystkie</button>
                <button class="filter-btn" data-filter="base" onclick="setDbFilter('base')">Bazowe</button>
                <button class="filter-btn" data-filter="user" onclick="setDbFilter('user')">Dodane</button>
                <input type="text" class="search-input" id="db-search" placeholder="üîç Szukaj..." oninput="filterDatabase()">
            </div>
            
            <div id="database-list" class="database-list"></div>
        </div>
    </div>
    
    <!-- Tab: PodglƒÖd -->
    <div id="tab-view" class="tab-content">
        <div class="section">
            <h2>üëÅÔ∏è PodglƒÖd formacji</h2>
            <div class="id-lookup">
                <input type="number" id="lookup-id" placeholder="Wpisz ID (np. 12)">
                <button class="btn" onclick="lookupById()">POKA≈ª</button>
            </div>
        </div>
        
        <div id="formation-display">
            <div class="empty-state">
                <p>Wpisz ID aby zobaczyƒá uk≈Çad formacji</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Dodaj -->
    <div id="tab-add" class="tab-content">
        <div class="section">
            <h2>‚ûï Dodaj nowƒÖ formacjƒô</h2>
            
            <div class="autocomplete-wrapper full-width" style="margin-bottom: 15px;">
                <label>Nazwa formacji</label>
                <input type="text" id="add-name" placeholder="np. Cossta 01-01-2025 W1">
            </div>
            
            <div class="add-form-section">
                <h3>‚öîÔ∏è Tw√≥j sk≈Çad</h3>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 1</label><input type="text" id="add-my1" data-type="hero"><div class="autocomplete-list" id="list-add-my1"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 2</label><input type="text" id="add-my2" data-type="hero"><div class="autocomplete-list" id="list-add-my2"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 3</label><input type="text" id="add-my3" data-type="hero"><div class="autocomplete-list" id="list-add-my3"></div></div>
                </div>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 4</label><input type="text" id="add-my4" data-type="hero"><div class="autocomplete-list" id="list-add-my4"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 5</label><input type="text" id="add-my5" data-type="hero"><div class="autocomplete-list" id="list-add-my5"></div></div>
                </div>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 6</label><input type="text" id="add-my6" data-type="hero"><div class="autocomplete-list" id="list-add-my6"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 7</label><input type="text" id="add-my7" data-type="hero"><div class="autocomplete-list" id="list-add-my7"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 8</label><input type="text" id="add-my8" data-type="hero"><div class="autocomplete-list" id="list-add-my8"></div></div>
                </div>
                <div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
                    <label>Pet</label>
                    <input type="text" id="add-myPet" data-type="pet">
                    <div class="autocomplete-list" id="list-add-myPet"></div>
                </div>
            </div>
            
            <div class="add-form-section">
                <h3>üëπ Sk≈Çad przeciwnika</h3>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 1</label><input type="text" id="add-enemy1" data-type="hero"><div class="autocomplete-list" id="list-add-enemy1"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 2</label><input type="text" id="add-enemy2" data-type="hero"><div class="autocomplete-list" id="list-add-enemy2"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 3</label><input type="text" id="add-enemy3" data-type="hero"><div class="autocomplete-list" id="list-add-enemy3"></div></div>
                </div>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 4</label><input type="text" id="add-enemy4" data-type="hero"><div class="autocomplete-list" id="list-add-enemy4"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 5</label><input type="text" id="add-enemy5" data-type="hero"><div class="autocomplete-list" id="list-add-enemy5"></div></div>
                </div>
                <div class="form-row">
                    <div class="autocomplete-wrapper"><label>Poz 6</label><input type="text" id="add-enemy6" data-type="hero"><div class="autocomplete-list" id="list-add-enemy6"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 7</label><input type="text" id="add-enemy7" data-type="hero"><div class="autocomplete-list" id="list-add-enemy7"></div></div>
                    <div class="autocomplete-wrapper"><label>Poz 8</label><input type="text" id="add-enemy8" data-type="hero"><div class="autocomplete-list" id="list-add-enemy8"></div></div>
                </div>
                <div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
                    <label>Pet</label>
                    <input type="text" id="add-enemyPet" data-type="pet">
                    <div class="autocomplete-list" id="list-add-enemyPet"></div>
                </div>
            </div>
            
            <button class="btn btn-success" onclick="saveFormation()">üíæ ZAPISZ FORMACJƒò</button>
            <button class="btn btn-secondary" onclick="clearAddForm()" style="margin-top: 8px;">‚úñ Wyczy≈õƒá</button>
        </div>
    </div>
    
    <!-- Tab: Ustawienia -->
    <div id="tab-settings" class="tab-content">
        <div class="section">
            <h2>‚öôÔ∏è Import / Eksport</h2>
            
            <div class="info-box" id="connection-info">
                <strong>üîó Status:</strong> Sprawdzanie po≈ÇƒÖczenia...
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 20px 0 10px;">üì§ Eksport do CSV</h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">
                Pobierz wszystkie formacje jako plik CSV (kompatybilny z poprzedniƒÖ wersjƒÖ)
            </p>
            <button class="btn" onclick="exportToCSV()">üì§ Eksportuj CSV</button>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">üì• Import z CSV</h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">
                Wczytaj formacje z pliku CSV (ten sam format co eksport)
            </p>
            <button class="btn btn-success" onclick="document.getElementById('csv-input').click()">üì• Importuj CSV</button>
            <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="importFromCSV(event)">
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">üîÑ Synchronizacja</h3>
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ Od≈õwie≈º dane</button>
        </div>
    </div>
    
    <!-- Tab: Admin (ukryty domy≈õlnie) -->
    <div id="tab-admin" class="tab-content">
        <div class="section admin-section">
            <h2>üëë Panel Administratora</h2>
            
            <div class="info-box admin">
                <strong>üîê Tryb Admin aktywny</strong><br>
                Mo≈ºesz zarzƒÖdzaƒá bohaterami, petami i usuwaƒá dowolne formacje.
            </div>
            
            <!-- ZarzƒÖdzanie bohaterami -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 20px 0 10px;">‚öîÔ∏è Bohaterowie (<span id="heroes-count">0</span>)</h3>
            <div class="entity-list" id="heroes-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-hero-name" placeholder="Nazwa bohatera">
                <select id="new-hero-race">
                    <option value="Dark">Dark</option>
                    <option value="Light">Light</option>
                    <option value="Undead">Undead</option>
                    <option value="Elf">Elf</option>
                    <option value="Fire">Fire</option>
                    <option value="Human">Human</option>
                </select>
                <button class="btn btn-success btn-small" onclick="addHero()">‚ûï</button>
            </div>
            
            <!-- ZarzƒÖdzanie petami -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üêæ Pety (<span id="pets-count">0</span>)</h3>
            <div class="entity-list" id="pets-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-pet-name" placeholder="Nazwa peta">
                <button class="btn btn-success btn-small" onclick="addPet()">‚ûï</button>
            </div>
            
            <!-- ZarzƒÖdzanie formacjami -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üìã ZarzƒÖdzanie formacjami</h3>
            <button class="btn btn-danger" onclick="deleteAllUserFormations()">üóëÔ∏è Usu≈Ñ wszystkie formacje u≈ºytkownik√≥w</button>
            <button class="btn btn-secondary" onclick="initializeBaseData()" style="margin-top: 8px;">üìã Za≈Çaduj bazƒô startowƒÖ (126)</button>
            
            <!-- Wyloguj -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üö™ Sesja</h3>
            <button class="btn btn-secondary" onclick="adminLogout()">üö™ Wyloguj z trybu Admin</button>
        </div>
    </div>
    
    <!-- Nawigacja -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('search')"><span class="icon">üîç</span><span>Szukaj</span></button>
        <button class="nav-btn" onclick="switchTab('database')"><span class="icon">üìö</span><span>Baza</span></button>
        <button class="nav-btn" onclick="switchTab('view')"><span class="icon">üëÅÔ∏è</span><span>PodglƒÖd</span></button>
        <button class="nav-btn" onclick="switchTab('add')"><span class="icon">‚ûï</span><span>Dodaj</span></button>
        <button class="nav-btn" onclick="switchTab('settings')"><span class="icon">‚öôÔ∏è</span><span>Import</span></button>
        <button class="nav-btn admin-only" id="nav-admin" onclick="switchTab('admin')"><span class="icon">üëë</span><span>Admin</span></button>
    </nav>
    
    <div class="toast" id="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // =====================================================
        // üî• FIREBASE CONFIGURATION - UZUPE≈ÅNIJ SWOIMI DANYMI!
        // =====================================================

		const firebaseConfig = {
		  apiKey: "AIzaSyAZSC5B3HfX1AxOKFR06ixlFh0cgdwKY7M",
		  authDomain: "souls-online-war.firebaseapp.com",
		  databaseURL: "https://souls-online-war-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "souls-online-war",
		  storageBucket: "souls-online-war.firebasestorage.app",
		  messagingSenderId: "700986594564",
		  appId: "1:700986594564:web:114ff3c81a42edb1d2ac51"
		};
        
        // üîê HAS≈ÅO ADMINISTRATORA - ZMIE≈É NA W≈ÅASNE!
        const ADMIN_PASSWORD = "souls2025admin";
        // =====================================================
        
        // Zmienne globalne
        let db = null;
        let formationsRef = null;
        let heroesRef = null;
        let petsRef = null;
        let allFormations = [];
        let isOnline = false;
        let isAdmin = false;
        let headerClickCount = 0;
        let headerClickTimer = null;
        
        // Domy≈õlne dane
        let heroes = [
            {name:"Dmitri",race:"Dark"},{name:"Roze",race:"Dark"},{name:"Nebula",race:"Dark"},{name:"Zeke",race:"Dark"},
            {name:"Benzel",race:"Dark"},{name:"Lilith",race:"Dark"},{name:"Bahzam",race:"Dark"},{name:"Zagrako",race:"Dark"},
            {name:"Lumen",race:"Light"},{name:"Akmon",race:"Light"},{name:"Leovalt",race:"Light"},{name:"Lena",race:"Light"},
            {name:"Ulion",race:"Light"},{name:"Nuel",race:"Light"},{name:"Solina",race:"Light"},{name:"Taros",race:"Light"},
            {name:"Muerte",race:"Undead"},{name:"Melantha",race:"Undead"},{name:"Nox",race:"Undead"},{name:"Ripper",race:"Undead"},
            {name:"Fleta",race:"Undead"},{name:"Ash",race:"Undead"},{name:"Dextor",race:"Undead"},{name:"Carmen",race:"Undead"},
            {name:"Zenon",race:"Undead"},{name:"Amanda",race:"Undead"},{name:"Void",race:"Undead"},{name:"Harfa",race:"Undead"},
            {name:"Serena",race:"Elf"},{name:"Oneric",race:"Elf"},{name:"Elara",race:"Elf"},{name:"CoCo",race:"Elf"},
            {name:"Babu",race:"Elf"},{name:"Sander",race:"Elf"},{name:"Tania",race:"Elf"},{name:"Galan",race:"Elf"},
            {name:"Aolmond",race:"Elf"},{name:"LuLu",race:"Elf"},{name:"Fiona",race:"Elf"},{name:"Abala",race:"Elf"},
            {name:"Bella",race:"Fire"},{name:"Lupico",race:"Fire"},{name:"Paopao",race:"Fire"},{name:"Jack",race:"Fire"},
            {name:"Dolucos",race:"Fire"},{name:"Aruru",race:"Fire"},{name:"Kaion",race:"Fire"},{name:"Paru",race:"Fire"},
            {name:"Naru",race:"Fire"},{name:"Telfer",race:"Fire"},{name:"Lagou",race:"Fire"},
            {name:"Morra",race:"Human"},{name:"Scarlet",race:"Human"},{name:"Kyle",race:"Human"},{name:"Adora",race:"Human"},
            {name:"Rakan",race:"Human"},{name:"Olga",race:"Human"},{name:"Idina",race:"Human"},{name:"Ken",race:"Human"},
            {name:"Calix",race:"Human"},{name:"Odelia",race:"Human"},{name:"Milia",race:"Human"},{name:"Richelle",race:"Human"},
            {name:"Liandra",race:"Human"}
        ];
        
        let pets = ["Gladis","Nasrune","Romanelle","Tianum","Hamm","Spooky","Mystet","Bloombell","Silbren","Vailo","Estelle","Banavi","Moko"];
        
        // Inicjalizacja Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            formationsRef = db.ref('formations');
            heroesRef = db.ref('heroes');
            petsRef = db.ref('pets');
            
            // Nas≈Çuchiwanie formacji
            formationsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allFormations = data ? Object.values(data) : [];
                allFormations.sort((a, b) => a.id - b.id);
                updateUI();
                hideLoading();
                setOnlineStatus(true);
            }, (error) => {
                console.error('Firebase error:', error);
                setOnlineStatus(false);
                hideLoading();
            });
            
            // Nas≈Çuchiwanie bohater√≥w
            heroesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    heroes = Object.values(data);
                    heroes.sort((a, b) => a.name.localeCompare(b.name));
                    if (isAdmin) renderHeroesList();
                }
            });
            
            // Nas≈Çuchiwanie pet√≥w
            petsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    pets = Object.values(data).map(p => p.name || p);
                    pets.sort();
                    if (isAdmin) renderPetsList();
                }
            });
            
            // Sprawdzanie po≈ÇƒÖczenia
            db.ref('.info/connected').on('value', (snap) => {
                setOnlineStatus(snap.val() === true);
            });
            
        } catch (error) {
            console.error('Firebase init error:', error);
            setOnlineStatus(false);
            hideLoading();
        }
        
        // ========== ADMIN ==========
        
        function headerClick() {
            headerClickCount++;
            clearTimeout(headerClickTimer);
            
            if (headerClickCount >= 5) {
                headerClickCount = 0;
                if (isAdmin) {
                    showToast('Ju≈º jeste≈õ zalogowany jako Admin');
                } else {
                    document.getElementById('admin-modal').classList.remove('hidden');
                }
            } else {
                headerClickTimer = setTimeout(() => headerClickCount = 0, 2000);
            }
        }
        
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-password').value = '';
        }
        
        function tryAdminLogin() {
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                localStorage.setItem('souls_admin', 'true');
                closeAdminModal();
                enableAdminMode();
                showToast('üîì Zalogowano jako Administrator!');
            } else {
                showToast('‚ùå Nieprawid≈Çowe has≈Ço!', true);
            }
        }
        
        function enableAdminMode() {
            isAdmin = true;
            document.getElementById('admin-badge').style.display = 'inline';
            document.getElementById('nav-admin').classList.add('show');
            renderHeroesList();
            renderPetsList();
            filterDatabase(); // Od≈õwie≈º listƒô z przyciskami usuwania
        }
        
        function adminLogout() {
            isAdmin = false;
            localStorage.removeItem('souls_admin');
            document.getElementById('admin-badge').style.display = 'none';
            document.getElementById('nav-admin').classList.remove('show');
            switchTab('search');
            filterDatabase();
            showToast('üö™ Wylogowano z trybu Admin');
        }
        
        function checkAdminSession() {
            if (localStorage.getItem('souls_admin') === 'true') {
                enableAdminMode();
            }
        }
        
        // ========== ZARZƒÑDZANIE BOHATERAMI ==========
        
        function renderHeroesList() {
            const container = document.getElementById('heroes-list');
            document.getElementById('heroes-count').textContent = heroes.length;
            
            const byRace = {};
            heroes.forEach(h => {
                if (!byRace[h.race]) byRace[h.race] = [];
                byRace[h.race].push(h);
            });
            
            let html = '';
            Object.keys(byRace).sort().forEach(race => {
                html += `<div style="font-size:0.7rem;color:var(--accent-gold);margin:10px 0 5px;border-bottom:1px solid var(--border);padding-bottom:3px;">${race} (${byRace[race].length})</div>`;
                byRace[race].forEach(hero => {
                    html += `
                        <div class="entity-item">
                            <span class="entity-name">${hero.name}</span>
                            <button class="btn btn-danger btn-small" onclick="deleteHero('${hero.name}')">üóëÔ∏è</button>
                        </div>`;
                });
            });
            
            container.innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">Brak bohater√≥w</p>';
        }
        
        async function addHero() {
            const name = document.getElementById('new-hero-name').value.trim();
            const race = document.getElementById('new-hero-race').value;
            
            if (!name) { showToast('Podaj nazwƒô bohatera!', true); return; }
            if (heroes.some(h => h.name.toLowerCase() === name.toLowerCase())) {
                showToast('Bohater ju≈º istnieje!', true); return;
            }
            
            try {
                const newHero = { name, race };
                await heroesRef.child(name).set(newHero);
                document.getElementById('new-hero-name').value = '';
                showToast(`Dodano bohatera: ${name}`);
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        async function deleteHero(name) {
            if (!confirm(`UsunƒÖƒá bohatera "${name}"?`)) return;
            
            try {
                await heroesRef.child(name).remove();
                showToast(`Usuniƒôto: ${name}`);
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        // ========== ZARZƒÑDZANIE PETAMI ==========
        
        function renderPetsList() {
            const container = document.getElementById('pets-list');
            document.getElementById('pets-count').textContent = pets.length;
            
            container.innerHTML = pets.map(pet => `
                <div class="entity-item">
                    <span class="entity-name">üêæ ${pet}</span>
                    <button class="btn btn-danger btn-small" onclick="deletePet('${pet}')">üóëÔ∏è</button>
                </div>
            `).join('') || '<p style="color:var(--text-muted);text-align:center;">Brak pet√≥w</p>';
        }
        
        async function addPet() {
            const name = document.getElementById('new-pet-name').value.trim();
            
            if (!name) { showToast('Podaj nazwƒô peta!', true); return; }
            if (pets.some(p => p.toLowerCase() === name.toLowerCase())) {
                showToast('Pet ju≈º istnieje!', true); return;
            }
            
            try {
                await petsRef.child(name).set({ name });
                document.getElementById('new-pet-name').value = '';
                showToast(`Dodano peta: ${name}`);
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        async function deletePet(name) {
            if (!confirm(`UsunƒÖƒá peta "${name}"?`)) return;
            
            try {
                await petsRef.child(name).remove();
                showToast(`Usuniƒôto: ${name}`);
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        // ========== UI HELPERS ==========
        
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function setOnlineStatus(online) {
            isOnline = online;
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const info = document.getElementById('connection-info');
            
            if (online) {
                dot.className = 'status-dot online';
                text.textContent = 'Online';
                if (info) info.innerHTML = '<strong>üü¢ Online:</strong> Po≈ÇƒÖczono z bazƒÖ danych.';
            } else {
                dot.className = 'status-dot offline';
                text.textContent = 'Offline';
                if (info) info.innerHTML = '<strong>üî¥ Offline:</strong> Brak po≈ÇƒÖczenia z bazƒÖ.';
            }
        }
        
        function updateUI() {
            document.getElementById('total-count').textContent = allFormations.length;
            
            const baseCount = allFormations.filter(f => f.isBase).length;
            const userCount = allFormations.filter(f => !f.isBase).length;
            
            document.getElementById('db-stat-total').textContent = allFormations.length;
            document.getElementById('db-stat-base').textContent = baseCount;
            document.getElementById('db-stat-user').textContent = userCount;
            
            filterDatabase();
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const navBtn = document.querySelector(`.nav-btn[onclick="switchTab('${tabName}')"]`);
            if (navBtn) navBtn.classList.add('active');
            
            const tab = document.getElementById(`tab-${tabName}`);
            if (tab) tab.classList.add('active');
        }
        
        // ========== AUTOUZUPE≈ÅNIANIE ==========
        
        function setupAutocomplete() {
            document.querySelectorAll('input[data-type]').forEach(input => {
                const listId = 'list-' + input.id;
                const list = document.getElementById(listId);
                if (!list) return;
                
                const type = input.dataset.type;
                
                input.addEventListener('input', () => {
                    const val = input.value.toLowerCase();
                    if (val.length < 1) { list.classList.remove('show'); return; }
                    
                    let items = type === 'pet' ? pets : heroes;
                    let filtered = type === 'pet' 
                        ? items.filter(p => p.toLowerCase().includes(val)).slice(0, 6)
                        : items.filter(h => h.name.toLowerCase().includes(val)).slice(0, 6);
                    
                    if (filtered.length === 0) { list.classList.remove('show'); return; }
                    
                    list.innerHTML = filtered.map(item => {
                        if (type === 'pet') {
                            return `<div class="autocomplete-item" data-value="${item}">${item}</div>`;
                        } else {
                            return `<div class="autocomplete-item" data-value="${item.name}">${item.name} <span class="race">(${item.race})</span></div>`;
                        }
                    }).join('');
                    
                    list.classList.add('show');
                    list.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', () => {
                            input.value = item.dataset.value;
                            list.classList.remove('show');
                        });
                    });
                });
                
                input.addEventListener('blur', () => setTimeout(() => list.classList.remove('show'), 200));
            });
        }
        
        // ========== WYSZUKIWANIE ==========
        
        function normalize(str) { return (str || '').trim().toLowerCase(); }
        
        function searchFormations() {
            const searchHeroes = [];
            for (let i = 1; i <= 5; i++) {
                const val = document.getElementById(`search-pos${i}`).value.trim();
                if (val) searchHeroes.push(normalize(val));
            }
            const searchPet = normalize(document.getElementById('search-pet').value);
            
            if (searchHeroes.length === 0 && !searchPet) {
                showToast('Wpisz przynajmniej jednƒÖ postaƒá!', true);
                return;
            }
            
            const results = [];
            
            allFormations.forEach(formation => {
                const enemyHeroes = formation.enemy.filter(h => h).map(h => normalize(h));
                const enemyPet = normalize(formation.enemyPet);
                
                let matchedHeroes = [];
                searchHeroes.forEach(sh => {
                    if (enemyHeroes.some(eh => eh.includes(sh) || sh.includes(eh))) {
                        matchedHeroes.push(sh);
                    }
                });
                
                let petMatched = searchPet && (enemyPet.includes(searchPet) || searchPet.includes(enemyPet));
                
                const totalSearched = searchHeroes.length + (searchPet ? 1 : 0);
                const totalMatched = matchedHeroes.length + (petMatched ? 1 : 0);
                
                if (totalMatched > 0) {
                    results.push({ formation, matchedHeroes, petMatched, score: totalMatched, maxScore: totalSearched });
                }
            });
            
            results.sort((a, b) => b.score - a.score);
            displayResults(results);
        }
        
        function displayResults(results) {
            const container = document.getElementById('results-section');
            
            if (results.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Nie znaleziono pasujƒÖcych formacji</p></div>`;
                return;
            }
            
            let html = `<div class="results-header"><h3>Wyniki</h3><span class="results-count">Znaleziono: ${results.length}</span></div>`;
            
            results.forEach(result => {
                const f = result.formation;
                const enemyDisplay = f.enemy.filter(h => h).map(h => {
                    const isMatched = result.matchedHeroes.some(mh => normalize(h).includes(mh) || mh.includes(normalize(h)));
                    return isMatched ? `<span class="matched-hero">${h}</span>` : h;
                }).join(', ');
                
                const petDisplay = result.petMatched ? `<span class="matched-hero">${f.enemyPet}</span>` : (f.enemyPet || '‚Äî');
                const matchClass = `match-${Math.min(result.score, 6)}`;
                const badge = f.isBase ? '' : '<span class="badge user-badge">DODANA</span>';
                
                html += `
                    <div class="result-card" onclick="showFormation(${f.id})">
                        <div class="result-card-header">
                            <span class="result-id">ID: ${f.id} ${badge}</span>
                            <span class="match-score ${matchClass}">${result.score}/${result.maxScore}</span>
                        </div>
                        <div class="result-name">${f.name}</div>
                        <div class="result-heroes">Przeciwnik: ${enemyDisplay} + ${petDisplay}</div>
                    </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function clearSearch() {
            for (let i = 1; i <= 5; i++) document.getElementById(`search-pos${i}`).value = '';
            document.getElementById('search-pet').value = '';
            document.getElementById('results-section').innerHTML = `<div class="empty-state"><p>Wpisz postacie przeciwnika i kliknij "Szukaj"</p></div>`;
        }
        
        // ========== BAZA DANYCH ==========
        
        let currentDbFilter = 'all';
        
        function setDbFilter(filter) {
            currentDbFilter = filter;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterDatabase();
        }
        
        function filterDatabase() {
            const searchTerm = normalize(document.getElementById('db-search')?.value || '');
            let formations = allFormations;
            
            if (currentDbFilter === 'base') formations = formations.filter(f => f.isBase);
            else if (currentDbFilter === 'user') formations = formations.filter(f => !f.isBase);
            
            if (searchTerm) formations = formations.filter(f => normalize(f.name).includes(searchTerm));
            
            renderDatabaseList(formations);
        }
        
        function renderDatabaseList(formations) {
            const container = document.getElementById('database-list');
            
            if (formations.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Brak formacji</p></div>`;
                return;
            }
            
            container.innerHTML = formations.map(f => {
                const myHeroes = f.my.filter(h => h).join(', ') || '‚Äî';
                const enemyHeroes = f.enemy.filter(h => h).join(', ') || '‚Äî';
                const badge = f.isBase ? '<span class="badge base-badge">BAZA</span>' : '<span class="badge user-badge">DODANA</span>';
                
                // Admin mo≈ºe usuwaƒá wszystko, zwyk≈Çy user tylko dodane
                const canDelete = isAdmin || !f.isBase;
                const deleteBtn = canDelete ? `<button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteFormation(${f.id})">üóëÔ∏è</button>` : '';
                
                return `
                    <div class="db-item" onclick="showFormation(${f.id})">
                        <div class="db-item-info">
                            <div class="db-item-header"><span class="db-item-id">#${f.id}</span>${badge}</div>
                            <div class="db-item-name">${f.name}</div>
                            <div class="db-item-details">
                                <div>‚öîÔ∏è ${myHeroes} + ${f.myPet || '‚Äî'}</div>
                                <div>üëπ ${enemyHeroes} + ${f.enemyPet || '‚Äî'}</div>
                            </div>
                        </div>
                        <div class="db-item-actions">
                            <button class="btn btn-small" onclick="event.stopPropagation(); showFormation(${f.id})">üëÅÔ∏è</button>
                            ${deleteBtn}
                        </div>
                    </div>`;
            }).join('');
        }
        
        // ========== PODGLƒÑD ==========
        
        function lookupById() {
            const id = parseInt(document.getElementById('lookup-id').value);
            if (!id) { showToast('Wpisz numer ID!', true); return; }
            showFormation(id);
        }
        
        function showFormation(id) {
            const formation = allFormations.find(f => f.id === id);
            
            if (!formation) {
                document.getElementById('formation-display').innerHTML = `<div class="empty-state"><p>Nie znaleziono formacji #${id}</p></div>`;
                return;
            }
            
            switchTab('view');
            document.getElementById('lookup-id').value = id;
            
            const badge = formation.isBase ? '<span class="badge base-badge">BAZA</span>' : '<span class="badge user-badge">DODANA</span>';
            
            document.getElementById('formation-display').innerHTML = `
                <div class="formation-view my-formation">
                    <div class="formation-title">‚öîÔ∏è TW√ìJ SK≈ÅAD (ID: ${formation.id}) ${badge}</div>
                    ${renderFormationGrid(formation.my, formation.myPet)}
                </div>
                <div class="vs-divider">‚Äî VS ‚Äî</div>
                <div class="formation-view enemy-formation">
                    <div class="formation-title">üëπ PRZECIWNIK</div>
                    ${renderFormationGrid(formation.enemy, formation.enemyPet)}
                </div>
                <div style="text-align: center; margin-top: 15px; color: var(--text-muted); font-size: 0.8rem;">${formation.name}</div>`;
        }
        
        function renderFormationGrid(heroes, pet) {
            const slot = (i) => {
                const hero = heroes[i] || '';
                return `<div class="hero-slot ${hero ? 'filled' : ''}">${hero || '‚Äî'}</div>`;
            };
            const petSlot = pet ? `<div class="pet-slot filled">üêæ ${pet}</div>` : `<div class="pet-slot">üêæ ‚Äî</div>`;
            
            return `
                <div class="formation-grid">
                    <div class="formation-row">${slot(0)}${slot(1)}${slot(2)}</div>
                    <div class="formation-row">${slot(3)}${slot(4)}</div>
                    <div class="formation-row">${slot(5)}${slot(6)}${slot(7)}</div>
                    ${petSlot}
                </div>`;
        }
        
        // ========== DODAWANIE ==========
        
        async function saveFormation() {
            if (!isOnline) { showToast('Brak po≈ÇƒÖczenia z bazƒÖ!', true); return; }
            
            const name = document.getElementById('add-name').value.trim();
            if (!name) { showToast('Podaj nazwƒô formacji!', true); return; }
            
            const my = [], enemy = [];
            for (let i = 1; i <= 8; i++) {
                my.push(document.getElementById(`add-my${i}`).value.trim());
                enemy.push(document.getElementById(`add-enemy${i}`).value.trim());
            }
            
            const myPet = document.getElementById('add-myPet').value.trim();
            const enemyPet = document.getElementById('add-enemyPet').value.trim();
            
            if (my.filter(h => h).length === 0 && enemy.filter(h => h).length === 0) {
                showToast('Dodaj przynajmniej jednƒÖ postaƒá!', true);
                return;
            }
            
            const newId = allFormations.length > 0 ? Math.max(...allFormations.map(f => f.id)) + 1 : 1;
            
            const formation = {
                id: newId,
                name,
                my,
                myPet,
                enemy,
                enemyPet,
                isBase: false,
                dateAdded: new Date().toISOString()
            };
            
            try {
                await formationsRef.child(newId).set(formation);
                showToast(`Zapisano formacjƒô #${newId}!`);
                clearAddForm();
            } catch (error) {
                showToast('B≈ÇƒÖd zapisu: ' + error.message, true);
            }
        }
        
        function clearAddForm() {
            document.getElementById('add-name').value = '';
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`add-my${i}`).value = '';
                document.getElementById(`add-enemy${i}`).value = '';
            }
            document.getElementById('add-myPet').value = '';
            document.getElementById('add-enemyPet').value = '';
        }
        
        async function deleteFormation(id) {
            const formation = allFormations.find(f => f.id === id);
            
            if (!formation) return;
            
            if (formation.isBase && !isAdmin) {
                showToast('Nie mo≈ºesz usunƒÖƒá formacji bazowej!', true);
                return;
            }
            
            if (!confirm(`UsunƒÖƒá formacjƒô #${id}: "${formation.name}"?`)) return;
            
            try {
                await formationsRef.child(id).remove();
                showToast('Formacja usuniƒôta!');
            } catch (error) {
                showToast('B≈ÇƒÖd usuwania: ' + error.message, true);
            }
        }
        
        async function deleteAllUserFormations() {
            if (!confirm('Na pewno usunƒÖƒá WSZYSTKIE formacje dodane przez u≈ºytkownik√≥w?')) return;
            
            try {
                const userFormations = allFormations.filter(f => !f.isBase);
                for (const f of userFormations) {
                    await formationsRef.child(f.id).remove();
                }
                showToast(`Usuniƒôto ${userFormations.length} formacji u≈ºytkownik√≥w`);
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        // ========== IMPORT / EKSPORT CSV (KOMPATYBILNY FORMAT) ==========
        
        function exportToCSV() {
            // Format identyczny z poprzednim
            const headers = ['Lp','Nazwa','moja1','moja2','moja3','moja4','moja5','moja6','moja7','moja8','mojPet','enemy1','enemy2','enemy3','enemy4','enemy5','enemy6','enemy7','enemy8','enemyPet'];
            
            const rows = allFormations.map(f => [
                f.id,
                `"${f.name || ''}"`,
                ...f.my.map(h => `"${h || ''}"`),
                `"${f.myPet || ''}"`,
                ...f.enemy.map(h => `"${h || ''}"`),
                `"${f.enemyPet || ''}"`
            ].join(';'));
            
            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TABELA_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`Wyeksportowano ${allFormations.length} formacji`);
        }
        
        async function importFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!isOnline) { showToast('Brak po≈ÇƒÖczenia z bazƒÖ!', true); return; }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    
                    // Wykryj separator (≈õrednik lub przecinek)
                    const separator = lines[0].includes(';') ? ';' : ',';
                    
                    let imported = 0;
                    let maxId = allFormations.length > 0 ? Math.max(...allFormations.map(f => f.id)) : 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i], separator);
                        if (values.length < 20) continue;
                        
                        // Obs≈Çuga starego i nowego formatu
                        const startIdx = values[0].match(/^\d+$/) ? 1 : 0; // Czy pierwsza kolumna to ID?
                        
                        maxId++;
                        const formation = {
                            id: maxId,
                            name: cleanValue(values[startIdx]),
                            my: [
                                cleanValue(values[startIdx + 1]),
                                cleanValue(values[startIdx + 2]),
                                cleanValue(values[startIdx + 3]),
                                cleanValue(values[startIdx + 4]),
                                cleanValue(values[startIdx + 5]),
                                cleanValue(values[startIdx + 6]),
                                cleanValue(values[startIdx + 7]),
                                cleanValue(values[startIdx + 8])
                            ],
                            myPet: cleanValue(values[startIdx + 9]),
                            enemy: [
                                cleanValue(values[startIdx + 10]),
                                cleanValue(values[startIdx + 11]),
                                cleanValue(values[startIdx + 12]),
                                cleanValue(values[startIdx + 13]),
                                cleanValue(values[startIdx + 14]),
                                cleanValue(values[startIdx + 15]),
                                cleanValue(values[startIdx + 16]),
                                cleanValue(values[startIdx + 17])
                            ],
                            enemyPet: cleanValue(values[startIdx + 18]),
                            isBase: false,
                            dateAdded: new Date().toISOString()
                        };
                        
                        await formationsRef.child(formation.id).set(formation);
                        imported++;
                    }
                    
                    showToast(`Zaimportowano ${imported} formacji!`);
                } catch (error) {
                    showToast('B≈ÇƒÖd importu: ' + error.message, true);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function parseCSVLine(line, separator = ';') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        function cleanValue(val) {
            return (val || '').replace(/"/g, '').trim();
        }
        
        function refreshData() {
            location.reload();
        }
        
        // ========== INICJALIZACJA BAZY ==========
        
        async function initializeBaseData() {
            if (!isOnline) { showToast('Brak po≈ÇƒÖczenia!', true); return; }
            if (!confirm('Za≈Çadowaƒá 126 bazowych formacji?')) return;
            
            showToast('≈Åadowanie bazy... To mo≈ºe chwilƒô potrwaƒá.');
            
            // Pe≈Çna lista bazowych formacji
            const baseFormations = [
                {id:1,name:"Tobi 18-10-2025 W1",my:["Lupico","","","Richelle","Leovalt","Paopao","Solina",""],myPet:"Silbren",enemy:["Taros","","","","Solina","Roze","Nebula","Lena"],enemyPet:"Romanelle",isBase:true},
                {id:2,name:"Tobi 18-10-2025 W2",my:["","","Nox","Dmitri","","Roze","Scarlet","Muerte"],myPet:"Hamm",enemy:["Paopao","","","Elara","Benzel","Lupico","Ulion",""],enemyPet:"Silbren",isBase:true},
                {id:3,name:"Tobi 18-10-2025 W3",my:["","Nuel","","LuLu","Elara","","Akmon","Oneric"],myPet:"Banavi",enemy:["Nuel","","","Richelle","Lilith","Leovalt","Scarlet",""],enemyPet:"Mystet",isBase:true},
                // ... dodaj resztƒô formacji z pliku CSV lub wcze≈õniejszego kodu
            ];
            
            try {
                // Pobierz formacje z pliku CSV kt√≥ry ju≈º masz
                showToast('U≈ºyj przycisku "Importuj CSV" i wczytaj plik souls_baza_startowa.csv');
            } catch (error) {
                showToast('B≈ÇƒÖd: ' + error.message, true);
            }
        }
        
        // ========== INIT ==========
        
        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            checkAdminSession();
            
            // Enter w ha≈õle
            document.getElementById('admin-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') tryAdminLogin();
            });
        });
    </script>
</body>
</html>

