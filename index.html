<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souls Online - Wyszukiwarka kontr-formacji na wojnach</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nunito:wght@400;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-dark: #0d0d0d;
            --bg-card: #1a1a1a;
            --bg-input: #252525;
            --accent-gold: #d4af37;
            --accent-red: #8b0000;
            --accent-green: #2e7d32;
            --accent-purple: #6a1b9a;
            --accent-blue: #1e3a5f;
            --text-light: #e8e8e8;
            --text-muted: #888;
            --border: #333;
			
		    --race-dark: #9c27b0;
		    --race-light: #ffd54f;
		    --race-undead: #78909c;
		    --race-elf: #66bb6a;
		    --race-fire: #e53935;
		    --race-human: #42a5f5;
        }

		.hero-dark { color: var(--race-dark); }
		.hero-light { color: var(--race-light); }
		.hero-undead { color: var(--race-undead); }
		.hero-elf { color: var(--race-elf); }
		.hero-fire { color: var(--race-fire); }
		.hero-human { color: var(--race-human); }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
        }
        
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--accent-gold); }
        
        header {
            text-align: center;
            padding: 12px 0;
            border-bottom: 2px solid var(--accent-gold);
            margin-bottom: 15px;
        }
        
        header h1 { font-size: 1.3rem; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); cursor: pointer; }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.75rem;
        }
        
        .status-item { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: #4caf50; }
        .status-dot.offline { background: #f44336; }
        
        .admin-badge { background: var(--accent-purple); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px; }

		/* Prze≈ÇƒÖcznik jƒôzyka */
		.lang-switcher {
			display: flex;
			justify-content: center;
			gap: 8px;
			margin-top: 8px;
		}

		.lang-btn {
			background: transparent;
			border: 2px solid transparent;
			border-radius: 4px;
			cursor: pointer;
			font-size: 1.2rem;
			padding: 2px 6px;
			opacity: 0.5;
			transition: all 0.2s;
		}

		.lang-btn:hover {
			opacity: 0.8;
		}

		.lang-btn.active {
			opacity: 1;
			border-color: var(--accent-gold);
			background: rgba(212, 175, 55, 0.1);
		}
        
        /* Nawigacja */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--accent-gold);
            display: flex;
            z-index: 100;
        }
        
        .nav-btn {
            flex: 1;
            padding: 10px 5px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.65rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.3s;
        }
        
        .nav-btn span.icon { font-size: 1.2rem; }
		.nav-btn:not(.active):hover { 
		    color: var(--accent-gold); 
		}
		.nav-btn.active {
			color: var(--accent-gold);
			background: rgba(212, 175, 55, 0.1);
			border-top: 2px solid var(--accent-gold);
			margin-top: -2px;
		}
        .nav-btn.admin-only { display: none; }
        .nav-btn.admin-only.show { display: flex; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
		/* Walidacja na ≈ºywo */
		input.invalid-hero {
			border-color: #c62828 !important;
			box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.3) !important;
		}

		input.valid-hero {
			border-color: var(--accent-green) !important;
		}
		
        /* Sekcje */
        .section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        
        .section h2 {
            font-size: 0.95rem;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Inputy */
        .autocomplete-wrapper { position: relative; margin-bottom: 10px; }
        .autocomplete-wrapper label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 3px; }
        
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
		input:focus, select:focus { 
		    outline: none; 
		    border-color: var(--accent-gold); 
		    box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
		}
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        .autocomplete-list.show { display: block; }
        
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .autocomplete-item:hover { background: rgba(212, 175, 55, 0.2); }
        .autocomplete-item .race { font-size: 0.7rem; color: var(--text-muted); margin-left: 5px; }

		/* Kolorowe podpowiedzi autocomplete */
		.autocomplete-item.race-dark { color: var(--race-dark); }
		.autocomplete-item.race-light { color: var(--race-light); }
		.autocomplete-item.race-human { color: var(--race-human); }
		.autocomplete-item.race-fire { color: var(--race-fire); }
		.autocomplete-item.race-elf { color: var(--race-elf); }
		.autocomplete-item.race-undead { color: var(--race-undead); }
        
        /* Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid .full-width { grid-column: 1 / -1; }

		/* Badge z numerem i tekstem - wycentrowany */
		.label-badge {
			display: flex;
			justify-content: center;
			margin-bottom: 5px;
		}

		.label-badge span {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			background: var(--bg-dark);
			border: 1px solid var(--accent-gold);
			border-radius: 15px;
			color: var(--accent-gold);
			font-size: 0.75rem;
			padding: 4px 14px;
			letter-spacing: 0.5px;
		}

		.label-badge.pet-badge span {
			background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), transparent);
			border: 1px solid var(--accent-gold);
			border-radius: 15px;
			color: var(--accent-gold);
			padding: 3px 12px;
		}
				
        /* Przyciski */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-gold), #b8962e);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
		.btn-secondary { 
		    background: var(--bg-input); 
		    color: var(--text-light); 
		    border: 1px solid var(--border); 
		}
		.btn-secondary:hover { 
		    border-color: var(--accent-gold); 
		    color: var(--accent-gold);
		}
        .btn-success { background: linear-gradient(135deg, var(--accent-green), #1b5e20); color: white; }
        .btn-danger { background: linear-gradient(135deg, #c62828, #8b0000); color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.8rem; width: auto; margin-top: 0; }
        .btn-admin { background: linear-gradient(135deg, var(--accent-purple), #4a148c); color: white; }

		.btn-favorite-active { 
		    background: linear-gradient(135deg, #ffd700, #ffb300) !important; 
		    color: #000 !important;
		}
		
        /* Filtry */
        .filter-bar { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .filter-btn {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
		.filter-btn:not(.active):hover { 
		    border-color: var(--accent-gold); 
		    color: var(--accent-gold); 
		}
        
        .search-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 0.85rem;
        }
		
		.search-counter {
			text-align: center;
			font-size: 0.7rem;
			color: var(--text-muted);
			margin: 8px 0;
			padding: 4px 10px;
			background: var(--bg-input);
			border-radius: 10px;
			display: inline-block;
		}

		.search-counter strong {
			color: var(--accent-gold);
		}
        
        /* Wyniki */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .results-header h3 { font-size: 0.9rem; }
        .results-count { font-size: 0.8rem; color: var(--text-muted); }
        
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
			animation: fadeIn 0.3s ease;
        }

		@keyframes fadeIn {
		    from { opacity: 0; transform: translateY(10px); }
		    to { opacity: 1; transform: translateY(0); }
		}
        
		.result-card:hover { 
		    border-color: var(--accent-gold); 
		    transform: translateX(5px);
		    box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
		}
        
        .result-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .result-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
        
        .match-score { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .match-6, .match-5 { background: #2e7d32; }
        .match-4 { background: #f9a825; color: #000; }
        .match-3 { background: #ef6c00; }
        .match-2 { background: #c62828; }
		.match-1 { background: #757575; }
        
        .result-name { font-size: 0.9rem; margin-bottom: 5px; }
        .result-heroes { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }
		.matched-hero { 
		    color: #4caf50; 
		    font-weight: 600;
		    background: rgba(76, 175, 80, 0.15);
		    padding: 1px 4px;
		    border-radius: 3px;
		}
		
		.result-missing { 
		    font-size: 0.7rem; 
		    color: #ef5350; 
		    margin-top: 5px;
		    padding-top: 5px;
		    border-top: 1px dashed var(--border);
		}
		
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: 5px; }
        .user-badge { background: var(--accent-purple); color: white; }
        .base-badge { background: var(--accent-blue); color: white; }
		
		/* Quick Tags - sekcje ras (zwijane) */
		.quick-tags-container {
			margin-bottom: 15px;
		}

		.quick-tags-section {
			margin-bottom: 2px;
		}

		.quick-tags-header {
			font-size: 0.65rem;
			color: var(--text-muted);
			padding: 2px 6px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 6px;
			background: var(--bg-input);
			border-radius: 4px;
			transition: all 0.2s;
			user-select: none;
		}

		.quick-tags-header:hover {
			background: var(--bg-card);
			color: var(--accent-gold);
		}

		.quick-tags-header .toggle-icon {
			font-size: 0.6rem;
			transition: transform 0.2s;
		}

		.quick-tags-header.expanded .toggle-icon {
			transform: rotate(90deg);
		}

		.quick-tags-content {
			display: none;
			padding: 2px 0 1px 0;
		}

		.quick-tags-content.show {
			display: block;
		}

		.quick-tags {
			display: flex;
			flex-wrap: wrap;
			gap: 3px;
			justify-content: center;
		}

		.quick-tag {
			padding: 2px 8px;
			background: var(--bg-input);
			border: 1px solid var(--border);
			border-radius: 12px;
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.2s;
		}

		.quick-tag:hover {
			transform: scale(1.05);
		}

		.quick-tag.tag-dark { border-color: var(--race-dark); color: var(--race-dark); }
		.quick-tag.tag-light { border-color: var(--race-light); color: var(--race-light); }
		.quick-tag.tag-human { border-color: var(--race-human); color: var(--race-human); }
		.quick-tag.tag-fire { border-color: var(--race-fire); color: var(--race-fire); }
		.quick-tag.tag-elf { border-color: var(--race-elf); color: var(--race-elf); }
		.quick-tag.tag-undead { border-color: var(--race-undead); color: var(--race-undead); }
		.quick-tag.tag-pet { border-color: var(--accent-gold); color: var(--accent-gold); }

		.quick-tag.tag-dark:hover { background: var(--race-dark); color: white; }
		.quick-tag.tag-light:hover { background: var(--race-light); color: #000; }
		.quick-tag.tag-human:hover { background: var(--race-human); color: white; }
		.quick-tag.tag-fire:hover { background: var(--race-fire); color: white; }
		.quick-tag.tag-elf:hover { background: var(--race-elf); color: white; }
		.quick-tag.tag-undead:hover { background: var(--race-undead); color: white; }
		.quick-tag.tag-pet:hover { background: var(--accent-gold); color: #000; }

		/* Quick Tags - wszystkie rozwiniƒôte naraz */
		.quick-tags-expand-all {
			text-align: center;
			margin-bottom: 6px;
		}

		.expand-all-btn {
			font-size: 0.7rem;
			color: var(--text-muted);
			background: none;
			border: 1px dashed var(--border);
			padding: 3px 12px;
			border-radius: 10px;
			cursor: pointer;
			transition: all 0.2s;
		}

		.expand-all-btn:hover {
			border-color: var(--accent-gold);
			color: var(--accent-gold);
		}

		/* Modal szybkiego wyboru dla Dodaj */
		.quick-select-modal {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0,0,0,0.9);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 500;
			padding: 15px;
			opacity: 1;
			transition: opacity 0.2s;
		}

		.quick-select-modal.hidden {
			opacity: 0;
			pointer-events: none;
		}

		.quick-select-content {
			background: var(--bg-card);
			border-radius: 12px;
			padding: 15px;
			max-width: 95%;
			max-height: 80vh;
			overflow-y: auto;
			border: 2px solid var(--accent-gold);
			width: 400px;
			transform: scale(1);
			transition: transform 0.2s;
		}
		
		@media (max-width: 420px) {
			.quick-select-content {
				width: 100%;
				padding: 12px;
				max-height: 85vh;
			}
			
			.quick-select-header h3 {
				font-size: 0.85rem;
			}
		}

		.quick-select-modal.hidden .quick-select-content {
			transform: scale(0.95);
		}

		.quick-select-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px solid var(--border);
		}

		.quick-select-header h3 {
			font-size: 0.9rem;
			color: var(--accent-gold);
		}

		.quick-select-close {
			background: none;
			border: none;
			color: var(--text-muted);
			font-size: 1.2rem;
			cursor: pointer;
		}

		.quick-select-close:hover {
			color: var(--accent-gold);
		}

		.quick-select-target {
			text-align: center;
			margin-bottom: 10px;
			padding: 8px;
			background: var(--bg-input);
			border-radius: 8px;
			font-size: 0.8rem;
		}

		.quick-select-target strong {
			color: var(--accent-gold);
		}
		
		.quick-pick {
			cursor: pointer;
			opacity: 0.5;
			transition: all 0.2s;
			font-size: 0.75rem;
			padding: 2px 4px;
			border-radius: 4px;
			display: inline-block;
		}

		.quick-pick:hover {
			opacity: 1;
			background: rgba(212, 175, 55, 0.2);
			transform: scale(1.1);
		}
		
		.quick-tag.selected {
			background: var(--accent-gold) !important;
			color: #000 !important;
			border-color: var(--accent-gold) !important;
		}
		
		/* Quick Tags w formularzu dodawania */
		.add-form-tags {
			margin-bottom: 20px;
			padding: 10px;
			background: var(--bg-input);
			border-radius: 10px;
			border: 1px solid var(--border);
		}

		.add-tags-title {
			text-align: center;
			font-size: 0.75rem;
			color: var(--text-muted);
			margin-bottom: 10px;
			padding-bottom: 8px;
			border-bottom: 1px dashed var(--border);
		}

		.active-field-indicator {
			text-align: center;
			font-size: 0.7rem;
			color: var(--accent-gold);
			margin-bottom: 8px;
			padding: 4px 10px;
			background: rgba(212, 175, 55, 0.1);
			border-radius: 8px;
			display: none;
		}

		.active-field-indicator.show {
			display: block;
		}
		
		/* Quick Tags w wyszukiwarce */
		.search-form-tags {
			margin-bottom: 15px;
			padding: 10px;
			background: var(--bg-input);
			border-radius: 10px;
			border: 1px solid var(--border);
		}
		
        /* ============================================
           PODGLƒÑD FORMACJI - BATTLEFIELD REDESIGN
           ============================================ */

        /* Kontener g≈Ç√≥wny podglƒÖdu */
        .formation-preview {
            background: linear-gradient(180deg, #0a0a0a 0%, #151515 100%);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        /* Nag≈Ç√≥wek z nazwƒÖ i akcjami */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .preview-title {
            font-family: 'Cinzel', serif;
            color: var(--accent-gold);
            font-size: 0.95rem;
        }

        .preview-title .preview-id {
            background: var(--bg-input);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 8px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-actions .btn {
            padding: 10px 18px;
            font-size: 1rem;
            margin: 0;
        }

        /* Sekcja formacji - wsp√≥lne */
        .battle-section {
            border-radius: 12px;
            padding: 15px;
            position: relative;
            margin-bottom: 0;
        }

        /* Sekcja przeciwnika - delikatne czerwonawe t≈Ço */
        .battle-section.enemy {
            background: rgba(139, 0, 0, 0.06);
            border: 1px solid rgba(139, 0, 0, 0.2);
        }

        .battle-section.enemy::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #8b0000, transparent);
        }

        /* Sekcja gracza - delikatne zielonkawe t≈Ço */
        .battle-section.player {
            background: rgba(46, 125, 50, 0.06);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }

        .battle-section.player::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #2e7d32, transparent);
        }

        /* Tytu≈Ç sekcji - WIƒòKSZY */
        .battle-title {
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 2px;
        }

        .battle-title.enemy-title {
            color: #f44336;
        }

        .battle-title.player-title {
            color: #4caf50;
        }

        .battle-title .title-icon {
            font-size: 1.3rem;
        }

        /* Grid formacji */
        .battle-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .battle-row {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* Slot bohatera - nowy design */
        .battle-slot {
            width: 75px;
            height: 42px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            text-align: center;
            padding: 4px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Pusty slot */
        .battle-slot.empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.15);
        }

        .battle-slot.empty::after {
            content: '‚Äî';
            font-size: 1rem;
            opacity: 0.3;
        }

        /* Wype≈Çniony slot - bazowy */
        .battle-slot.filled {
            background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
            border: 2px solid;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .battle-slot.filled:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* Kolory ras dla slot√≥w */
        .battle-slot.race-dark {
            border-color: var(--race-dark);
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.2), inset 0 0 20px rgba(156, 39, 176, 0.1);
        }
        .battle-slot.race-dark .hero-name { color: var(--race-dark); }

        .battle-slot.race-light {
            border-color: var(--race-light);
            box-shadow: 0 2px 8px rgba(255, 213, 79, 0.2), inset 0 0 20px rgba(255, 213, 79, 0.1);
        }
        .battle-slot.race-light .hero-name { color: var(--race-light); }

        .battle-slot.race-human {
            border-color: var(--race-human);
            box-shadow: 0 2px 8px rgba(66, 165, 245, 0.2), inset 0 0 20px rgba(66, 165, 245, 0.1);
        }
        .battle-slot.race-human .hero-name { color: var(--race-human); }

        .battle-slot.race-fire {
            border-color: var(--race-fire);
            box-shadow: 0 2px 8px rgba(229, 57, 53, 0.2), inset 0 0 20px rgba(229, 57, 53, 0.1);
        }
        .battle-slot.race-fire .hero-name { color: var(--race-fire); }

        .battle-slot.race-elf {
            border-color: var(--race-elf);
            box-shadow: 0 2px 8px rgba(102, 187, 106, 0.2), inset 0 0 20px rgba(102, 187, 106, 0.1);
        }
        .battle-slot.race-elf .hero-name { color: var(--race-elf); }

        .battle-slot.race-undead {
            border-color: var(--race-undead);
            box-shadow: 0 2px 8px rgba(120, 144, 156, 0.2), inset 0 0 20px rgba(120, 144, 156, 0.1);
        }
        .battle-slot.race-undead .hero-name { color: var(--race-undead); }

        /* Slot peta - mniejszy */
        .battle-pet {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin: 8px 0;
            transition: all 0.3s ease;
        }

        .battle-pet.empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
        }

        .battle-pet.filled {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            font-weight: 600;
        }

        .battle-pet .pet-icon {
            font-size: 1rem;
        }

        /* Strza≈Çki kierunku ataku */
        .battle-arrows {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 0;
            gap: 15px;
        }

        .battle-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
        }

        .battle-arrow.down {
            border-top: 12px solid rgba(244, 67, 54, 0.6);
        }

        .battle-arrow.up {
            border-bottom: 12px solid rgba(76, 175, 80, 0.6);
        }

        /* Animacja strza≈Çek */
        @keyframes arrowPulse {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(3px); }
        }

        @keyframes arrowPulseUp {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-3px); }
        }

        .battle-arrows.animated .battle-arrow.down {
            animation: arrowPulse 1.5s ease-in-out infinite;
        }

        .battle-arrows.animated .battle-arrow.up {
            animation: arrowPulseUp 1.5s ease-in-out infinite;
        }

        /* Separator VS - mniejszy */
        .vs-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
            position: relative;
        }

        .vs-separator::before,
        .vs-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
        }

        .vs-badge {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-gold);
            padding: 5px 15px;
            background: radial-gradient(ellipse at center, rgba(212, 175, 55, 0.15) 0%, transparent 70%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            margin: 0 15px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            position: relative;
        }

        .vs-badge::before {
            content: '‚öîÔ∏è';
            position: absolute;
            left: -18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
        }

        .vs-badge::after {
            content: '‚öîÔ∏è';
            position: absolute;
            right: -18px;
            top: 50%;
            transform: translateY(-50%) scaleX(-1);
            font-size: 0.75rem;
        }

        /* Komentarz */
        .preview-comment {
            margin-top: 15px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.02));
            border-radius: 10px;
            border-left: 3px solid var(--accent-gold);
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .preview-comment .comment-icon {
            color: var(--accent-gold);
            margin-right: 8px;
        }

        /* Badge typu formacji */
        .formation-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .formation-type-badge.base {
            background: rgba(30, 58, 95, 0.5);
            color: #64b5f6;
            border: 1px solid rgba(100, 181, 246, 0.3);
        }

        .formation-type-badge.user {
            background: rgba(106, 27, 154, 0.3);
            color: #ce93d8;
            border: 1px solid rgba(206, 147, 216, 0.3);
        }

        /* Responsywno≈õƒá dla podglƒÖdu */
        @media (max-width: 400px) {
            .battle-slot {
                width: 62px;
                height: 38px;
                font-size: 0.6rem;
            }
            
            .battle-row {
                gap: 5px;
            }
            
            .preview-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-title {
                font-size: 0.85rem;
            }

            .battle-title {
                font-size: 0.95rem;
            }
        }
        
        /* ID Lookup */
        .id-lookup { display: flex; gap: 10px; margin-bottom: 15px; }
        .id-lookup input { flex: 1; }
        .id-lookup .btn { width: auto; padding: 12px 20px; margin-top: 0; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state p { font-size: 0.9rem; }
        
		/* Add form - kompaktowy layout */
		.add-form-section { 
			margin-bottom: 15px; 
		}

		.add-form-section h3 { 
			font-size: 0.8rem; 
			color: var(--text-muted); 
			margin-bottom: 8px; 
			text-transform: uppercase; 
			letter-spacing: 1px;
			padding-bottom: 5px;
			border-bottom: 1px solid var(--border);
		}

		.form-row { 
			display: flex; 
			gap: 6px; 
			margin-bottom: 6px; 
		}

		.form-row .autocomplete-wrapper { 
			flex: 1; 
			margin-bottom: 0; 
		}

		/* Desktop: 2 kolumny obok siebie */
		@media (min-width: 768px) {
			.add-formations-grid {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
			}
			
			.add-form-section {
				margin-bottom: 0;
			}
		}

		/* Mniejsze inputy w formularzu dodawania */
		#tab-add input[type="text"] {
			padding: 8px 10px;
			font-size: 0.85rem;
		}

		#tab-add .autocomplete-wrapper label {
			font-size: 0.7rem;
			margin-bottom: 2px;
		}
        
        /* Stats */
        .stats-bar { display: flex; justify-content: space-around; padding: 10px; background: var(--bg-input); border-radius: 8px; margin-bottom: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--accent-gold); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); }
        
        /* Database list */
        .database-list { max-height: 60vh; overflow-y: auto; }
        
		.db-item {
		    display: flex;
		    justify-content: space-between;
		    align-items: flex-start;
		    padding: 12px;
		    background: var(--bg-input);
		    border-radius: 8px;
		    margin-bottom: 8px;
		    cursor: pointer;
		    transition: all 0.3s;
		    border: 1px solid transparent;
		    animation: fadeIn 0.3s ease;
		}
        
		.db-item:hover { 
		    border-color: var(--accent-gold); 
		    transform: translateX(3px);
		    box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
		}
        .db-item-info { flex: 1; }
        .db-item-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .db-item-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
        .db-item-name { font-size: 0.9rem; }
        .db-item-details { font-size: 0.7rem; color: var(--text-muted); line-height: 1.4; }
        .db-item-actions { display: flex; gap: 5px; margin-left: 10px; }
        
        /* Info box */
        .info-box {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 3px solid var(--accent-gold);
        }
        
        .info-box strong { color: var(--accent-gold); }
        .info-box.success { border-left-color: var(--accent-green); }
        .info-box.error { border-left-color: #c62828; }
        .info-box.admin { border-left-color: var(--accent-purple); background: rgba(106, 27, 154, 0.1); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            max-width: 90%;
        }
        
        .toast.show { opacity: 1; }
        .toast.error { background: #c62828; }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            flex-direction: column;
            gap: 15px;
        }
        
        .loading-overlay.hidden { display: none; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Admin panel */
        .admin-section { border: 2px solid var(--accent-purple); }
        .admin-section h2 { color: var(--accent-purple); }
        
        .entity-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .entity-item:last-child { border-bottom: none; }
        .entity-name { flex: 1; }
        .entity-race { font-size: 0.75rem; color: var(--text-muted); margin-left: 10px; }
        
        .add-entity-form {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .add-entity-form input, .add-entity-form select { flex: 1; }
        .add-entity-form .btn { width: auto; margin-top: 0; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 20px;
        }
        
        .modal.hidden { display: none; }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            border: 2px solid var(--accent-gold);
        }
        
        .modal-content h2 { text-align: center; margin-bottom: 20px; }
        
        /* Responsive */
        @media (max-width: 360px) {
            .form-row { flex-direction: column; }
            .nav-btn { font-size: 0.6rem; }
            .nav-btn span.icon { font-size: 1rem; }
			.search-slots-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="color: var(--accent-gold);" data-i18n="loading">≈Åadowanie danych...</div>
    </div>
    
    <!-- Admin login modal -->
    <div class="modal hidden" id="admin-modal">
        <div class="modal-content">
            <h2>üîê <span data-i18n="admin.title">Panel Administratora</span></h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.85rem;" data-i18n="admin.enterPassword">Wpisz has≈Ço administratora</p>
            <input type="password" id="admin-password" data-i18n-placeholder="admin.passwordPlaceholder" placeholder="Has≈Ço..." style="margin-bottom: 10px;">
            <button class="btn btn-admin" onclick="tryAdminLogin()" data-i18n="admin.login">ZALOGUJ</button>
            <button class="btn btn-secondary" onclick="closeAdminModal()" data-i18n="common.cancel">Anuluj</button>
        </div>
    </div>

    <header>
        <h1 onclick="headerClick()">‚öîÔ∏è SOULS ONLINE ‚öîÔ∏è</h1>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 3px;">
            <span data-i18n="header.subtitle">Wyszukiwarka kontr-formacji</span>
            <span class="admin-badge" id="admin-badge" style="display: none;">ADMIN</span>
        </p>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">≈ÅƒÖczenie...</span>
            </div>
            <div class="status-item">
                <span>üìä <span id="total-count">0</span> <span data-i18n="status.formations">formacji</span></span>
            </div>
        </div>
		<div class="lang-switcher">
			<button class="lang-btn active" onclick="setLanguage('pl')" title="Polski">üáµüá±</button>
			<button class="lang-btn" onclick="setLanguage('en')" title="English">üá¨üáß</button>
		</div>
    </header>
    
    <!-- Tab: Wyszukiwarka -->
    <div id="tab-search" class="tab-content active">
        <div class="section">
            <h2>üîç <span data-i18n="search.title">Szukaj kontr-formacji</span></h2>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;" data-i18n="search.subtitle">
                Wpisz sk≈Çad przeciwnika (lub wybierz tagami)
            </p>
			
			<div class="search-form-tags">
				<div id="quick-tags-container">
					<div style="text-align: center; color: var(--text-muted); font-size: 0.75rem;" data-i18n="common.loading">≈Åadowanie...</div>
				</div>
			</div>
            
			<div class="form-grid">
				<div class="autocomplete-wrapper">
					<div class="label-badge"><span>1 ¬∑ Hero</span></div>
					<input type="text" id="search-pos1" placeholder="np. Taros" autocomplete="off" data-type="hero">
					<div class="autocomplete-list" id="list-search-pos1"></div>
				</div>
				<div class="autocomplete-wrapper">
					<div class="label-badge"><span>2 ¬∑ Hero</span></div>
					<input type="text" id="search-pos2" placeholder="np. Solina" autocomplete="off" data-type="hero">
					<div class="autocomplete-list" id="list-search-pos2"></div>
				</div>
				<div class="autocomplete-wrapper">
					<div class="label-badge"><span>3 ¬∑ Hero</span></div>
					<input type="text" id="search-pos3" placeholder="np. Roze" autocomplete="off" data-type="hero">
					<div class="autocomplete-list" id="list-search-pos3"></div>
				</div>
				<div class="autocomplete-wrapper">
					<div class="label-badge"><span>4 ¬∑ Hero</span></div>
					<input type="text" id="search-pos4" placeholder="np. Nebula" autocomplete="off" data-type="hero">
					<div class="autocomplete-list" id="list-search-pos4"></div>
				</div>
				<div class="autocomplete-wrapper">
					<div class="label-badge"><span>5 ¬∑ Hero</span></div>
					<input type="text" id="search-pos5" placeholder="np. Lena" autocomplete="off" data-type="hero">
					<div class="autocomplete-list" id="list-search-pos5"></div>
				</div>
				<div class="autocomplete-wrapper">
					<div class="label-badge pet-badge"><span>üêæ Pet</span></div>
					<input type="text" id="search-pet" placeholder="np. Silbren" autocomplete="off" data-type="pet">
					<div class="autocomplete-list" id="list-search-pet"></div>
				</div>
			</div>
            
            <button class="btn" onclick="searchFormations()">üîç <span data-i18n="search.btn">SZUKAJ</span></button>
            <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 8px;">‚úñ <span data-i18n="search.clear">Wyczy≈õƒá</span></button>
        </div>
        
        <div id="results-section">
            <div class="empty-state">
                <p data-i18n="search.emptyState">Wpisz postacie przeciwnika i kliknij "Szukaj"</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Baza danych -->
    <div id="tab-database" class="tab-content">
        <div class="section">
            <h2>üìö <span data-i18n="database.title">Pe≈Çna baza formacji</span></h2>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-total">0</div>
                    <div class="stat-label" data-i18n="database.statsAll">Wszystkich</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-base">0</div>
                    <div class="stat-label" data-i18n="database.statsBase">Bazowych</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-user">0</div>
                    <div class="stat-label" data-i18n="database.statsUser">Dodanych</div>
                </div>
            </div>
            
            <div class="filter-bar">
                <button class="filter-btn active" data-filter="all" onclick="setDbFilter('all')" data-i18n="database.filterAll">Wszystkie</button>
                <button class="filter-btn" data-filter="base" onclick="setDbFilter('base')" data-i18n="database.filterBase">Bazowe</button>
                <button class="filter-btn" data-filter="user" onclick="setDbFilter('user')" data-i18n="database.filterUser">Dodane</button>
				<button class="filter-btn" data-filter="favorites" onclick="setDbFilter('favorites')">‚≠ê <span data-i18n="database.filterFavorites">Ulubione</span></button>
                <input type="text" class="search-input" id="db-search" data-i18n-placeholder="database.searchPlaceholder" placeholder="üîç Szukaj..." oninput="filterDatabase()">
            </div>
            
            <div id="database-list" class="database-list"></div>
        </div>
    </div>
    
    <!-- Tab: PodglƒÖd -->
    <div id="tab-view" class="tab-content">
        <div class="section">
            <h2>üëÅÔ∏è <span data-i18n="preview.title">PodglƒÖd formacji</span></h2>
            <div class="id-lookup">
                <input type="number" id="lookup-id" data-i18n-placeholder="preview.idPlaceholder" placeholder="Wpisz ID (np. 12)">
                <button class="btn" onclick="lookupById()" data-i18n="preview.showBtn">POKA≈ª</button>
            </div>
        </div>
        
        <div id="formation-display">
            <div class="empty-state">
                <p data-i18n="preview.emptyState">Wpisz ID aby zobaczyƒá uk≈Çad formacji</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Dodaj -->
    <div id="tab-add" class="tab-content">
        <div class="section">
            <h2>‚ûï <span data-i18n="add.title">Dodaj nowƒÖ formacjƒô</span></h2>
            
			<!-- Quick Tags dla formularza dodawania -->
			<div class="add-form-tags">
				<div class="active-field-indicator" id="active-field-indicator">
					<span data-i18n="quickSelect.selectFor">Wybierz dla</span>: <strong id="active-field-name">‚Äî</strong>
				</div>
				<div id="add-form-tags-container"></div>
			</div>
			
            <div class="autocomplete-wrapper full-width" style="margin-bottom: 15px;">
                <label data-i18n="add.nameLabel">Nazwa formacji</label>
                <input type="text" id="add-name" data-i18n-placeholder="add.namePlaceholder" placeholder="np. Nick 01-01-2025 W1">
            </div>
            
		<div class="add-formations-grid">	
			<div class="add-form-section">
				<h3>‚öîÔ∏è <span data-i18n="add.yourTeam">Tw√≥j sk≈Çad</span></h3>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 1 <span class="quick-pick" onclick="openQuickSelect('add-my1', 'Tw√≥j Poz 1')">üè∑Ô∏è</span></label><input type="text" id="add-my1" data-type="hero"><div class="autocomplete-list" id="list-add-my1"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 2 <span class="quick-pick" onclick="openQuickSelect('add-my2', 'Tw√≥j Poz 2')">üè∑Ô∏è</span></label><input type="text" id="add-my2" data-type="hero"><div class="autocomplete-list" id="list-add-my2"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 3 <span class="quick-pick" onclick="openQuickSelect('add-my3', 'Tw√≥j Poz 3')">üè∑Ô∏è</span></label><input type="text" id="add-my3" data-type="hero"><div class="autocomplete-list" id="list-add-my3"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 4 <span class="quick-pick" onclick="openQuickSelect('add-my4', 'Tw√≥j Poz 4')">üè∑Ô∏è</span></label><input type="text" id="add-my4" data-type="hero"><div class="autocomplete-list" id="list-add-my4"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 5 <span class="quick-pick" onclick="openQuickSelect('add-my5', 'Tw√≥j Poz 5')">üè∑Ô∏è</span></label><input type="text" id="add-my5" data-type="hero"><div class="autocomplete-list" id="list-add-my5"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 6 <span class="quick-pick" onclick="openQuickSelect('add-my6', 'Tw√≥j Poz 6')">üè∑Ô∏è</span></label><input type="text" id="add-my6" data-type="hero"><div class="autocomplete-list" id="list-add-my6"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 7 <span class="quick-pick" onclick="openQuickSelect('add-my7', 'Tw√≥j Poz 7')">üè∑Ô∏è</span></label><input type="text" id="add-my7" data-type="hero"><div class="autocomplete-list" id="list-add-my7"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 8 <span class="quick-pick" onclick="openQuickSelect('add-my8', 'Tw√≥j Poz 8')">üè∑Ô∏è</span></label><input type="text" id="add-my8" data-type="hero"><div class="autocomplete-list" id="list-add-my8"></div></div>
				</div>
				<div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
					<label>Pet <span class="quick-pick" onclick="openQuickSelect('add-myPet', 'Tw√≥j Pet')">üè∑Ô∏è</span></label>
					<input type="text" id="add-myPet" data-type="pet">
					<div class="autocomplete-list" id="list-add-myPet"></div>
				</div>
			</div>
            
			<div class="add-form-section">
				<h3>üëπ <span data-i18n="add.enemyTeam">Sk≈Çad przeciwnika</span></h3>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 1 <span class="quick-pick" onclick="openQuickSelect('add-enemy1', 'Przeciwnik Poz 1')">üè∑Ô∏è</span></label><input type="text" id="add-enemy1" data-type="hero"><div class="autocomplete-list" id="list-add-enemy1"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 2 <span class="quick-pick" onclick="openQuickSelect('add-enemy2', 'Przeciwnik Poz 2')">üè∑Ô∏è</span></label><input type="text" id="add-enemy2" data-type="hero"><div class="autocomplete-list" id="list-add-enemy2"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 3 <span class="quick-pick" onclick="openQuickSelect('add-enemy3', 'Przeciwnik Poz 3')">üè∑Ô∏è</span></label><input type="text" id="add-enemy3" data-type="hero"><div class="autocomplete-list" id="list-add-enemy3"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 4 <span class="quick-pick" onclick="openQuickSelect('add-enemy4', 'Przeciwnik Poz 4')">üè∑Ô∏è</span></label><input type="text" id="add-enemy4" data-type="hero"><div class="autocomplete-list" id="list-add-enemy4"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 5 <span class="quick-pick" onclick="openQuickSelect('add-enemy5', 'Przeciwnik Poz 5')">üè∑Ô∏è</span></label><input type="text" id="add-enemy5" data-type="hero"><div class="autocomplete-list" id="list-add-enemy5"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 6 <span class="quick-pick" onclick="openQuickSelect('add-enemy6', 'Przeciwnik Poz 6')">üè∑Ô∏è</span></label><input type="text" id="add-enemy6" data-type="hero"><div class="autocomplete-list" id="list-add-enemy6"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 7 <span class="quick-pick" onclick="openQuickSelect('add-enemy7', 'Przeciwnik Poz 7')">üè∑Ô∏è</span></label><input type="text" id="add-enemy7" data-type="hero"><div class="autocomplete-list" id="list-add-enemy7"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 8 <span class="quick-pick" onclick="openQuickSelect('add-enemy8', 'Przeciwnik Poz 8')">üè∑Ô∏è</span></label><input type="text" id="add-enemy8" data-type="hero"><div class="autocomplete-list" id="list-add-enemy8"></div></div>
				</div>
				<div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
					<label>Pet <span class="quick-pick" onclick="openQuickSelect('add-enemyPet', 'Przeciwnik Pet')">üè∑Ô∏è</span></label>
					<input type="text" id="add-enemyPet" data-type="pet">
					<div class="autocomplete-list" id="list-add-enemyPet"></div>
				</div>
			</div>
		</div>
			<div class="autocomplete-wrapper full-width" style="margin-top: 15px;">
			    <label>üí¨ <span data-i18n="add.commentLabel">Komentarz (opcjonalnie)</span></label>
			    <input type="text" id="add-comment" data-i18n-placeholder="add.commentPlaceholder" placeholder="np. Unikaƒá Death, Silbren u przeciwnika... itp.">
			</div>
			
            <button class="btn btn-success" onclick="saveFormation()">üíæ <span data-i18n="add.saveBtn">ZAPISZ FORMACJƒò</span></button>
            <button class="btn btn-secondary" onclick="clearAddForm()" style="margin-top: 8px;">‚úñ <span data-i18n="common.clear">Wyczy≈õƒá</span></button>
        </div>
    </div>
    
    <!-- Tab: Ustawienia -->
    <div id="tab-settings" class="tab-content">
        <div class="section">
            <h2>‚öôÔ∏è <span data-i18n="settings.title">Import / Eksport</span></h2>
            
            <div class="info-box" id="connection-info">
                <strong>üîó <span data-i18n="settings.status">Status</span>:</strong> <span data-i18n="settings.checking">Sprawdzanie po≈ÇƒÖczenia...</span>
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 20px 0 10px;">üì§ <span data-i18n="settings.exportTitle">Eksport do CSV</span></h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;" data-i18n="settings.exportDesc">
                Pobierz wszystkie formacje jako plik CSV
            </p>
            <button class="btn" onclick="exportToCSV()">üì§ <span data-i18n="settings.exportBtn">Eksportuj CSV</span></button>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">üì• <span data-i18n="settings.importTitle">Import z CSV</span></h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;" data-i18n="settings.importDesc">
                Wczytaj formacje z pliku CSV (ten sam format co eksport)
            </p>
            <button class="btn btn-success" onclick="document.getElementById('csv-input').click()">üì• <span data-i18n="settings.importBtn">Importuj CSV</span></button>
            <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="importFromCSV(event)">
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">üîÑ <span data-i18n="settings.syncTitle">Synchronizacja</span></h3>
            <button class="btn btn-secondary" onclick="refreshData()">üîÑ <span data-i18n="settings.refreshBtn">Od≈õwie≈º dane</span></button>
        </div>
    </div>
    
    <!-- Tab: Admin (ukryty domy≈õlnie) -->
    <div id="tab-admin" class="tab-content">
        <div class="section admin-section">
            <h2>üëë <span data-i18n="admin.panelTitle">Panel Administratora</span></h2>
            
            <div class="info-box admin">
                <strong>üîê <span data-i18n="admin.modeActive">Tryb Admin aktywny</span></strong><br>
                <span data-i18n="admin.modeDesc">Mo≈ºesz zarzƒÖdzaƒá bohaterami, petami i usuwaƒá dowolne formacje.</span>
            </div>
            
            <!-- ZarzƒÖdzanie bohaterami -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 20px 0 10px;">‚öîÔ∏è <span data-i18n="admin.heroes">Bohaterowie</span> (<span id="heroes-count">0</span>)</h3>
            <div class="entity-list" id="heroes-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-hero-name" data-i18n-placeholder="admin.heroNamePlaceholder" placeholder="Nazwa bohatera">
                <select id="new-hero-race">
                    <option value="Dark">Dark</option>
                    <option value="Light">Light</option>
                    <option value="Undead">Undead</option>
                    <option value="Elf">Elf</option>
                    <option value="Fire">Fire</option>
                    <option value="Human">Human</option>
                </select>
                <button class="btn btn-success btn-small" onclick="addHero()">‚ûï</button>
            </div>
            
            <!-- ZarzƒÖdzanie petami -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üêæ <span data-i18n="admin.pets">Pety</span> (<span id="pets-count">0</span>)</h3>
            <div class="entity-list" id="pets-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-pet-name" data-i18n-placeholder="admin.petNamePlaceholder" placeholder="Nazwa peta">
                <button class="btn btn-success btn-small" onclick="addPet()">‚ûï</button>
            </div>
            
			<!-- ZarzƒÖdzanie formacjami -->
			<h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üìã <span data-i18n="admin.manageFormations">ZarzƒÖdzanie formacjami</span></h3>
			<button class="btn btn-danger" onclick="deleteAllUserFormations()">üóëÔ∏è <span data-i18n="admin.deleteAllUser">Usu≈Ñ wszystkie formacje u≈ºytkownik√≥w</span></button>
			<button class="btn btn-secondary" onclick="initializeBaseData()" style="margin-top: 8px;">üìã <span data-i18n="admin.loadBase">Za≈Çaduj bazƒô startowƒÖ (126)</span></button>
			
            <!-- Wyloguj -->
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">üö™ <span data-i18n="admin.session">Sesja</span></h3>
            <button class="btn btn-secondary" onclick="adminLogout()">üö™ <span data-i18n="admin.logout">Wyloguj z trybu Admin</span></button>
        </div>
    </div>
    
    <!-- Nawigacja -->
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('search')"><span class="icon">üîç</span><span data-i18n="nav.search">Szukaj</span></button>
        <button class="nav-btn" onclick="switchTab('database')"><span class="icon">üìö</span><span data-i18n="nav.database">Baza</span></button>
        <button class="nav-btn" onclick="switchTab('view')"><span class="icon">üëÅÔ∏è</span><span data-i18n="nav.preview">PodglƒÖd</span></button>
        <button class="nav-btn" onclick="switchTab('add')"><span class="icon">‚ûï</span><span data-i18n="nav.add">Dodaj</span></button>
		<button class="nav-btn admin-only" id="nav-settings" onclick="switchTab('settings')"><span class="icon">‚öôÔ∏è</span><span data-i18n="nav.import">Import</span></button>
        <button class="nav-btn admin-only" id="nav-admin" onclick="switchTab('admin')"><span class="icon">üëë</span><span>Admin</span></button>
    </nav>
    
    <div class="toast" id="toast"></div>

	<!-- Modal szybkiego wyboru dla Dodaj -->
	<div class="quick-select-modal hidden" id="quick-select-modal">
		<div class="quick-select-content">
			<div class="quick-select-header">
				<h3>üè∑Ô∏è <span data-i18n="quickSelect.title">Szybki wyb√≥r</span></h3>
				<button class="quick-select-close" onclick="closeQuickSelect()">‚úï</button>
			</div>
			<div class="quick-select-target" id="quick-select-target">
				<span data-i18n="quickSelect.selectFor">Wybierz dla</span>: <strong>‚Äî</strong>
			</div>
			<div id="quick-select-tags"></div>
		</div>
	</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // =====================================================
        // üåê SYSTEM T≈ÅUMACZE≈É
        // =====================================================
        
        let currentLang = localStorage.getItem('souls_lang') || 'pl';
        
        const translations = {
            pl: {
                // Loading
                'loading': '≈Åadowanie danych...',
                'common.loading': '≈Åadowanie...',
                'common.cancel': 'Anuluj',
                'common.clear': 'Wyczy≈õƒá',
                
                // Header
                'header.subtitle': 'Wyszukiwarka kontr-formacji',
                'status.connecting': '≈ÅƒÖczenie...',
                'status.online': 'Online',
                'status.offline': 'Offline',
                'status.formations': 'formacji',
                
                // Navigation
                'nav.search': 'Szukaj',
                'nav.database': 'Baza',
                'nav.preview': 'PodglƒÖd',
                'nav.add': 'Dodaj',
                'nav.import': 'Import',
                
                // Search
                'search.title': 'Szukaj kontr-formacji',
                'search.subtitle': 'Wpisz sk≈Çad przeciwnika (lub wybierz tagami)',
                'search.btn': 'SZUKAJ',
                'search.clear': 'Wyczy≈õƒá',
                'search.emptyState': 'Wpisz postacie przeciwnika i kliknij "Szukaj"',
                'search.results': 'Wyniki',
                'search.found': 'Znaleziono',
                'search.noResults': 'Nie znaleziono pasujƒÖcych formacji',
                'search.enemy': 'Przeciwnik',
                'search.missing': 'Brak',
                'search.allSlotsFull': 'Wszystkie pola zajƒôte!',
                'search.petSlotFull': 'Pole Pet ju≈º zajƒôte!',
                'search.enterAtLeastOne': 'Wpisz przynajmniej jednƒÖ postaƒá!',
                'search.selected': 'Wybrano',
                
                // Database
                'database.title': 'Pe≈Çna baza formacji',
                'database.statsAll': 'Wszystkich',
                'database.statsBase': 'Bazowych',
                'database.statsUser': 'Dodanych',
                'database.filterAll': 'Wszystkie',
                'database.filterBase': 'Bazowe',
                'database.filterUser': 'Dodane',
                'database.filterFavorites': 'Ulubione',
                'database.searchPlaceholder': 'üîç Szukaj...',
                'database.noFormations': 'Brak formacji',
                
                // Preview
                'preview.title': 'PodglƒÖd formacji',
                'preview.idPlaceholder': 'Wpisz ID (np. 12)',
                'preview.showBtn': 'POKA≈ª',
                'preview.emptyState': 'Wpisz ID aby zobaczyƒá uk≈Çad formacji',
                'preview.notFound': 'Nie znaleziono formacji',
                'preview.enemy': 'PRZECIWNIK',
                'preview.yourTeam': 'TW√ìJ SK≈ÅAD',
                'preview.noPet': 'Brak peta',
                'preview.invalidId': 'Wpisz prawid≈Çowy numer ID!',
                
                // Add
                'add.title': 'Dodaj nowƒÖ formacjƒô',
                'add.nameLabel': 'Nazwa formacji',
                'add.namePlaceholder': 'np. Nick 01-01-2025 W1',
                'add.yourTeam': 'Tw√≥j sk≈Çad',
                'add.enemyTeam': 'Sk≈Çad przeciwnika',
                'add.commentLabel': 'Komentarz (opcjonalnie)',
                'add.commentPlaceholder': 'np. Unikaƒá Death, Silbren u przeciwnika... itp.',
                'add.saveBtn': 'ZAPISZ FORMACJƒò',
                'add.enterName': 'Podaj nazwƒô formacji!',
                'add.addAtLeastOne': 'Dodaj przynajmniej jednƒÖ postaƒá!',
                'add.unknownHeroes': 'Nieznani bohaterowie',
                'add.unknownPets': 'Nieznane pety',
                'add.saved': 'Zapisano formacjƒô',
                
                // Settings
                'settings.title': 'Import / Eksport',
                'settings.status': 'Status',
                'settings.checking': 'Sprawdzanie po≈ÇƒÖczenia...',
                'settings.online': 'Po≈ÇƒÖczono z bazƒÖ danych.',
                'settings.offline': 'Brak po≈ÇƒÖczenia z bazƒÖ.',
                'settings.exportTitle': 'Eksport do CSV',
                'settings.exportDesc': 'Pobierz wszystkie formacje jako plik CSV',
                'settings.exportBtn': 'Eksportuj CSV',
                'settings.importTitle': 'Import z CSV',
                'settings.importDesc': 'Wczytaj formacje z pliku CSV (ten sam format co eksport)',
                'settings.importBtn': 'Importuj CSV',
                'settings.syncTitle': 'Synchronizacja',
                'settings.refreshBtn': 'Od≈õwie≈º dane',
                'settings.exported': 'Wyeksportowano',
                'settings.imported': 'Zaimportowano',
                
                // Admin
                'admin.title': 'Panel Administratora',
                'admin.enterPassword': 'Wpisz has≈Ço administratora',
                'admin.passwordPlaceholder': 'Has≈Ço...',
                'admin.login': 'ZALOGUJ',
                'admin.panelTitle': 'Panel Administratora',
                'admin.modeActive': 'Tryb Admin aktywny',
                'admin.modeDesc': 'Mo≈ºesz zarzƒÖdzaƒá bohaterami, petami i usuwaƒá dowolne formacje.',
                'admin.heroes': 'Bohaterowie',
                'admin.pets': 'Pety',
                'admin.heroNamePlaceholder': 'Nazwa bohatera',
                'admin.petNamePlaceholder': 'Nazwa peta',
                'admin.manageFormations': 'ZarzƒÖdzanie formacjami',
                'admin.deleteAllUser': 'Usu≈Ñ wszystkie formacje u≈ºytkownik√≥w',
                'admin.loadBase': 'Za≈Çaduj bazƒô startowƒÖ (126)',
                'admin.session': 'Sesja',
                'admin.logout': 'Wyloguj z trybu Admin',
                'admin.loggedIn': 'Zalogowano jako Administrator!',
                'admin.loggedOut': 'Wylogowano z trybu Admin',
                'admin.wrongPassword': 'Nieprawid≈Çowe has≈Ço!',
                'admin.alreadyLogged': 'Ju≈º jeste≈õ zalogowany jako Admin',
                'admin.heroAdded': 'Dodano bohatera',
                'admin.heroDeleted': 'Usuniƒôto',
                'admin.heroExists': 'Bohater ju≈º istnieje!',
                'admin.petAdded': 'Dodano peta',
                'admin.petExists': 'Pet ju≈º istnieje!',
                'admin.enterHeroName': 'Podaj nazwƒô bohatera!',
                'admin.enterPetName': 'Podaj nazwƒô peta!',
                'admin.confirmDeleteHero': 'UsunƒÖƒá bohatera',
                'admin.confirmDeletePet': 'UsunƒÖƒá peta',
                'admin.confirmDeleteAllUser': 'Na pewno usunƒÖƒá WSZYSTKIE formacje dodane przez u≈ºytkownik√≥w?',
                'admin.confirmLoadBase': 'Za≈Çadowaƒá 126 bazowych formacji?',
                'admin.deletedUserFormations': 'Usuniƒôto formacji u≈ºytkownik√≥w',
                'admin.loadingBase': '≈Åadowanie bazy... To mo≈ºe chwilƒô potrwaƒá.',
                'admin.loadedBase': 'Za≈Çadowano formacji!',
                
                // Quick Select
                'quickSelect.title': 'Szybki wyb√≥r',
                'quickSelect.selectFor': 'Wybierz dla',
                
                // Quick Tags
                'quickTags.expandAll': 'Rozwi≈Ñ wszystkie tagi',
                'quickTags.collapseAll': 'Zwi≈Ñ wszystkie tagi',
                'quickTags.pets': 'Pety',
                
                // Common
                'common.error': 'B≈ÇƒÖd',
                'common.noConnection': 'Brak po≈ÇƒÖczenia z bazƒÖ!',
                'common.formationDeleted': 'Formacja usuniƒôta!',
                'common.cannotDeleteBase': 'Nie mo≈ºesz usunƒÖƒá formacji bazowej!',
                'common.confirmDelete': 'UsunƒÖƒá formacjƒô',
                'common.addedToFavorites': 'Dodano do ulubionych ‚≠ê',
                'common.removedFromFavorites': 'Usuniƒôto z ulubionych',
                
                // Badges
                'badge.base': 'BAZA',
                'badge.user': 'DODANA'
            },
            en: {
                // Loading
                'loading': 'Loading data...',
                'common.loading': 'Loading...',
                'common.cancel': 'Cancel',
                'common.clear': 'Clear',
                
                // Header
                'header.subtitle': 'Counter-formation finder',
                'status.connecting': 'Connecting...',
                'status.online': 'Online',
                'status.offline': 'Offline',
                'status.formations': 'formations',
                
                // Navigation
                'nav.search': 'Search',
                'nav.database': 'Database',
                'nav.preview': 'Preview',
                'nav.add': 'Add',
                'nav.import': 'Import',
                
                // Search
                'search.title': 'Search counter-formations',
                'search.subtitle': 'Enter enemy composition (or use tags)',
                'search.btn': 'SEARCH',
                'search.clear': 'Clear',
                'search.emptyState': 'Enter enemy heroes and click "Search"',
                'search.results': 'Results',
                'search.found': 'Found',
                'search.noResults': 'No matching formations found',
                'search.enemy': 'Enemy',
                'search.missing': 'Missing',
                'search.allSlotsFull': 'All slots are full!',
                'search.petSlotFull': 'Pet slot is full!',
                'search.enterAtLeastOne': 'Enter at least one hero!',
                'search.selected': 'Selected',
                
                // Database
                'database.title': 'Full formation database',
                'database.statsAll': 'Total',
                'database.statsBase': 'Base',
                'database.statsUser': 'Added',
                'database.filterAll': 'All',
                'database.filterBase': 'Base',
                'database.filterUser': 'Added',
                'database.filterFavorites': 'Favorites',
                'database.searchPlaceholder': 'üîç Search...',
                'database.noFormations': 'No formations',
                
                // Preview
                'preview.title': 'Formation preview',
                'preview.idPlaceholder': 'Enter ID (e.g. 12)',
                'preview.showBtn': 'SHOW',
                'preview.emptyState': 'Enter ID to see formation layout',
                'preview.notFound': 'Formation not found',
                'preview.enemy': 'ENEMY',
                'preview.yourTeam': 'YOUR TEAM',
                'preview.noPet': 'No pet',
                'preview.invalidId': 'Enter a valid ID number!',
                
                // Add
                'add.title': 'Add new formation',
                'add.nameLabel': 'Formation name',
                'add.namePlaceholder': 'e.g. Nick 01-01-2025 W1',
                'add.yourTeam': 'Your team',
                'add.enemyTeam': 'Enemy team',
                'add.commentLabel': 'Comment (optional)',
                'add.commentPlaceholder': 'e.g. Avoid Death, Silbren on enemy... etc.',
                'add.saveBtn': 'SAVE FORMATION',
                'add.enterName': 'Enter formation name!',
                'add.addAtLeastOne': 'Add at least one hero!',
                'add.unknownHeroes': 'Unknown heroes',
                'add.unknownPets': 'Unknown pets',
                'add.saved': 'Formation saved',
                
                // Settings
                'settings.title': 'Import / Export',
                'settings.status': 'Status',
                'settings.checking': 'Checking connection...',
                'settings.online': 'Connected to database.',
                'settings.offline': 'No database connection.',
                'settings.exportTitle': 'Export to CSV',
                'settings.exportDesc': 'Download all formations as CSV file',
                'settings.exportBtn': 'Export CSV',
                'settings.importTitle': 'Import from CSV',
                'settings.importDesc': 'Load formations from CSV file (same format as export)',
                'settings.importBtn': 'Import CSV',
                'settings.syncTitle': 'Synchronization',
                'settings.refreshBtn': 'Refresh data',
                'settings.exported': 'Exported',
                'settings.imported': 'Imported',
                
                // Admin
                'admin.title': 'Administrator Panel',
                'admin.enterPassword': 'Enter administrator password',
                'admin.passwordPlaceholder': 'Password...',
                'admin.login': 'LOGIN',
                'admin.panelTitle': 'Administrator Panel',
                'admin.modeActive': 'Admin mode active',
                'admin.modeDesc': 'You can manage heroes, pets and delete any formations.',
                'admin.heroes': 'Heroes',
                'admin.pets': 'Pets',
                'admin.heroNamePlaceholder': 'Hero name',
                'admin.petNamePlaceholder': 'Pet name',
                'admin.manageFormations': 'Manage formations',
                'admin.deleteAllUser': 'Delete all user formations',
                'admin.loadBase': 'Load base data (126)',
                'admin.session': 'Session',
                'admin.logout': 'Logout from Admin mode',
                'admin.loggedIn': 'Logged in as Administrator!',
                'admin.loggedOut': 'Logged out from Admin mode',
                'admin.wrongPassword': 'Wrong password!',
                'admin.alreadyLogged': 'Already logged in as Admin',
                'admin.heroAdded': 'Hero added',
                'admin.heroDeleted': 'Deleted',
                'admin.heroExists': 'Hero already exists!',
                'admin.petAdded': 'Pet added',
                'admin.petExists': 'Pet already exists!',
                'admin.enterHeroName': 'Enter hero name!',
                'admin.enterPetName': 'Enter pet name!',
                'admin.confirmDeleteHero': 'Delete hero',
                'admin.confirmDeletePet': 'Delete pet',
                'admin.confirmDeleteAllUser': 'Are you sure you want to delete ALL user formations?',
                'admin.confirmLoadBase': 'Load 126 base formations?',
                'admin.deletedUserFormations': 'Deleted user formations',
                'admin.loadingBase': 'Loading base... This may take a moment.',
                'admin.loadedBase': 'Loaded formations!',
                
                // Quick Select
                'quickSelect.title': 'Quick select',
                'quickSelect.selectFor': 'Select for',
                
                // Quick Tags
                'quickTags.expandAll': 'Expand all',
                'quickTags.collapseAll': 'Collapse all',
                'quickTags.pets': 'Pets',
                
                // Common
                'common.error': 'Error',
                'common.noConnection': 'No database connection!',
                'common.formationDeleted': 'Formation deleted!',
                'common.cannotDeleteBase': 'Cannot delete base formation!',
                'common.confirmDelete': 'Delete formation',
                'common.addedToFavorites': 'Added to favorites ‚≠ê',
                'common.removedFromFavorites': 'Removed from favorites',
                
                // Badges
                'badge.base': 'BASE',
                'badge.user': 'ADDED'
            }
        };
        
        function t(key) {
            return translations[currentLang][key] || translations['pl'][key] || key;
        }
        
		function setLanguage(lang) {
			currentLang = lang;
			localStorage.setItem('souls_lang', lang);
			
			// Update lang buttons
			document.querySelectorAll('.lang-btn').forEach(btn => {
				btn.classList.remove('active');
			});
			document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');
			
			applyTranslations();
			
			// Re-render dynamic content
			filterDatabase();
			generateQuickTags();
			generateAddFormTags();
			
			// Re-render formation display only if preview tab is active
			const lookupId = document.getElementById('lookup-id').value;
			const previewTab = document.getElementById('tab-view');
			if (lookupId && previewTab.classList.contains('active')) {
				showFormation(parseInt(lookupId));
			}
		}
        
		function applyTranslations() {
			// Text content
			document.querySelectorAll('[data-i18n]').forEach(el => {
				const key = el.getAttribute('data-i18n');
				el.textContent = t(key);
			});
			
			// Placeholders
			document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
				const key = el.getAttribute('data-i18n-placeholder');
				el.placeholder = t(key);
			});
			
			// Update connection status text
			setOnlineStatus(isOnline);
		}
        
        function updateConnectionStatus() {
            const info = document.getElementById('connection-info');
            if (info) {
                if (isOnline) {
                    info.innerHTML = `<strong>üü¢ ${t('status.online')}:</strong> ${t('settings.online')}`;
                } else {
                    info.innerHTML = `<strong>üî¥ ${t('status.offline')}:</strong> ${t('settings.offline')}`;
                }
            }
        }

        // =====================================================
        // üî• FIREBASE CONFIGURATION
        // =====================================================

		const firebaseConfig = {
		  apiKey: "AIzaSyAZSC5B3HfX1AxOKFR06ixlFh0cgdwKY7M",
		  authDomain: "souls-online-war.firebaseapp.com",
		  databaseURL: "https://souls-online-war-default-rtdb.europe-west1.firebasedatabase.app",
		  projectId: "souls-online-war",
		  storageBucket: "souls-online-war.firebasestorage.app",
		  messagingSenderId: "700986594564",
		  appId: "1:700986594564:web:114ff3c81a42edb1d2ac51"
		};
        
        // =====================================================
        
        // Zmienne globalne
        let db = null;
        let formationsRef = null;
        let heroesRef = null;
        let petsRef = null;
        let allFormations = [];
        let isOnline = false;
        let isAdmin = false;
        let headerClickCount = 0;
        let headerClickTimer = null;
        let favorites = JSON.parse(localStorage.getItem('souls_favorites') || '[]');
		
        // Domy≈õlne dane
        let heroes = [
            {name:"Dmitri",race:"Dark"},{name:"Roze",race:"Dark"},{name:"Nebula",race:"Dark"},{name:"Zeke",race:"Dark"},
            {name:"Benzel",race:"Dark"},{name:"Lilith",race:"Dark"},{name:"Bahzam",race:"Dark"},{name:"Zagrako",race:"Dark"},
            {name:"Lumen",race:"Light"},{name:"Akmon",race:"Light"},{name:"Leovalt",race:"Light"},{name:"Lena",race:"Light"},
            {name:"Ulion",race:"Light"},{name:"Nuel",race:"Light"},{name:"Solina",race:"Light"},{name:"Taros",race:"Light"},
            {name:"Muerte",race:"Undead"},{name:"Melantha",race:"Undead"},{name:"Nox",race:"Undead"},{name:"Ripper",race:"Undead"},
            {name:"Fleta",race:"Undead"},{name:"Ash",race:"Undead"},{name:"Dextor",race:"Undead"},{name:"Carmen",race:"Undead"},
            {name:"Zenon",race:"Undead"},{name:"Amanda",race:"Undead"},{name:"Void",race:"Undead"},{name:"Harfa",race:"Undead"},
            {name:"Serena",race:"Elf"},{name:"Oneric",race:"Elf"},{name:"Elara",race:"Elf"},{name:"CoCo",race:"Elf"},
            {name:"Babu",race:"Elf"},{name:"Sander",race:"Elf"},{name:"Tania",race:"Elf"},{name:"Galan",race:"Elf"},
            {name:"Aolmond",race:"Elf"},{name:"LuLu",race:"Elf"},{name:"Fiona",race:"Elf"},{name:"Abala",race:"Elf"},
            {name:"Bella",race:"Fire"},{name:"Lupico",race:"Fire"},{name:"Paopao",race:"Fire"},{name:"Jack",race:"Fire"},
            {name:"Dolucos",race:"Fire"},{name:"Aruru",race:"Fire"},{name:"Kaion",race:"Fire"},{name:"Paru",race:"Fire"},
            {name:"Naru",race:"Fire"},{name:"Telfer",race:"Fire"},{name:"Lagou",race:"Fire"},
            {name:"Morra",race:"Human"},{name:"Scarlet",race:"Human"},{name:"Kyle",race:"Human"},{name:"Adora",race:"Human"},
            {name:"Rakan",race:"Human"},{name:"Olga",race:"Human"},{name:"Idina",race:"Human"},{name:"Ken",race:"Human"},
            {name:"Calix",race:"Human"},{name:"Odelia",race:"Human"},{name:"Milia",race:"Human"},{name:"Richelle",race:"Human"},
            {name:"Liandra",race:"Human"}
        ];
        
        let pets = ["Gladis","Nasrune","Romanelle","Tianum","Hamm","Spooky","Mystet","Bloombell","Silbren","Vailo","Estelle","Banavi","Moko"];
        
        // Inicjalizacja Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            formationsRef = db.ref('formations');
            heroesRef = db.ref('heroes');
            petsRef = db.ref('pets');
            
            formationsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                allFormations = data ? Object.values(data) : [];
                allFormations.sort((a, b) => a.id - b.id);
                updateUI();
                hideLoading();
                setOnlineStatus(true);
            }, (error) => {
                console.error('Firebase error:', error);
                setOnlineStatus(false);
                hideLoading();
            });
            
            heroesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    heroes = Object.values(data);
                    heroes.sort((a, b) => a.name.localeCompare(b.name));
                    if (isAdmin) renderHeroesList();
                }
            });
            
            petsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    pets = Object.values(data).map(p => p.name || p);
                    pets.sort();
                    if (isAdmin) renderPetsList();
                }
            });
            
            db.ref('.info/connected').on('value', (snap) => {
                setOnlineStatus(snap.val() === true);
            });
            
        } catch (error) {
            console.error('Firebase init error:', error);
            setOnlineStatus(false);
            hideLoading();
        }

		function toggleFavorite(id, event) {
		    event.stopPropagation();
		    const index = favorites.indexOf(id);
		    if (index > -1) {
		        favorites.splice(index, 1);
		        showToast(t('common.removedFromFavorites'));
		    } else {
		        favorites.push(id);
		        showToast(t('common.addedToFavorites'));
		    }
		    localStorage.setItem('souls_favorites', JSON.stringify(favorites));
		    filterDatabase();
		}
		
		function isFavorite(id) {
		    return favorites.includes(id);
		}

		function toggleFavoritePreview(id) {
		    const index = favorites.indexOf(id);
		    if (index > -1) {
		        favorites.splice(index, 1);
		        showToast(t('common.removedFromFavorites'));
		    } else {
		        favorites.push(id);
		        showToast(t('common.addedToFavorites'));
		    }
		    localStorage.setItem('souls_favorites', JSON.stringify(favorites));
		    showFormation(id);
		    filterDatabase();
		}

		function addToSearch(heroName) {
			// Sprawd≈∫ czy bohater ju≈º jest w kt√≥rym≈õ polu - je≈õli tak, usu≈Ñ go
			for (let i = 1; i <= 5; i++) {
				const input = document.getElementById(`search-pos${i}`);
				if (input.value.trim().toLowerCase() === heroName.toLowerCase()) {
					input.value = '';
					
					document.querySelectorAll('.quick-tag').forEach(tag => {
						if (tag.textContent === heroName) {
							tag.classList.remove('selected');
						}
					});
					
					updateSearchCounter();
					return;
				}
			}
			
			// Je≈õli nie ma, dodaj do pierwszego wolnego miejsca
			for (let i = 1; i <= 5; i++) {
				const input = document.getElementById(`search-pos${i}`);
				if (!input.value.trim()) {
					input.value = heroName;
					
					document.querySelectorAll('.quick-tag').forEach(tag => {
						if (tag.textContent === heroName) {
							tag.classList.add('selected');
						}
					});

					updateSearchCounter();
					return;
				}
			}
			showToast(t('search.allSlotsFull'), true);
		}

		function addPetToSearch(petName) {
			const petInput = document.getElementById('search-pet');
			
			// Je≈õli ten sam pet - usu≈Ñ
			if (petInput.value.trim().toLowerCase() === petName.toLowerCase()) {
				petInput.value = '';
				document.querySelectorAll('.quick-tag').forEach(tag => {
					if (tag.textContent === petName) {
						tag.classList.remove('selected');
					}
				});
				updateSearchCounter();
				return;
			}
			
			// Je≈õli puste - dodaj
			if (!petInput.value.trim()) {
				petInput.value = petName;
				document.querySelectorAll('.quick-tag').forEach(tag => {
					if (tag.textContent === petName) {
						tag.classList.add('selected');
					}
				});
				updateSearchCounter();
			} else {
				showToast(t('search.petSlotFull'), true);
			}
		}
		
		function updateSearchCounter() {
			let count = 0;
			for (let i = 1; i <= 5; i++) {
				if (document.getElementById(`search-pos${i}`).value.trim()) count++;
			}
			if (document.getElementById('search-pet').value.trim()) count++;
			
			const container = document.getElementById('quick-tags-container');
			let counterEl = document.getElementById('search-counter');
			
			if (count > 0) {
				if (!counterEl) {
					const div = document.createElement('div');
					div.id = 'search-counter';
					div.className = 'search-counter';
					container.parentNode.insertBefore(div, container.nextSibling);
					counterEl = div;
				}
				counterEl.innerHTML = `${t('search.selected')}: <strong>${count}</strong> / 6`;
			} else if (counterEl) {
				counterEl.remove();
			}
		}

		function generateQuickTags() {
			if (allFormations.length === 0) return;
			
			const heroCounts = {};
			const petCounts = {};
			
			allFormations.forEach(f => {
				f.enemy.filter(h => h).forEach(heroName => {
					heroCounts[heroName] = (heroCounts[heroName] || 0) + 1;
				});
				if (f.enemyPet) {
					petCounts[f.enemyPet] = (petCounts[f.enemyPet] || 0) + 1;
				}
			});
			
			const heroRaceMap = {};
			heroes.forEach(h => {
				heroRaceMap[h.name.toLowerCase()] = h.race;
			});
			
			const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
			
			Object.entries(heroCounts)
				.filter(([name, count]) => count >= 1)
				.forEach(([name, count]) => {
					const race = heroRaceMap[name.toLowerCase()];
					if (race && raceGroups[race]) {
						raceGroups[race].push({ name, count });
					}
				});
			
			Object.keys(raceGroups).forEach(race => {
				raceGroups[race].sort((a, b) => a.name.localeCompare(b.name));
			});
			
			const topPets = Object.entries(petCounts)
				.filter(([name, count]) => count >= 1)
				.sort((a, b) => a[0].localeCompare(b[0]))
				.map(([name, count]) => ({ name, count }));
			
			const raceOrder = ['Dark', 'Light', 'Human', 'Fire', 'Elf', 'Undead'];
			const raceEmoji = { Dark: 'üåë', Light: '‚òÄÔ∏è', Human: 'üë§', Fire: 'üî•', Elf: 'üåø', Undead: 'üíÄ' };
			
			let html = `<div class="quick-tags-expand-all">
				<button class="expand-all-btn" onclick="toggleAllQuickTags()">‚ñ≤ ${t('quickTags.collapseAll')}</button>
			</div>`;
			
			raceOrder.forEach(race => {
				if (raceGroups[race].length > 0) {
					html += `
						<div class="quick-tags-section">
							<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
								<span class="toggle-icon">‚ñ∂</span>
								${raceEmoji[race]} ${race} (${raceGroups[race].length})
							</div>
							<div class="quick-tags-content show">
								<div class="quick-tags">
									${raceGroups[race].map(h => 
										`<span class="quick-tag tag-${race.toLowerCase()}" onclick="addToSearch('${h.name}')" title="${h.count}x">${h.name}</span>`
									).join('')}
								</div>
							</div>
						</div>`;
				}
			});
			
			if (topPets.length > 0) {
				html += `
					<div class="quick-tags-section">
						<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
							<span class="toggle-icon">‚ñ∂</span>
							üêæ ${t('quickTags.pets')} (${topPets.length})
						</div>
						<div class="quick-tags-content show">
							<div class="quick-tags">
								${topPets.map(p => 
									`<span class="quick-tag tag-pet" onclick="addPetToSearch('${p.name}')" title="${p.count}x">${p.name}</span>`
								).join('')}
							</div>
						</div>
					</div>`;
			}
			
			document.getElementById('quick-tags-container').innerHTML = html;
			updateSearchTagsSelection(); // Od≈õwie≈º zaznaczenie tag√≥w
		}
		
		function generateAddFormTags() {
			const container = document.getElementById('add-form-tags-container');
			if (!container) return;
			
			const heroRaceMap = {};
			heroes.forEach(h => { heroRaceMap[h.name] = h.race; });
			
			const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
			heroes.forEach(h => {
				if (raceGroups[h.race]) {
					raceGroups[h.race].push(h.name);
				}
			});
			
			Object.keys(raceGroups).forEach(race => {
				raceGroups[race].sort((a, b) => a.localeCompare(b));
			});
			
			const raceOrder = ['Dark', 'Light', 'Human', 'Fire', 'Elf', 'Undead'];
			const raceEmoji = { Dark: 'üåë', Light: '‚òÄÔ∏è', Human: 'üë§', Fire: 'üî•', Elf: 'üåø', Undead: 'üíÄ' };
			
			let html = `<div class="quick-tags-expand-all">
				<button class="expand-all-btn" onclick="toggleAllAddFormTags()">‚ñ≤ ${t('quickTags.collapseAll')}</button>
			</div>`;
			
			// Bohaterowie - domy≈õlnie zwiniƒôte
			raceOrder.forEach(race => {
				if (raceGroups[race].length > 0) {
					html += `
						<div class="quick-tags-section">
							<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
								<span class="toggle-icon">‚ñ∂</span>
								${raceEmoji[race]} ${race} (${raceGroups[race].length})
							</div>
							<div class="quick-tags-content show">
								<div class="quick-tags">
									${raceGroups[race].map(name => 
										`<span class="quick-tag tag-${race.toLowerCase()}" onclick="addTagToActiveField('${name}', 'hero')">${name}</span>`
									).join('')}
								</div>
							</div>
						</div>`;
				}
			});
			
			// Pety
			html += `
				<div class="quick-tags-section">
					<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
						<span class="toggle-icon">‚ñ∂</span>
						üêæ ${t('quickTags.pets')} (${pets.length})
					</div>
					<div class="quick-tags-content show">
						<div class="quick-tags">
							${pets.map(p => {
								const petName = typeof p === 'string' ? p : p.name;
								return `<span class="quick-tag tag-pet" onclick="addTagToActiveField('${petName}', 'pet')">${petName}</span>`;
							}).join('')}
						</div>
					</div>
				</div>`;
			
			container.innerHTML = html;
			updateAddFormTagsSelection();
		}
		
		function toggleAllAddFormTags() {
			const container = document.getElementById('add-form-tags-container');
			const sections = container.querySelectorAll('.quick-tags-section');
			const btn = container.querySelector('.expand-all-btn');
			const allExpanded = container.querySelectorAll('.quick-tags-header.expanded').length === sections.length;
			
			sections.forEach(section => {
				const header = section.querySelector('.quick-tags-header');
				const content = section.querySelector('.quick-tags-content');
				if (allExpanded) {
					header.classList.remove('expanded');
					content.classList.remove('show');
				} else {
					header.classList.add('expanded');
					content.classList.add('show');
				}
			});
			
			btn.textContent = allExpanded ? `‚ñº ${t('quickTags.expandAll')}` : `‚ñ≤ ${t('quickTags.collapseAll')}`;
		}
		
		function addTagToActiveField(value, type) {
			// Je≈õli nie ma aktywnego pola, poka≈º komunikat
			if (!activeAddField) {
				showToast(currentLang === 'pl' ? 'Najpierw kliknij w pole!' : 'Click a field first!', true);
				return;
			}
			
			const input = document.getElementById(activeAddField);
			if (!input) return;
			
			// Sprawd≈∫ czy typ siƒô zgadza (pet do pola pet, hero do pola hero)
			const isPetField = activeAddField.includes('Pet');
			if (isPetField && type !== 'pet') {
				showToast(currentLang === 'pl' ? 'To pole jest na Peta!' : 'This field is for Pet!', true);
				return;
			}
			if (!isPetField && type === 'pet') {
				showToast(currentLang === 'pl' ? 'Wybierz pole Pet!' : 'Select a Pet field!', true);
				return;
			}
			
			// Okre≈õl sekcjƒô aktywnego pola (my lub enemy)
			const isMySection = activeAddField.includes('add-my');
			
			// Sprawd≈∫ tylko w TEJ SAMEJ sekcji czy warto≈õƒá ju≈º istnieje
			const sectionFields = type === 'pet'
				? (isMySection ? ['add-myPet'] : ['add-enemyPet'])
				: (isMySection 
					? ['add-my1', 'add-my2', 'add-my3', 'add-my4', 'add-my5', 'add-my6', 'add-my7', 'add-my8']
					: ['add-enemy1', 'add-enemy2', 'add-enemy3', 'add-enemy4', 'add-enemy5', 'add-enemy6', 'add-enemy7', 'add-enemy8']);
			
			// Je≈õli warto≈õƒá ju≈º jest w tej sekcji - usu≈Ñ jƒÖ
			for (const fieldId of sectionFields) {
				const field = document.getElementById(fieldId);
				if (field && field.value.trim().toLowerCase() === value.toLowerCase()) {
					field.value = '';
					updateAddFormTagsSelection();
					return;
				}
			}
			
			// Ustaw warto≈õƒá w aktywnym polu
			input.value = value;
			updateAddFormTagsSelection();
		}

		function updateAddFormTagsSelection() {
			// Okre≈õl aktywnƒÖ sekcjƒô
			const isMySection = activeAddField ? activeAddField.includes('add-my') : true;
			
			// Zbierz warto≈õci tylko z AKTYWNEJ sekcji
			const activeValues = [];
			
			if (isMySection) {
				for (let i = 1; i <= 8; i++) {
					const val = document.getElementById(`add-my${i}`)?.value.trim().toLowerCase();
					if (val) activeValues.push(val);
				}
				const pet = document.getElementById('add-myPet')?.value.trim().toLowerCase();
				if (pet) activeValues.push(pet);
			} else {
				for (let i = 1; i <= 8; i++) {
					const val = document.getElementById(`add-enemy${i}`)?.value.trim().toLowerCase();
					if (val) activeValues.push(val);
				}
				const pet = document.getElementById('add-enemyPet')?.value.trim().toLowerCase();
				if (pet) activeValues.push(pet);
			}
			
			// Zaznacz/odznacz tagi TYLKO w zak≈Çadce Dodaj
			document.querySelectorAll('#add-form-tags-container .quick-tag').forEach(tag => {
				const tagValue = tag.textContent.toLowerCase();
				if (activeValues.includes(tagValue)) {
					tag.classList.add('selected');
				} else {
					tag.classList.remove('selected');
				}
			});

			// Aktualizuj licznik
			updateAddFormCounter();
		}
		
		function updateAddFormCounter() {
			let myCount = 0;
			let enemyCount = 0;
			
			for (let i = 1; i <= 8; i++) {
				if (document.getElementById(`add-my${i}`)?.value.trim()) myCount++;
				if (document.getElementById(`add-enemy${i}`)?.value.trim()) enemyCount++;
			}
			if (document.getElementById('add-myPet')?.value.trim()) myCount++;
			if (document.getElementById('add-enemyPet')?.value.trim()) enemyCount++;
			
			const indicator = document.getElementById('active-field-indicator');
			const counterEl = document.getElementById('add-form-counter');
			
			if (myCount > 0 || enemyCount > 0) {
				if (!counterEl) {
					const div = document.createElement('div');
					div.id = 'add-form-counter';
					div.className = 'search-counter';
					div.style.display = 'block';
					div.style.width = '100%';
					div.style.marginTop = '8px';
					indicator.parentNode.insertBefore(div, indicator.nextSibling);
				}
				const counterElement = document.getElementById('add-form-counter');
				const yourLabel = currentLang === 'en' ? 'Your' : 'Tw√≥j';
				const enemyLabel = currentLang === 'en' ? 'Enemy' : 'Przeciwnik';
				counterElement.innerHTML = `‚öîÔ∏è ${yourLabel}: <strong>${myCount}</strong>/9 | üëπ ${enemyLabel}: <strong>${enemyCount}</strong>/9`;
			} else {
				const existing = document.getElementById('add-form-counter');
				if (existing) existing.remove();
			}
		}

		function toggleQuickTagSection(header) {
			header.classList.toggle('expanded');
			const content = header.nextElementSibling;
			content.classList.toggle('show');
		}

		function toggleAllQuickTags() {
			const sections = document.querySelectorAll('#quick-tags-container .quick-tags-section');
			const btn = document.querySelector('.expand-all-btn');
			const allExpanded = document.querySelectorAll('#quick-tags-container .quick-tags-header.expanded').length === sections.length;
			
			sections.forEach(section => {
				const header = section.querySelector('.quick-tags-header');
				const content = section.querySelector('.quick-tags-content');
				if (allExpanded) {
					header.classList.remove('expanded');
					content.classList.remove('show');
				} else {
					header.classList.add('expanded');
					content.classList.add('show');
				}
			});
			
			btn.textContent = allExpanded ? `‚ñº ${t('quickTags.expandAll')}` : `‚ñ≤ ${t('quickTags.collapseAll')}`;
		}

		// ========== QUICK SELECT DLA DODAJ ==========
		let quickSelectTarget = null;
		let activeAddField = null; // Aktywne pole w formularzu dodawania

		function openQuickSelect(targetInputId, label) {
			quickSelectTarget = targetInputId;
			document.getElementById('quick-select-target').innerHTML = `${t('quickSelect.selectFor')}: <strong>${label}</strong>`;
			
			const heroRaceMap = {};
			heroes.forEach(h => { heroRaceMap[h.name] = h.race; });
			
			const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
			heroes.forEach(h => {
				if (raceGroups[h.race]) {
					raceGroups[h.race].push(h.name);
				}
			});
			
			Object.keys(raceGroups).forEach(race => {
				raceGroups[race].sort((a, b) => a.localeCompare(b));
			});
			
			const raceOrder = ['Dark', 'Light', 'Human', 'Fire', 'Elf', 'Undead'];
			const raceEmoji = { Dark: 'üåë', Light: '‚òÄÔ∏è', Human: 'üë§', Fire: 'üî•', Elf: 'üåø', Undead: 'üíÄ' };
			const isPet = targetInputId.includes('Pet');
			
			let html = '';
			
			if (isPet) {
				html = `
					<div class="quick-tags-section">
						<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
							<span class="toggle-icon">‚ñ∂</span> üêæ ${t('quickTags.pets')}
						</div>
						<div class="quick-tags-content show">
							<div class="quick-tags">
								${pets.map(p => {
									const petName = typeof p === 'string' ? p : p.name;
									return `<span class="quick-tag tag-pet" onclick="selectQuickItem('${petName}')">${petName}</span>`;
								}).join('')}
							</div>
						</div>
					</div>`;
				} else {
						raceOrder.forEach(race => {
							if (raceGroups[race].length > 0) {
								html += `
									<div class="quick-tags-section">
										<div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)">
											<span class="toggle-icon">‚ñ∂</span>
											${raceEmoji[race]} ${race} (${raceGroups[race].length})
										</div>
										<div class="quick-tags-content show">
											<div class="quick-tags">
												${raceGroups[race].map(name => 
													`<span class="quick-tag tag-${race.toLowerCase()}" onclick="selectQuickItem('${name}')">${name}</span>`
												).join('')}
											</div>
										</div>
									</div>`;
							}
						});
					}
			
			document.getElementById('quick-select-tags').innerHTML = html;
			document.getElementById('quick-select-modal').classList.remove('hidden');
		}

		function selectQuickItem(value) {
			if (quickSelectTarget) {
				document.getElementById(quickSelectTarget).value = value;
			}
			closeQuickSelect();
		}

		function closeQuickSelect() {
			document.getElementById('quick-select-modal').classList.add('hidden');
			quickSelectTarget = null;
		}
		
		document.getElementById('quick-select-modal').addEventListener('click', function(e) {
			if (e.target === this) {
				closeQuickSelect();
			}
		});

		document.addEventListener('keydown', function(e) {
			if (e.key === 'Escape') {
				const modal = document.getElementById('quick-select-modal');
				if (!modal.classList.contains('hidden')) {
					closeQuickSelect();
				}
			}
		});
		
        // ========== ADMIN ==========
        function headerClick() {
            headerClickCount++;
            clearTimeout(headerClickTimer);
            
            if (headerClickCount >= 8) {
                headerClickCount = 0;
                if (isAdmin) {
                    showToast(t('admin.alreadyLogged'));
                } else {
                    document.getElementById('admin-modal').classList.remove('hidden');
                }
            } else {
                headerClickTimer = setTimeout(() => headerClickCount = 0, 2000);
            }
        }
        
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-password').value = '';
        }
        
		async function tryAdminLogin() {
		    const password = document.getElementById('admin-password').value;
		    
		    try {
		        const snapshot = await db.ref('config/adminPassword').once('value');
		        const correctPassword = snapshot.val();
		        
		        if (password === correctPassword) {
		            isAdmin = true;
		            localStorage.setItem('souls_admin', 'true');
		            closeAdminModal();
		            enableAdminMode();
		            showToast('üîì ' + t('admin.loggedIn'));
		        } else {
		            showToast('‚ùå ' + t('admin.wrongPassword'), true);
		        }
		    } catch (error) {
		        showToast('‚ùå ' + t('common.error') + ': ' + error.message, true);
		    }
		}
        
		function enableAdminMode() {
		    isAdmin = true;
		    document.getElementById('admin-badge').style.display = 'inline';
		    document.getElementById('nav-admin').classList.add('show');
		    document.getElementById('nav-settings').classList.add('show');
		    renderHeroesList();
		    renderPetsList();
		    filterDatabase();
		}
        
		function adminLogout() {
		    isAdmin = false;
		    localStorage.removeItem('souls_admin');
		    document.getElementById('admin-badge').style.display = 'none';
		    document.getElementById('nav-admin').classList.remove('show');
		    document.getElementById('nav-settings').classList.remove('show');
		    switchTab('search');
		    filterDatabase();
		    showToast('üö™ ' + t('admin.loggedOut'));
		}
        
        function checkAdminSession() {
            if (localStorage.getItem('souls_admin') === 'true') {
                enableAdminMode();
            }
        }
        
        // ========== ZARZƒÑDZANIE BOHATERAMI ==========
        function renderHeroesList() {
            const container = document.getElementById('heroes-list');
            document.getElementById('heroes-count').textContent = heroes.length;
            
            const byRace = {};
            heroes.forEach(h => {
                if (!byRace[h.race]) byRace[h.race] = [];
                byRace[h.race].push(h);
            });
            
            let html = '';
            Object.keys(byRace).sort().forEach(race => {
                html += `<div style="font-size:0.7rem;color:var(--accent-gold);margin:10px 0 5px;border-bottom:1px solid var(--border);padding-bottom:3px;">${race} (${byRace[race].length})</div>`;
                byRace[race].forEach(hero => {
                    html += `
                        <div class="entity-item">
                            <span class="entity-name">${hero.name}</span>
                            <button class="btn btn-danger btn-small" onclick="deleteHero('${hero.name}')">üóëÔ∏è</button>
                        </div>`;
                });
            });
            
            container.innerHTML = html || `<p style="color:var(--text-muted);text-align:center;">${t('database.noFormations')}</p>`;
        }
        
        async function addHero() {
            const name = document.getElementById('new-hero-name').value.trim();
            const race = document.getElementById('new-hero-race').value;
            
            if (!name) { showToast(t('admin.enterHeroName'), true); return; }
            if (heroes.some(h => h.name.toLowerCase() === name.toLowerCase())) {
                showToast(t('admin.heroExists'), true); return;
            }
            
            try {
                const newHero = { name, race };
                await heroesRef.child(name).set(newHero);
                document.getElementById('new-hero-name').value = '';
                showToast(`${t('admin.heroAdded')}: ${name}`);
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        async function deleteHero(name) {
            if (!confirm(`${t('admin.confirmDeleteHero')} "${name}"?`)) return;
            
            try {
                await heroesRef.child(name).remove();
                showToast(`${t('admin.heroDeleted')}: ${name}`);
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        // ========== ZARZƒÑDZANIE PETAMI ==========
        
        function renderPetsList() {
            const container = document.getElementById('pets-list');
            document.getElementById('pets-count').textContent = pets.length;
            
            container.innerHTML = pets.map(pet => `
                <div class="entity-item">
                    <span class="entity-name">üêæ ${pet}</span>
                    <button class="btn btn-danger btn-small" onclick="deletePet('${pet}')">üóëÔ∏è</button>
                </div>
            `).join('') || `<p style="color:var(--text-muted);text-align:center;">${t('database.noFormations')}</p>`;
        }
        
        async function addPet() {
            const name = document.getElementById('new-pet-name').value.trim();
            
            if (!name) { showToast(t('admin.enterPetName'), true); return; }
            if (pets.some(p => p.toLowerCase() === name.toLowerCase())) {
                showToast(t('admin.petExists'), true); return;
            }
            
            try {
                await petsRef.child(name).set({ name });
                document.getElementById('new-pet-name').value = '';
                showToast(`${t('admin.petAdded')}: ${name}`);
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        async function deletePet(name) {
            if (!confirm(`${t('admin.confirmDeletePet')} "${name}"?`)) return;
            
            try {
                await petsRef.child(name).remove();
                showToast(`${t('admin.heroDeleted')}: ${name}`);
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        // ========== UI HELPERS ==========
        
        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
        
        function setOnlineStatus(online) {
            isOnline = online;
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (online) {
                dot.className = 'status-dot online';
                text.textContent = t('status.online');
            } else {
                dot.className = 'status-dot offline';
                text.textContent = t('status.offline');
            }
            
            updateConnectionStatus();
        }
        
		function updateUI() {
			document.getElementById('total-count').textContent = allFormations.length;
			
			const baseCount = allFormations.filter(f => f.isBase).length;
			const userCount = allFormations.filter(f => !f.isBase).length;
			
			document.getElementById('db-stat-total').textContent = allFormations.length;
			document.getElementById('db-stat-base').textContent = baseCount;
			document.getElementById('db-stat-user').textContent = userCount;
			
			filterDatabase();
			generateQuickTags();
			generateAddFormTags();
		}
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const navBtn = document.querySelector(`.nav-btn[onclick="switchTab('${tabName}')"]`);
            if (navBtn) navBtn.classList.add('active');
            
            const tab = document.getElementById(`tab-${tabName}`);
            if (tab) tab.classList.add('active');
        }
        
        // ========== AUTOUZUPE≈ÅNIANIE ==========
        
        function setupAutocomplete() {
            document.querySelectorAll('input[data-type]').forEach(input => {
                const listId = 'list-' + input.id;
                const list = document.getElementById(listId);
                if (!list) return;
                
                const type = input.dataset.type;
                
				input.addEventListener('input', () => {
					// Aktualizuj tagi w formularzu dodawania (tylko dla zak≈Çadki Dodaj)
					if (input.id.startsWith('add-') && input.id !== 'add-name' && input.id !== 'add-comment') {
						updateAddFormTagsSelection();
						
						// Walidacja na ≈ºywo
						const val = input.value.trim().toLowerCase();
						if (val) {
							const isHero = input.dataset.type === 'hero';
							const isPet = input.dataset.type === 'pet';
							let isValid = false;
							
							if (isHero) {
								isValid = heroes.some(h => h.name.toLowerCase() === val);
							} else if (isPet) {
								isValid = pets.some(p => (typeof p === 'string' ? p : p.name).toLowerCase() === val);
							}
							
							input.classList.toggle('invalid-hero', !isValid);
							input.classList.toggle('valid-hero', isValid);
						} else {
							input.classList.remove('invalid-hero', 'valid-hero');
						}
					}
					// Aktualizuj tagi w wyszukiwarce (tylko dla zak≈Çadki Szukaj)
					if (input.id.startsWith('search-')) {
						updateSearchTagsSelection();
					}
					
					const val = input.value.toLowerCase();
					if (val.length < 1) { list.classList.remove('show'); return; }
                    
                    let items = type === 'pet' ? pets : heroes;
					let filtered = type === 'pet' 
					    ? items.filter(p => p.toLowerCase().startsWith(val)).slice(0, 6)
					    : items.filter(h => h.name.toLowerCase().startsWith(val)).slice(0, 6);
                    
                    if (filtered.length === 0) { list.classList.remove('show'); return; }
                    
                    list.innerHTML = filtered.map(item => {
                        if (type === 'pet') {
                            return `<div class="autocomplete-item" data-value="${item}">${item}</div>`;
                        } else {
                            const raceClass = `race-${item.race.toLowerCase()}`;
                            return `<div class="autocomplete-item ${raceClass}" data-value="${item.name}">${item.name} <span class="race">(${item.race})</span></div>`;
                        }
                    }).join('');
                    
                    list.classList.add('show');
					list.querySelectorAll('.autocomplete-item').forEach(item => {
						item.addEventListener('click', () => {
							input.value = item.dataset.value;
							list.classList.remove('show');
							updateAddFormTagsSelection();
						});
					});
                });
                
				input.addEventListener('blur', () => {
					setTimeout(() => {
						list.classList.remove('show');
						// Aktualizuj tagi po wyj≈õciu z pola
						if (input.id.startsWith('search-')) {
							updateSearchTagsSelection();
						}
						if (input.id.startsWith('add-') && input.id !== 'add-name' && input.id !== 'add-comment') {
							updateAddFormTagsSelection();
						}
					}, 200);
				});
            });
        }
		
		function updateSearchTagsSelection() {
			const values = [];
			for (let i = 1; i <= 5; i++) {
				const val = document.getElementById(`search-pos${i}`)?.value.trim().toLowerCase();
				if (val) values.push(val);
			}
			const pet = document.getElementById('search-pet')?.value.trim().toLowerCase();
			if (pet) values.push(pet);
			
			// Zaznacz/odznacz tagi TYLKO w wyszukiwarce
			document.querySelectorAll('#quick-tags-container .quick-tag').forEach(tag => {
				const tagValue = tag.textContent.toLowerCase();
				if (values.includes(tagValue)) {
					tag.classList.add('selected');
				} else {
					tag.classList.remove('selected');
				}
			});
		}
        
        // ========== WYSZUKIWANIE ==========
        
        function normalize(str) { return (str || '').trim().toLowerCase(); }
        
		function searchFormations() {
		    const searchHeroes = [];
		    for (let i = 1; i <= 5; i++) {
		        const val = document.getElementById(`search-pos${i}`).value.trim();
		        if (val) searchHeroes.push(normalize(val));
		    }
		    const searchPet = normalize(document.getElementById('search-pet').value);
		    
		    if (searchHeroes.length === 0 && !searchPet) {
		        showToast(t('search.enterAtLeastOne'), true);
		        return;
		    }
		    
		    const results = [];
		    
		    allFormations.forEach(formation => {
		        const enemyHeroes = formation.enemy.filter(h => h).map(h => normalize(h));
		        const enemyPet = normalize(formation.enemyPet);
		        
		        let matchedHeroes = [];
		        searchHeroes.forEach(sh => {
					const isMatch = enemyHeroes.some(eh => 
					    eh === sh || eh.startsWith(sh)
					);
		            if (isMatch) {
		                matchedHeroes.push(sh);
		            }
		        });
		        
		        let petMatched = searchPet && (
		            enemyPet === searchPet || 
		            enemyPet.startsWith(searchPet)
		        );
		        
		        const totalSearched = searchHeroes.length + (searchPet ? 1 : 0);
		        const totalMatched = matchedHeroes.length + (petMatched ? 1 : 0);
		        
		        if (totalMatched > 0) {
		            results.push({ formation, matchedHeroes, petMatched, score: totalMatched, maxScore: totalSearched });
		        }
		    });
		    
		    results.sort((a, b) => b.score - a.score);
		    displayResults(results);
		}
        
        function displayResults(results) {
            const container = document.getElementById('results-section');
            
            if (results.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>${t('search.noResults')}</p></div>`;
                return;
            }
            
            let html = `<div class="results-header"><h3>${t('search.results')}</h3><span class="results-count">${t('search.found')}: ${results.length}</span></div>`;
            
            results.forEach(result => {
                const f = result.formation;
                const enemyDisplay = f.enemy.filter(h => h).map(h => {
				const isMatched = result.matchedHeroes.some(mh => 
				    normalize(h) === mh || normalize(h).startsWith(mh)
				);
                    return isMatched ? `<span class="matched-hero">${h}</span>` : h;
                }).join(', ');
                
                const petDisplay = result.petMatched ? `<span class="matched-hero">${f.enemyPet}</span>` : (f.enemyPet || '‚Äî');
                const matchClass = `match-${Math.min(result.score, 6)}`;
                const badge = f.isBase ? '' : `<span class="badge user-badge">${t('badge.user')}</span>`;
                
				const searchHeroes = [];
				for (let i = 1; i <= 5; i++) {
				    const val = document.getElementById(`search-pos${i}`).value.trim();
				    if (val) searchHeroes.push(normalize(val));
				}
				const missingHeroes = searchHeroes.filter(sh => !result.matchedHeroes.includes(sh));
				const missingDisplay = missingHeroes.length > 0 
				    ? `<div class="result-missing">‚ùå ${t('search.missing')}: ${missingHeroes.join(', ')}</div>` 
				    : '';
				
				html += `
				    <div class="result-card" onclick="showFormation(${f.id})">
				        <div class="result-card-header">
				            <span class="result-id">ID: ${f.id} ${badge}</span>
				            <span class="match-score ${matchClass}">${result.score}/${result.maxScore}</span>
				        </div>
				        <div class="result-name">${f.name}</div>
				        <div class="result-heroes">${t('search.enemy')}: ${enemyDisplay} + ${petDisplay}</div>
				        ${missingDisplay}
				    </div>`;
            });
            
            container.innerHTML = html;
        }
        
	function clearSearch() {
		for (let i = 1; i <= 5; i++) document.getElementById(`search-pos${i}`).value = '';
		document.getElementById('search-pet').value = '';
		document.getElementById('results-section').innerHTML = `<div class="empty-state"><p>${t('search.emptyState')}</p></div>`;
		
		document.querySelectorAll('.quick-tag.selected').forEach(tag => {
			tag.classList.remove('selected');
		});
		
		updateSearchCounter();
	}
        
        // ========== BAZA DANYCH ==========
        
        let currentDbFilter = 'all';
        
        function setDbFilter(filter) {
            currentDbFilter = filter;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            filterDatabase();
        }
        
        function filterDatabase() {
            const searchTerm = normalize(document.getElementById('db-search')?.value || '');
            let formations = allFormations;
            
            if (currentDbFilter === 'base') formations = formations.filter(f => f.isBase);
            else if (currentDbFilter === 'user') formations = formations.filter(f => !f.isBase);

			if (currentDbFilter === 'favorites') formations = formations.filter(f => favorites.includes(f.id));
			
            if (searchTerm) formations = formations.filter(f => normalize(f.name).includes(searchTerm));
            
            renderDatabaseList(formations);
        }
        
        function renderDatabaseList(formations) {
            const container = document.getElementById('database-list');
            
            if (formations.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>${t('database.noFormations')}</p></div>`;
                return;
            }
            
            container.innerHTML = formations.map(f => {
                const myHeroes = f.my.filter(h => h).join(', ') || '‚Äî';
                const enemyHeroes = f.enemy.filter(h => h).join(', ') || '‚Äî';
                const badge = f.isBase ? `<span class="badge base-badge">${t('badge.base')}</span>` : `<span class="badge user-badge">${t('badge.user')}</span>`;
                
                const canDelete = isAdmin || !f.isBase;
                const deleteBtn = canDelete ? `<button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteFormation(${f.id})">üóëÔ∏è</button>` : '';
                
                return `
                    <div class="db-item" onclick="showFormation(${f.id})">
                        <div class="db-item-info">
                            <div class="db-item-header"><span class="db-item-id">#${f.id}</span>${badge}</div>
                            <div class="db-item-name">${f.name}</div>
                            <div class="db-item-details">
                                <div>‚öîÔ∏è ${myHeroes} + ${f.myPet || '‚Äî'}</div>
                                <div>üëπ ${enemyHeroes} + ${f.enemyPet || '‚Äî'}</div>
                            </div>
                        </div>
						<div class="db-item-actions">
						    <button class="btn btn-small ${isFavorite(f.id) ? 'btn-favorite-active' : ''}" 
						            onclick="toggleFavorite(${f.id}, event)">
						        ${isFavorite(f.id) ? '‚≠ê' : '‚òÜ'}
						    </button>
						    <button class="btn btn-small" onclick="event.stopPropagation(); showFormation(${f.id})">üëÅÔ∏è</button>
						    ${deleteBtn}
						</div>
                    </div>`;
            }).join('');
        }
        
        // ========== PODGLƒÑD - BATTLEFIELD REDESIGN ==========
        
		function lookupById() {
		    const input = document.getElementById('lookup-id').value.trim();
		    const id = parseInt(input);
		    
		    if (!input || isNaN(id) || id < 1) { 
		        showToast(t('preview.invalidId'), true); 
		        return; 
		    }
		    showFormation(id);
		}
        
        function showFormation(id) {
            const formation = allFormations.find(f => f.id === id);
            
            if (!formation) {
                document.getElementById('formation-display').innerHTML = `
                    <div class="empty-state">
                        <p>${t('preview.notFound')} #${id}</p>
                    </div>`;
                return;
            }
            
            switchTab('view');
            document.getElementById('lookup-id').value = id;
            
            const typeBadge = formation.isBase 
                ? `<span class="formation-type-badge base">${t('badge.base')}</span>` 
                : `<span class="formation-type-badge user">${t('badge.user')}</span>`;
            
            const isFav = isFavorite(id);
            const favBtnClass = isFav ? 'btn-favorite-active' : 'btn-secondary';
            const favIcon = isFav ? '‚≠ê' : '‚òÜ';
            
            document.getElementById('formation-display').innerHTML = `
                <div class="formation-preview">
                    <!-- Nag≈Ç√≥wek -->
                    <div class="preview-header">
                        <div class="preview-title">
                            <span class="preview-id">#${formation.id}</span>
                            ${formation.name}
                            ${typeBadge}
                        </div>
                        <div class="preview-actions">
                            <button class="btn btn-small ${favBtnClass}" onclick="toggleFavoritePreview(${id})">
                                ${favIcon}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Sekcja przeciwnika -->
                    <div class="battle-section enemy">
                        <div class="battle-title enemy-title">
                            <span class="title-icon">üëπ</span>
                            ${t('preview.enemy')}
                        </div>
                        <div style="text-align: center;">
                            ${renderBattlePet(formation.enemyPet)}
                        </div>
                        ${renderBattleGrid(formation.enemy, true)}
                        <div class="battle-arrows animated">
                            <div class="battle-arrow down"></div>
                        </div>
                    </div>
                    
                    <!-- Separator VS -->
                    <div class="vs-separator">
                        <span class="vs-badge">VS</span>
                    </div>
                    
                    <!-- Sekcja gracza -->
                    <div class="battle-section player">
                        <div class="battle-arrows animated">
                            <div class="battle-arrow up"></div>
                        </div>
                        ${renderBattleGrid(formation.my, false)}
                        <div style="text-align: center;">
                            ${renderBattlePet(formation.myPet)}
                        </div>
                        <div class="battle-title player-title">
                            <span class="title-icon">‚öîÔ∏è</span>
                            ${t('preview.yourTeam')}
                        </div>
                    </div>
                    
                    <!-- Komentarz -->
                    ${formation.comment ? `
                        <div class="preview-comment">
                            <span class="comment-icon">üí¨</span>
                            ${formation.comment}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderBattleGrid(heroesArray, isEnemy) {
            const createSlot = (index) => {
                const heroName = heroesArray[index] || '';
                
                if (!heroName) {
                    return `<div class="battle-slot empty"></div>`;
                }
                
                const heroData = heroes.find(h => h.name.toLowerCase() === heroName.toLowerCase());
                const race = heroData ? heroData.race.toLowerCase() : '';
                const raceClass = race ? `race-${race}` : '';
                
                return `
                    <div class="battle-slot filled ${raceClass}">
                        <span class="hero-name">${heroName}</span>
                    </div>
                `;
            };
            
            if (isEnemy) {
                return `
                    <div class="battle-grid">
                        <div class="battle-row">${createSlot(5)}${createSlot(6)}${createSlot(7)}</div>
                        <div class="battle-row">${createSlot(3)}${createSlot(4)}</div>
                        <div class="battle-row">${createSlot(0)}${createSlot(1)}${createSlot(2)}</div>
                    </div>
                `;
            } else {
                return `
                    <div class="battle-grid">
                        <div class="battle-row">${createSlot(0)}${createSlot(1)}${createSlot(2)}</div>
                        <div class="battle-row">${createSlot(3)}${createSlot(4)}</div>
                        <div class="battle-row">${createSlot(5)}${createSlot(6)}${createSlot(7)}</div>
                    </div>
                `;
            }
        }

        function renderBattlePet(petName) {
            if (!petName) {
                return `
                    <div class="battle-pet empty">
                        <span class="pet-icon">üêæ</span>
                        <span>${t('preview.noPet')}</span>
                    </div>
                `;
            }
            
            return `
                <div class="battle-pet filled">
                    <span class="pet-icon">üêæ</span>
                    <span>${petName}</span>
                </div>
            `;
        }
        
        // ========== DODAWANIE ==========
		async function saveFormation() {
		    if (!isOnline) { 
		        showToast(t('common.noConnection'), true); 
		        return; 
		    }
		    
		    const name = document.getElementById('add-name').value.trim();
		    if (!name) { 
		        showToast(t('add.enterName'), true); 
		        return; 
		    }
		    
		    const my = [], enemy = [];
		    for (let i = 1; i <= 8; i++) {
		        my.push(document.getElementById(`add-my${i}`).value.trim());
		        enemy.push(document.getElementById(`add-enemy${i}`).value.trim());
		    }
		    
		    const myPet = document.getElementById('add-myPet').value.trim();
		    const enemyPet = document.getElementById('add-enemyPet').value.trim();
		    
		    if (my.filter(h => h).length === 0 && enemy.filter(h => h).length === 0) {
		        showToast(t('add.addAtLeastOne'), true);
		        return;
		    }
		    
		    const allHeroNames = heroes.map(h => h.name.toLowerCase());
		    const enteredHeroes = [...my, ...enemy].filter(h => h);
		    const invalidHeroes = enteredHeroes.filter(h => !allHeroNames.includes(h.toLowerCase()));
		    
		    if (invalidHeroes.length > 0) {
		        showToast(`${t('add.unknownHeroes')}: ${invalidHeroes.slice(0, 3).join(', ')}${invalidHeroes.length > 3 ? '...' : ''}`, true);
		        return;
		    }
		    
		    const allPetNames = pets.map(p => (typeof p === 'string' ? p : p.name).toLowerCase());
		    const enteredPets = [myPet, enemyPet].filter(p => p);
		    const invalidPets = enteredPets.filter(p => !allPetNames.includes(p.toLowerCase()));
		    
		    if (invalidPets.length > 0) {
		        showToast(`${t('add.unknownPets')}: ${invalidPets.join(', ')}`, true);
		        return;
		    }
		    
		    const newId = allFormations.length > 0 ? Math.max(...allFormations.map(f => f.id)) + 1 : 1;
		    const comment = document.getElementById('add-comment').value.trim();
		    
		    const formation = {
		        id: newId,
		        name,
		        my,
		        myPet,
		        enemy,
		        enemyPet,
		        comment,
		        isBase: false,
		        dateAdded: new Date().toISOString()
		    };
		    
		    try {
		        await formationsRef.child(String(newId)).set(formation);
		        showToast(`${t('add.saved')} #${newId}!`);
		        clearAddForm();
		    } catch (error) {
		        showToast(t('common.error') + ': ' + error.message, true);
		    }
		}
        
        function clearAddForm() {
            document.getElementById('add-name').value = '';
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`add-my${i}`).value = '';
                document.getElementById(`add-enemy${i}`).value = '';
            }
            document.getElementById('add-myPet').value = '';
            document.getElementById('add-enemyPet').value = '';
			document.getElementById('add-comment').value = '';
        }
        
        async function deleteFormation(id) {
            const formation = allFormations.find(f => f.id === id);
            
            if (!formation) return;
            
            if (formation.isBase && !isAdmin) {
                showToast(t('common.cannotDeleteBase'), true);
                return;
            }
            
            if (!confirm(`${t('common.confirmDelete')} #${id}: "${formation.name}"?`)) return;
            
            try {
				await formationsRef.child(String(id)).remove();
                showToast(t('common.formationDeleted'));
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        async function deleteAllUserFormations() {
            if (!confirm(t('admin.confirmDeleteAllUser'))) return;
            
            try {
                const userFormations = allFormations.filter(f => !f.isBase);
                for (const f of userFormations) {
					await formationsRef.child(String(f.id)).remove();
                }
                showToast(`${t('admin.deletedUserFormations')}: ${userFormations.length}`);
            } catch (error) {
                showToast(t('common.error') + ': ' + error.message, true);
            }
        }
        
        // ========== IMPORT / EKSPORT CSV ==========
        
        function exportToCSV() {
            const headers = ['Lp','Nazwa','moja1','moja2','moja3','moja4','moja5','moja6','moja7','moja8','mojPet','enemy1','enemy2','enemy3','enemy4','enemy5','enemy6','enemy7','enemy8','enemyPet'];
            
            const rows = allFormations.map(f => [
                f.id,
                `"${f.name || ''}"`,
                ...f.my.map(h => `"${h || ''}"`),
                `"${f.myPet || ''}"`,
                ...f.enemy.map(h => `"${h || ''}"`),
                `"${f.enemyPet || ''}"`
            ].join(';'));
            
            const csv = [headers.join(';'), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TABELA_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`${t('settings.exported')} ${allFormations.length} ${t('status.formations')}`);
        }
        
		async function importFromCSV(event) {
		    const file = event.target.files[0];
		    if (!file) return;
		    
		    if (!isOnline) { showToast(t('common.noConnection'), true); return; }
		    
		    const reader = new FileReader();
		    reader.onload = async (e) => {
		        try {
		            const text = e.target.result;
		            const lines = text.split('\n').filter(l => l.trim());
		            
		            const separator = lines[0].includes(';') ? ';' : ',';
		            
		            let imported = 0;
		            const existingIds = allFormations.map(f => f.id);
		            let maxId = existingIds.length > 0 ? Math.max(...existingIds) : 0;
		            
		            for (let i = 1; i < lines.length; i++) {
		                const values = parseCSVLine(lines[i], separator);
		                if (values.length < 20) continue;
		                
		                const startIdx = values[0].match(/^\d+$/) ? 1 : 0;
		                
		                maxId++;
		                while (existingIds.includes(maxId)) {
		                    maxId++;
		                }
		                existingIds.push(maxId);
		                
		                const formation = {
		                    id: maxId,
		                    name: cleanValue(values[startIdx]),
		                    my: [
		                        cleanValue(values[startIdx + 1]),
		                        cleanValue(values[startIdx + 2]),
		                        cleanValue(values[startIdx + 3]),
		                        cleanValue(values[startIdx + 4]),
		                        cleanValue(values[startIdx + 5]),
		                        cleanValue(values[startIdx + 6]),
		                        cleanValue(values[startIdx + 7]),
		                        cleanValue(values[startIdx + 8])
		                    ],
		                    myPet: cleanValue(values[startIdx + 9]),
		                    enemy: [
		                        cleanValue(values[startIdx + 10]),
		                        cleanValue(values[startIdx + 11]),
		                        cleanValue(values[startIdx + 12]),
		                        cleanValue(values[startIdx + 13]),
		                        cleanValue(values[startIdx + 14]),
		                        cleanValue(values[startIdx + 15]),
		                        cleanValue(values[startIdx + 16]),
		                        cleanValue(values[startIdx + 17])
		                    ],
		                    enemyPet: cleanValue(values[startIdx + 18]),
		                    isBase: false,
		                    dateAdded: new Date().toISOString()
		                };
		                
		                await formationsRef.child(String(formation.id)).set(formation);
		                imported++;
		            }
		            
		            showToast(`${t('settings.imported')} ${imported} ${t('status.formations')}!`);
		        } catch (error) {
		            showToast(t('common.error') + ': ' + error.message, true);
		        }
		    };
		    reader.readAsText(file);
		    event.target.value = '';
		}
        
        function parseCSVLine(line, separator = ';') {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === separator && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        function cleanValue(val) {
            return (val || '').replace(/"/g, '').trim();
        }
        
        function refreshData() {
            location.reload();
        }
        
        // ========== INICJALIZACJA BAZY ==========
	async function initializeBaseData() {
	    if (!isOnline) { showToast(t('common.noConnection'), true); return; }
	    if (!confirm(t('admin.confirmLoadBase'))) return;
	    
	    showToast(t('admin.loadingBase'));
	    
	    const baseFormations = [
	        {id:1,name:"Tobi 18-10-2025 W1",my:["Lupico","","","Richelle","Leovalt","Paopao","Solina",""],myPet:"Silbren",enemy:["Taros","","","","Solina","Roze","Nebula","Lena"],enemyPet:"Romanelle",isBase:true},
	        {id:2,name:"Tobi 18-10-2025 W2",my:["","","Nox","Dmitri","","Roze","Scarlet","Muerte"],myPet:"Hamm",enemy:["Paopao","","","Elara","Benzel","Lupico","Ulion",""],enemyPet:"Silbren",isBase:true},
	        {id:3,name:"Tobi 18-10-2025 W3",my:["","Nuel","","LuLu","Elara","","Akmon","Oneric"],myPet:"Banavi",enemy:["Nuel","","","Richelle","Lilith","Leovalt","Scarlet",""],enemyPet:"Mystet",isBase:true}
	        // ... (skr√≥cone - w pe≈Çnej wersji wszystkie 126)
	    ];
	    
	    try {
	        let count = 0;
	        for (const f of baseFormations) {
	            await formationsRef.child(String(f.id)).set(f);
	            count++;
	        }
	        showToast(`‚úÖ ${t('admin.loadedBase').replace('formacji', count)}`);
	    } catch (error) {
	        showToast(t('common.error') + ': ' + error.message, true);
	    }
	}
		
        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            checkAdminSession();
            applyTranslations();
            
            // Set active lang button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.lang-btn[onclick="setLanguage('${currentLang}')"]`)?.classList.add('active');
            
            document.getElementById('admin-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') tryAdminLogin();
            });
			
		    document.querySelectorAll('#tab-search input[data-type]').forEach(input => {
		        input.addEventListener('keypress', (e) => {
		            if (e.key === 'Enter') searchFormations();
		        });
		    });
		    
		    document.getElementById('lookup-id').addEventListener('keypress', (e) => {
		        if (e.key === 'Enter') lookupById();
		    });
			
			// ≈öledzenie aktywnego pola w formularzu dodawania - event delegation
			const tabAdd = document.getElementById('tab-add');
			if (tabAdd) {
				// Focus - ≈õled≈∫ kt√≥re pole jest aktywne
				tabAdd.addEventListener('focusin', (e) => {
					const field = e.target;
					if (field.tagName === 'INPUT' && field.id.startsWith('add-')) {
						activeAddField = field.id;
						
						// Poka≈º wska≈∫nik aktywnego pola
						const indicator = document.getElementById('active-field-indicator');
						const nameEl = document.getElementById('active-field-name');
						if (indicator && nameEl) {
							const fieldId = field.id.replace('add-', '');
							let fieldName = '';
							
							if (fieldId.startsWith('enemy')) {
								const num = fieldId.replace('enemy', '').replace('Pet', '');
								const isPet = fieldId.includes('Pet');
								if (currentLang === 'en') {
									fieldName = isPet ? 'Enemy Pet' : 'Enemy ' + num;
								} else {
									fieldName = isPet ? 'Przeciwnik Pet' : 'Przeciwnik ' + num;
								}
							} else if (fieldId.startsWith('my')) {
								const num = fieldId.replace('my', '').replace('Pet', '');
								const isPet = fieldId.includes('Pet');
								if (currentLang === 'en') {
									fieldName = isPet ? 'Your Pet' : 'Your ' + num;
								} else {
									fieldName = isPet ? 'Tw√≥j Pet' : 'Tw√≥j ' + num;
								}
							} else {
								fieldName = fieldId;
							}
							
							nameEl.textContent = fieldName;
							indicator.classList.add('show');
							
							// Od≈õwie≈º pod≈õwietlenie tag√≥w przy zmianie sekcji
							updateAddFormTagsSelection();
						}
					}
				});
				
				// Input - aktualizuj tagi przy wpisywaniu
				tabAdd.addEventListener('input', (e) => {
					if (e.target.tagName === 'INPUT' && e.target.id.startsWith('add-')) {
						updateAddFormTagsSelection();
					}
				});
				
				// Enter w formularzu dodawania = zapisz
				tabAdd.addEventListener('keypress', (e) => {
					if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
						e.preventDefault();
						saveFormation();
					}
				});
			}
        });
    </script>
</body>
</html>
