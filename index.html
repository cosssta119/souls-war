<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Souls Online - Wyszukiwarka kontr-formacji na wojnach</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Nunito:wght@400;600;700&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
		:root {
			--bg-dark: #0d0d0d;
			--bg-card: #1a1a1a;
			--bg-input: #252525;
			--accent-gold: #d4af37;
			--accent-red: #8b0000;
			--accent-green: #2e7d32;
			--accent-purple: #6a1b9a;
			--accent-blue: #1e3a5f;
			--text-light: #e8e8e8;
			--text-muted: #888;
			--border: #333;
			--race-dark: #9c27b0;
			--race-light: #ffd54f;
			--race-undead: #78909c;
			--race-elf: #66bb6a;
			--race-fire: #e53935;
			--race-human: #42a5f5;
		}

		/* Jasny motyw - ciepłe kolory */
		[data-theme="light"] {
			--bg-dark: #f8f5f0;
			--bg-card: #ffffff;
			--bg-input: #f0ebe3;
			--accent-gold: #996515;
			--text-light: #2d2a26;
			--text-muted: #6b6560;
			--border: #d4cfc7;
			--race-dark: #7b1fa2;
			--race-light: #c77700;
			--race-undead: #455a64;
			--race-elf: #2e7d32;
			--race-fire: #c62828;
			--race-human: #1565c0;
		}

		[data-theme="light"] body {
			background: linear-gradient(180deg, #f8f5f0 0%, #ebe6dd 100%);
		}

		[data-theme="light"] header {
			background: linear-gradient(180deg, #fffefa 0%, #f8f5f0 100%);
			border-bottom: 2px solid #c9a227;
		}

		[data-theme="light"] header h1 {
			color: #996515;
			text-shadow: none;
		}

		[data-theme="light"] .section {
			background: #ffffff;
			border: 1px solid #d4cfc7;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
		}

		[data-theme="light"] .section h2 {
			color: #996515;
		}

		[data-theme="light"] .bottom-nav {
			background: linear-gradient(180deg, #ffffff 0%, #f8f5f0 100%);
			border-top: 2px solid #c9a227;
			box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.08);
		}

		[data-theme="light"] .nav-btn {
			color: #6b6560;
		}

		[data-theme="light"] .nav-btn.active {
			color: #996515;
			background: rgba(153, 101, 21, 0.1);
		}

		[data-theme="light"] .btn {
			background: linear-gradient(135deg, #c9a227, #996515);
			color: #ffffff;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
		}

		[data-theme="light"] .btn:hover {
			box-shadow: 0 4px 12px rgba(153, 101, 21, 0.3);
		}

		[data-theme="light"] .btn-secondary {
			background: #f0ebe3;
			color: #2d2a26;
			border: 1px solid #d4cfc7;
		}

		[data-theme="light"] .btn-secondary:hover {
			background: #e8e2d8;
			border-color: #996515;
			color: #996515;
		}

		/* Inputy */
		[data-theme="light"] input[type="text"],
		[data-theme="light"] input[type="number"],
		[data-theme="light"] input[type="password"],
		[data-theme="light"] select {
			background: #ffffff;
			border: 1px solid #d4cfc7;
			color: #2d2a26;
		}

		[data-theme="light"] input:focus,
		[data-theme="light"] select:focus {
			border-color: #996515;
			box-shadow: 0 0 0 2px rgba(153, 101, 21, 0.15);
		}

		[data-theme="light"] input::placeholder {
			color: #a09a92;
		}

		/* Sekcja tagów */
		[data-theme="light"] .search-form-tags,
		[data-theme="light"] .add-form-tags {
			background: linear-gradient(135deg, #f8f5f0 0%, #f0ebe3 100%);
			border: 1px solid #d4cfc7;
		}

		[data-theme="light"] .quick-tags-section {
			background: rgba(255, 255, 255, 0.6) !important;
		}

		[data-theme="light"] .quick-tags-section:has(.tag-dark) { background: rgba(123, 31, 162, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-light) { background: rgba(199, 119, 0, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-human) { background: rgba(21, 101, 192, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-fire) { background: rgba(198, 40, 40, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-elf) { background: rgba(46, 125, 50, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-undead) { background: rgba(69, 90, 100, 0.08) !important; }
		[data-theme="light"] .quick-tags-section:has(.tag-pet) { background: rgba(153, 101, 21, 0.08) !important; }

		[data-theme="light"] .quick-tag {
			background: #ffffff;
			border-color: currentColor;
		}

		[data-theme="light"] .quick-tags-header {
			color: #2d2a26;
		}

		/* Formularz wyszukiwania */
		[data-theme="light"] .search-formation-grid {
			background: linear-gradient(180deg, rgba(153, 101, 21, 0.05) 0%, #ffffff 100%);
			border: 1px solid #d4cfc7;
		}

		[data-theme="light"] .search-formation-grid::before {
			background: #f8f5f0;
			border-color: #c9a227;
			color: #996515;
		}

		[data-theme="light"] .search-formation-grid input {
			background: #ffffff !important;
			border: 1px solid #d4cfc7 !important;
			color: #2d2a26;
		}

		[data-theme="light"] .search-formation-grid input:focus {
			border-color: #996515 !important;
			background: #fffefa !important;
			box-shadow: 0 0 8px rgba(212, 175, 55, 0.3) !important;
		}

		[data-theme="light"] .search-formation-grid label {
			color: #996515;
		}

		[data-theme="light"] .search-pet-wrapper {
			background: rgba(153, 101, 21, 0.05);
			border-color: rgba(153, 101, 21, 0.2);
		}

		/* Wyniki i karty */
		[data-theme="light"] .result-card,
		[data-theme="light"] .db-item {
			background: #ffffff;
			border: 1px solid #d4cfc7;
		}
		
		[data-theme="light"] .db-item-date {
			color: #6b6560;
		}

		[data-theme="light"] .result-card:hover,
		[data-theme="light"] .db-item:hover {
			border-color: #996515;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}

		[data-theme="light"] .result-id,
		[data-theme="light"] .db-item-id {
			color: #996515;
		}

		[data-theme="light"] .matched-hero {
			background: rgba(46, 125, 50, 0.15);
			color: #2e7d32;
		}

		/* Podgląd formacji */
		[data-theme="light"] .formation-preview {
			background: linear-gradient(180deg, #ffffff 0%, #f8f5f0 100%);
			border: 1px solid #d4cfc7;
		}

		[data-theme="light"] .battle-section.enemy {
			background: rgba(198, 40, 40, 0.05);
			border-color: rgba(198, 40, 40, 0.2);
		}

		[data-theme="light"] .battle-section.player {
			background: rgba(46, 125, 50, 0.05);
			border-color: rgba(46, 125, 50, 0.2);
		}

		[data-theme="light"] .battle-slot.filled {
			background: linear-gradient(135deg, #ffffff 0%, #f8f5f0 100%);
		}

		[data-theme="light"] .battle-pet.filled {
			background: linear-gradient(135deg, rgba(153, 101, 21, 0.1), rgba(153, 101, 21, 0.05));
			border-color: #996515;
			color: #996515;
		}

		[data-theme="light"] .vs-badge {
			background: rgba(153, 101, 21, 0.1);
			border-color: rgba(153, 101, 21, 0.3);
			color: #996515;
		}

		/* War Planner */
		[data-theme="light"] .war-enemy-section {
			background: rgba(198, 40, 40, 0.04);
			border-color: rgba(198, 40, 40, 0.15);
		}

		[data-theme="light"] .war-result-card {
			background: #ffffff;
			border-color: #d4cfc7;
		}

		[data-theme="light"] .war-result-card.perfect {
			border-color: #2e7d32;
			box-shadow: 0 0 10px rgba(46, 125, 50, 0.15);
		}

		[data-theme="light"] .war-formation-box {
			background: #f8f5f0;
			border-color: #d4cfc7;
		}

		[data-theme="light"] .war-summary-box {
			background: linear-gradient(135deg, rgba(153, 101, 21, 0.08), rgba(153, 101, 21, 0.02));
			border-color: rgba(153, 101, 21, 0.2);
		}

		/* Compact slots */
		[data-theme="light"] .compact-slot.filled {
			background: #ffffff;
		}

		[data-theme="light"] .compact-slot.empty {
			background: rgba(0, 0, 0, 0.03);
			border-color: rgba(0, 0, 0, 0.1);
		}

		[data-theme="light"] .compact-battle-section.enemy {
			background: rgba(198, 40, 40, 0.05);
		}

		[data-theme="light"] .compact-battle-section.player {
			background: rgba(46, 125, 50, 0.05);
		}

		/* Modale i autocomplete */
		[data-theme="light"] .modal-content,
		[data-theme="light"] .quick-select-content {
			background: #ffffff;
			border-color: #c9a227;
		}

		[data-theme="light"] .autocomplete-list {
			background: #ffffff;
			border-color: #c9a227;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		}

		[data-theme="light"] .autocomplete-item:hover {
			background: rgba(153, 101, 21, 0.1);
		}

		/* Toast i loading */
		[data-theme="light"] .toast {
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
		}

		[data-theme="light"] .loading-overlay {
			background: rgba(248, 245, 240, 0.95);
		}

		[data-theme="light"] .spinner {
			border-color: #d4cfc7;
			border-top-color: #996515;
		}

		/* Admin */
		[data-theme="light"] .admin-section {
			border-color: #6a1b9a;
		}

		[data-theme="light"] .info-box {
			background: #f8f5f0;
			border-left-color: #996515;
		}

		[data-theme="light"] .info-box.admin {
			background: rgba(106, 27, 154, 0.05);
			border-left-color: #6a1b9a;
		}

		[data-theme="light"] .entity-list {
			background: #f8f5f0;
		}

		[data-theme="light"] .entity-item {
			border-bottom-color: #d4cfc7;
		}

		/* Filter buttons */
		[data-theme="light"] .filter-btn {
			background: #f0ebe3;
			border-color: #d4cfc7;
			color: #6b6560;
		}

		[data-theme="light"] .filter-btn:hover,
		[data-theme="light"] .filter-btn.active {
			background: #ffffff;
			border-color: #996515;
			color: #996515;
		}

		/* Match info */
		[data-theme="light"] .match-info {
			background: #f8f5f0;
		}

		/* Scrollbar */
		[data-theme="light"] ::-webkit-scrollbar-track {
			background: #f0ebe3;
		}

		[data-theme="light"] ::-webkit-scrollbar-thumb {
			background: #c9a227;
		}
		
		/* Sortowanie */
		[data-theme="light"] .sort-btn {
			background: #f0ebe3;
			border-color: #d4cfc7;
			color: #6b6560;
		}
		[data-theme="light"] .sort-btn:hover {
			border-color: #996515;
			color: #996515;
		}
		[data-theme="light"] .sort-btn.active {
			background: #996515;
			color: #ffffff;
			border-color: #996515;
		}
		
		[data-theme="light"] .preview-meta {
			color: #6b6560;
			border-bottom-color: #d4cfc7;
		}
        
        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
        }
        
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--accent-gold); }
        
        header {
            text-align: center;
            padding: 12px 0;
            border-bottom: 2px solid var(--accent-gold);
            margin-bottom: 15px;
        }
        
        header h1 { font-size: 1.3rem; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3); cursor: pointer; }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.75rem;
        }
        
        .status-item { display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.online { background: #4caf50; }
        .status-dot.offline { background: #f44336; }
        
        .admin-badge { background: var(--accent-purple); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px; }

        .header-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 8px; }
		.lang-switcher { display: flex; gap: 8px; }
		.theme-switcher { display: flex; }
		.theme-btn {
			background: var(--bg-input);
			border: 2px solid var(--border);
			border-radius: 20px;
			cursor: pointer;
			padding: 4px 12px;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			gap: 5px;
		}
		.theme-btn:hover { border-color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
		.theme-icon { font-size: 1rem; transition: transform 0.3s; }
		.theme-btn:hover .theme-icon { transform: rotate(20deg); }
        .lang-btn {
            background: transparent;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 2px 6px;
            opacity: 0.5;
            transition: all 0.2s;
        }
        .lang-btn:hover { opacity: 0.8; }
        .lang-btn.active { opacity: 1; border-color: var(--accent-gold); background: rgba(212, 175, 55, 0.1); }
        
        /* Nawigacja */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--accent-gold);
            display: flex;
            z-index: 100;
        }
        
        .nav-btn {
            flex: 1;
            padding: 10px 5px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.65rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.3s;
        }
        
        .nav-btn span.icon { font-size: 1.2rem; }
        .nav-btn:not(.active):hover { color: var(--accent-gold); }
        .nav-btn.active {
            color: var(--accent-gold);
            background: rgba(212, 175, 55, 0.1);
            border-top: 2px solid var(--accent-gold);
            margin-top: -2px;
        }
        .nav-btn.admin-only { display: none; }
        .nav-btn.admin-only.show { display: flex; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Walidacja */
        input.invalid-hero { border-color: #c62828 !important; box-shadow: 0 0 0 2px rgba(198, 40, 40, 0.3) !important; }
        input.valid-hero { border-color: var(--accent-green) !important; }
        
        /* Sekcje */
        .section {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
        }
        
        .section h2 {
            font-size: 0.95rem;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Inputy */
        .autocomplete-wrapper { position: relative; margin-bottom: 10px; }
        .autocomplete-wrapper label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 3px; }
        
        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        input:focus, select:focus { 
            outline: none; 
            border-color: var(--accent-gold); 
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--accent-gold);
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        
        .autocomplete-list.show { display: block; }
        
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .autocomplete-item:hover { background: rgba(212, 175, 55, 0.2); }
        .autocomplete-item .race { font-size: 0.7rem; color: var(--text-muted); margin-left: 5px; }

        /* Kolorowe podpowiedzi autocomplete */
        .autocomplete-item.race-dark { color: var(--race-dark); }
        .autocomplete-item.race-light { color: var(--race-light); }
        .autocomplete-item.race-human { color: var(--race-human); }
        .autocomplete-item.race-fire { color: var(--race-fire); }
        .autocomplete-item.race-elf { color: var(--race-elf); }
        .autocomplete-item.race-undead { color: var(--race-undead); }
        
        /* Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid .full-width { grid-column: 1 / -1; }
		
		.search-formation-grid {
			padding: 20px 15px;
			background: linear-gradient(180deg, rgba(212, 175, 55, 0.03) 0%, rgba(13, 13, 13, 0.5) 100%);
			border-radius: 15px;
			border: 1px solid rgba(212, 175, 55, 0.15);
			position: relative;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(212, 175, 55, 0.1);
		}
		.search-formation-grid::before {
			content: '⚔️ SKŁAD PRZECIWNIKA';
			position: absolute;
			top: -10px;
			left: 50%;
			transform: translateX(-50%);
			background: var(--bg-card);
			padding: 2px 15px;
			font-size: 0.7rem;
			color: var(--accent-gold);
			border: 1px solid rgba(212, 175, 55, 0.3);
			border-radius: 10px;
			font-family: 'Cinzel', serif;
			letter-spacing: 1px;
		}
		.search-formation-grid .form-row { display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; }
		.search-formation-grid .autocomplete-wrapper { flex: 1; max-width: 120px; margin-bottom: 0; }
		
		.search-formation-grid input {
			padding: 10px 12px;
			font-size: 0.85rem;
			background: rgba(0, 0, 0, 0.4);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 8px;
			transition: all 0.3s;
		}
		.search-formation-grid input:focus {
			background: rgba(212, 175, 55, 0.1) !important;
			border-color: var(--accent-gold) !important;
			box-shadow: 0 0 8px rgba(212, 175, 55, 0.3) !important;
		}

		.search-formation-grid input::placeholder {
			color: rgba(255, 255, 255, 0.3);
		}
		.search-formation-grid label {
			display: block;
			font-size: 0.65rem;
			color: var(--accent-gold);
			margin-bottom: 4px;
			text-align: center;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			opacity: 0.7;
		}
		
		.search-pet-wrapper {
			position: relative;
			padding: 10px;
			background: rgba(212, 175, 55, 0.05);
			border: 1px dashed rgba(212, 175, 55, 0.2);
			border-radius: 12px;
		}
		.search-pet-wrapper input {
			background: rgba(0, 0, 0, 0.3) !important;
			border-color: rgba(212, 175, 55, 0.3) !important;
		}

        /* Badge z numerem */
        .label-badge { display: flex; justify-content: center; margin-bottom: 5px; }
        .label-badge span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--accent-gold);
            border-radius: 15px;
            color: var(--accent-gold);
            font-size: 0.75rem;
            padding: 4px 14px;
            letter-spacing: 0.5px;
        }
        .label-badge.pet-badge span {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), transparent);
        }
                
        /* Przyciski */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-gold), #b8962e);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-input); color: var(--text-light); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .btn-success { background: linear-gradient(135deg, var(--accent-green), #1b5e20); color: white; }
        .btn-danger { background: linear-gradient(135deg, #c62828, #8b0000); color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.8rem; width: auto; margin-top: 0; }
        .btn-admin { background: linear-gradient(135deg, var(--accent-purple), #4a148c); color: white; }
        .btn-favorite-active { background: linear-gradient(135deg, #ffd700, #ffb300) !important; color: #000 !important; }
        
        /* Filtry */
        .filter-bar { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        
        .filter-btn {
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:not(.active):hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        
		/* Sortowanie */
		.sort-bar {
			display: flex;
			align-items: center;
			gap: 5px;
			margin-bottom: 12px;
			flex-wrap: wrap;
		}
		.sort-label {
			font-size: 0.7rem;
			color: var(--text-muted);
			margin-right: 5px;
		}
		.sort-btn {
			padding: 4px 10px;
			background: var(--bg-input);
			border: 1px solid var(--border);
			border-radius: 12px;
			color: var(--text-muted);
			font-size: 0.7rem;
			cursor: pointer;
			transition: all 0.2s;
		}
		.sort-btn:hover {
			border-color: var(--accent-gold);
			color: var(--accent-gold);
		}
		.sort-btn.active {
			background: var(--accent-gold);
			color: var(--bg-dark);
			border-color: var(--accent-gold);
			font-weight: 600;
		}
		
        .search-input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        
        .search-counter {
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-light);
            margin: 10px 0;
            padding: 8px 15px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            display: inline-block;
        }
        .search-counter strong { color: var(--accent-gold); font-size: 0.9rem; }
        
        /* Wyniki */
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .results-header h3 { font-size: 0.9rem; }
        .results-count { font-size: 0.8rem; color: var(--text-muted); }
        
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card:hover { 
            border-color: var(--accent-gold); 
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2);
        }
        
        .result-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .result-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.85rem; }
        
        .match-score { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .match-6, .match-5 { background: #2e7d32; }
        .match-4 { background: #f9a825; color: #000; }
        .match-3 { background: #ef6c00; }
        .match-2 { background: #c62828; }
        .match-1 { background: #757575; }
        
        .result-name { font-size: 0.9rem; margin-bottom: 5px; }
        .result-heroes { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }
        .matched-hero { 
            color: #4caf50; 
            font-weight: 600;
            background: rgba(76, 175, 80, 0.15);
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .result-missing { 
            font-size: 0.7rem; 
            color: #ef5350; 
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed var(--border);
        }
        
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 3px; margin-left: 5px; }
        .user-badge { background: var(--accent-purple); color: white; }
        .base-badge { background: var(--accent-blue); color: white; }
        
        /* Quick Tags */
		/* Kolorowe tła dla sekcji ras */
		.quick-tags-section {
			margin-bottom: 3px;
			border-radius: 6px;
			padding: 4px 6px;
			transition: background 0.3s;
		}
		.quick-tags-section:has(.tag-dark) { background: rgba(156, 39, 176, 0.05); border-left: 2px solid var(--race-dark); }
		.quick-tags-section:has(.tag-light) { background: rgba(255, 213, 79, 0.05); border-left: 2px solid var(--race-light); }
		.quick-tags-section:has(.tag-human) { background: rgba(66, 165, 245, 0.05); border-left: 2px solid var(--race-human); }
		.quick-tags-section:has(.tag-fire) { background: rgba(229, 57, 53, 0.05); border-left: 2px solid var(--race-fire); }
		.quick-tags-section:has(.tag-elf) { background: rgba(102, 187, 106, 0.05); border-left: 2px solid var(--race-elf); }
		.quick-tags-section:has(.tag-undead) { background: rgba(120, 144, 156, 0.05); border-left: 2px solid var(--race-undead); }
		.quick-tags-section:has(.tag-pet) { background: rgba(212, 175, 55, 0.05); border-left: 2px solid var(--accent-gold); }
        
		.quick-tags-header {
			font-size: 0.65rem;
			color: var(--text-light);
			padding: 2px 6px;
			font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-input);
            border-radius: 4px;
            transition: all 0.2s;
            user-select: none;
        }
        .quick-tags-header:hover { background: var(--bg-card); color: var(--accent-gold); }
        .quick-tags-header .toggle-icon { font-size: 0.6rem; transition: transform 0.2s; }
        .quick-tags-header.expanded .toggle-icon { transform: rotate(90deg); }
        .quick-tags-content { display: none; padding: 2px 0 1px 0; }
        .quick-tags-content.show { display: block; }
        .quick-tags { display: flex; flex-wrap: wrap; gap: 3px; justify-content: center; }

        .quick-tag {
            padding: 2px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-tag:hover { transform: scale(1.05); }
        .quick-tag.tag-dark { border-color: var(--race-dark); color: var(--race-dark); }
        .quick-tag.tag-light { border-color: var(--race-light); color: var(--race-light); }
        .quick-tag.tag-human { border-color: var(--race-human); color: var(--race-human); }
        .quick-tag.tag-fire { border-color: var(--race-fire); color: var(--race-fire); }
        .quick-tag.tag-elf { border-color: var(--race-elf); color: var(--race-elf); }
        .quick-tag.tag-undead { border-color: var(--race-undead); color: var(--race-undead); }
        .quick-tag.tag-pet { border-color: var(--accent-gold); color: var(--accent-gold); }
        .quick-tag.tag-dark:hover { background: var(--race-dark); color: white; }
        .quick-tag.tag-light:hover { background: var(--race-light); color: #000; }
        .quick-tag.tag-human:hover { background: var(--race-human); color: white; }
        .quick-tag.tag-fire:hover { background: var(--race-fire); color: white; }
        .quick-tag.tag-elf:hover { background: var(--race-elf); color: white; }
        .quick-tag.tag-undead:hover { background: var(--race-undead); color: white; }
        .quick-tag.tag-pet:hover { background: var(--accent-gold); color: #000; }
        .quick-tag.selected { background: var(--accent-gold) !important; color: #000 !important; border-color: var(--accent-gold) !important; }

        .quick-tags-expand-all { text-align: center; margin-bottom: 6px; }
        .expand-all-btn {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: none;
            border: 1px dashed var(--border);
            padding: 3px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .expand-all-btn:hover { border-color: var(--accent-gold); color: var(--accent-gold); }

        /* Quick Select Modal */
        .quick-select-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            padding: 15px;
            opacity: 1;
            transition: opacity 0.2s;
        }
        .quick-select-modal.hidden { opacity: 0; pointer-events: none; }
        .quick-select-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            max-width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--accent-gold);
            width: 400px;
            transform: scale(1);
            transition: transform 0.2s;
        }
        .quick-select-modal.hidden .quick-select-content { transform: scale(0.95); }
        .quick-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .quick-select-header h3 { font-size: 0.9rem; color: var(--accent-gold); }
        .quick-select-close { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; }
        .quick-select-close:hover { color: var(--accent-gold); }
        .quick-select-target {
            text-align: center;
            margin-bottom: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8rem;
        }
        .quick-select-target strong { color: var(--accent-gold); }
        
        .quick-pick {
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.2s;
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .quick-pick:hover { opacity: 1; background: rgba(212, 175, 55, 0.2); transform: scale(1.1); }
        
        /* Form tags */
		.search-form-tags {
			margin-bottom: 15px;
			padding: 8px 10px;
			background: linear-gradient(135deg, rgba(26, 26, 26, 0.8) 0%, rgba(37, 37, 37, 0.5) 100%);
			border-radius: 10px;
			border: 1px solid rgba(255, 255, 255, 0.05);
		}
        .active-field-indicator {
            text-align: center;
            font-size: 0.7rem;
            color: var(--accent-gold);
            margin-bottom: 8px;
            padding: 4px 10px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            display: none;
        }
        .active-field-indicator.show { display: block; }
        
        /* Podgląd formacji */
        .formation-preview {
            background: linear-gradient(180deg, #0a0a0a 0%, #151515 100%);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .preview-title { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.95rem; }
        .preview-title .preview-id {
            background: var(--bg-input);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 8px;
        }
        .preview-actions { display: flex; gap: 8px; }
        .preview-actions .btn { padding: 10px 18px; font-size: 1rem; margin: 0; }

		.preview-meta {
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
			font-size: 0.7rem;
			color: var(--text-muted);
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 1px dashed var(--border);
		}

		.preview-meta-item {
			display: flex;
			align-items: center;
			gap: 5px;
		}

        .battle-section { border-radius: 12px; padding: 15px; position: relative; margin-bottom: 0; }
        .battle-section.enemy {
            background: rgba(139, 0, 0, 0.06);
            border: 1px solid rgba(139, 0, 0, 0.2);
        }
        .battle-section.enemy::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #8b0000, transparent);
        }
        .battle-section.player {
            background: rgba(46, 125, 50, 0.06);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }
        .battle-section.player::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #2e7d32, transparent);
        }

        .battle-title {
            text-align: center;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 2px;
        }
        .battle-title.enemy-title { color: #f44336; }
        .battle-title.player-title { color: #4caf50; }
        .battle-title .title-icon { font-size: 1.3rem; }

        .battle-grid { display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .battle-row { display: flex; gap: 8px; justify-content: center; }

        .battle-slot {
            width: 75px;
            height: 42px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            text-align: center;
            padding: 4px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .battle-slot.empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.15);
        }
        .battle-slot.empty::after { content: '—'; font-size: 1rem; opacity: 0.3; }
        .battle-slot.filled {
            background: linear-gradient(135deg, #1a1a1a 0%, #252525 100%);
            border: 2px solid;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .battle-slot.filled:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); }

        .battle-slot.race-dark { border-color: var(--race-dark); box-shadow: 0 2px 8px rgba(156, 39, 176, 0.2), inset 0 0 20px rgba(156, 39, 176, 0.1); }
        .battle-slot.race-dark .hero-name { color: var(--race-dark); }
        .battle-slot.race-light { border-color: var(--race-light); box-shadow: 0 2px 8px rgba(255, 213, 79, 0.2), inset 0 0 20px rgba(255, 213, 79, 0.1); }
        .battle-slot.race-light .hero-name { color: var(--race-light); }
        .battle-slot.race-human { border-color: var(--race-human); box-shadow: 0 2px 8px rgba(66, 165, 245, 0.2), inset 0 0 20px rgba(66, 165, 245, 0.1); }
        .battle-slot.race-human .hero-name { color: var(--race-human); }
        .battle-slot.race-fire { border-color: var(--race-fire); box-shadow: 0 2px 8px rgba(229, 57, 53, 0.2), inset 0 0 20px rgba(229, 57, 53, 0.1); }
        .battle-slot.race-fire .hero-name { color: var(--race-fire); }
        .battle-slot.race-elf { border-color: var(--race-elf); box-shadow: 0 2px 8px rgba(102, 187, 106, 0.2), inset 0 0 20px rgba(102, 187, 106, 0.1); }
        .battle-slot.race-elf .hero-name { color: var(--race-elf); }
        .battle-slot.race-undead { border-color: var(--race-undead); box-shadow: 0 2px 8px rgba(120, 144, 156, 0.2), inset 0 0 20px rgba(120, 144, 156, 0.1); }
        .battle-slot.race-undead .hero-name { color: var(--race-undead); }

        .battle-pet {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        .battle-pet.empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.15);
            color: var(--text-muted);
        }
        .battle-pet.filled {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.05));
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            font-weight: 600;
        }
        .battle-pet .pet-icon { font-size: 1rem; }

        .battle-arrows { display: flex; justify-content: center; align-items: center; padding: 8px 0; gap: 15px; }
        .battle-arrow { width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; }
        .battle-arrow.down { border-top: 12px solid rgba(244, 67, 54, 0.6); }
        .battle-arrow.up { border-bottom: 12px solid rgba(76, 175, 80, 0.6); }

        @keyframes arrowPulse {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(3px); }
        }
        @keyframes arrowPulseUp {
            0%, 100% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-3px); }
        }
        .battle-arrows.animated .battle-arrow.down { animation: arrowPulse 1.5s ease-in-out infinite; }
        .battle-arrows.animated .battle-arrow.up { animation: arrowPulseUp 1.5s ease-in-out infinite; }

        .vs-separator { display: flex; align-items: center; justify-content: center; padding: 10px 0; position: relative; }
        .vs-separator::before, .vs-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border), transparent);
        }
        .vs-badge {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-gold);
            padding: 5px 15px;
            background: radial-gradient(ellipse at center, rgba(212, 175, 55, 0.15) 0%, transparent 70%);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 20px;
            margin: 0 15px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            position: relative;
        }
        .vs-badge::before { content: '⚔️'; position: absolute; left: -18px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; }
        .vs-badge::after { content: '⚔️'; position: absolute; right: -18px; top: 50%; transform: translateY(-50%) scaleX(-1); font-size: 0.75rem; }

        .preview-comment {
            margin-top: 15px;
            padding: 12px 15px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08), rgba(212, 175, 55, 0.02));
            border-radius: 10px;
            border-left: 3px solid var(--accent-gold);
            font-size: 0.8rem;
            color: var(--text-light);
        }
        .preview-comment .comment-icon { color: var(--accent-gold); margin-right: 8px; }

        .formation-type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .formation-type-badge.base { background: rgba(30, 58, 95, 0.5); color: #64b5f6; border: 1px solid rgba(100, 181, 246, 0.3); }
        .formation-type-badge.user { background: rgba(106, 27, 154, 0.3); color: #ce93d8; border: 1px solid rgba(206, 147, 216, 0.3); }
        
        /* ID Lookup */
        .id-lookup { display: flex; gap: 10px; margin-bottom: 15px; }
        .id-lookup input { flex: 1; }
        .id-lookup .btn { width: auto; padding: 12px 20px; margin-top: 0; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state p { font-size: 0.9rem; }
        
        /* Add form */
        .add-form-section { margin-bottom: 15px; }
        .add-form-section h3 { 
            font-size: 0.8rem; 
            color: var(--text-muted); 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }
        .form-row { display: flex; gap: 6px; margin-bottom: 6px; }
        .form-row .autocomplete-wrapper { flex: 1; margin-bottom: 0; }

        @media (min-width: 768px) {
            .add-formations-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .add-form-section { margin-bottom: 0; }
        }

        #tab-add input[type="text"] { padding: 8px 10px; font-size: 0.85rem; }
        #tab-add .autocomplete-wrapper label { font-size: 0.7rem; margin-bottom: 2px; }
		
		/* Modal edycji */
		#edit-modal .modal-content {
			max-width: 500px;
		}
		#edit-modal .form-row {
			gap: 5px;
			margin-bottom: 5px;
		}
		#edit-modal .autocomplete-wrapper {
			margin-bottom: 5px;
		}
		#edit-modal input[type="text"] {
			padding: 8px 10px;
			font-size: 0.85rem;
		}
		#edit-modal .add-form-section h3 {
			font-size: 0.75rem;
			margin-bottom: 8px;
		}
        
        /* Stats */
        .stats-bar { display: flex; justify-content: space-around; padding: 10px; background: var(--bg-input); border-radius: 8px; margin-bottom: 15px; }
        .stat-item { text-align: center; }
        .stat-value { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--accent-gold); }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); }
        
        /* Database list */
        .database-list { max-height: 60vh; overflow-y: auto; }
        
		.db-item {
			display: flex;
			justify-content: space-between;
			align-items: flex-start;
			padding: 8px 10px;
			background: var(--bg-input);
			border-radius: 6px;
			margin-bottom: 6px;
			cursor: pointer;
			transition: all 0.3s;
			border: 1px solid transparent;
			animation: fadeIn 0.3s ease;
		}
        
        .db-item:hover { 
            border-color: var(--accent-gold); 
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
        }
        .db-item-info { flex: 1; }
		.db-item-id { font-family: 'Cinzel', serif; color: var(--accent-gold); font-size: 0.75rem; }
		.db-item-name { font-size: 0.8rem; }
		.db-item-details { font-size: 0.65rem; color: var(--text-muted); line-height: 1.3; }
		.db-item-header { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .db-item-actions { display: flex; gap: 5px; margin-left: 10px; }
        .db-item-date {
			font-size: 0.65rem;
			color: var(--text-muted);
			white-space: nowrap;
			padding: 0 10px;
			align-self: center;
		}
        /* Info box */
        .info-box {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            border-left: 3px solid var(--accent-gold);
        }
        .info-box strong { color: var(--accent-gold); }
        .info-box.admin { border-left-color: var(--accent-purple); background: rgba(106, 27, 154, 0.1); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            max-width: 90%;
        }
        .toast.show { opacity: 1; }
        .toast.error { background: #c62828; }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            flex-direction: column;
            gap: 15px;
        }
        .loading-overlay.hidden { display: none; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Admin panel */
        .admin-section { border: 2px solid var(--accent-purple); }
        .admin-section h2 { color: var(--accent-purple); }
        
        .entity-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        .entity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .entity-item:last-child { border-bottom: none; }
        .entity-name { flex: 1; }
        
        .add-entity-form { display: flex; gap: 8px; margin-top: 10px; }
        .add-entity-form input, .add-entity-form select { flex: 1; }
        .add-entity-form .btn { width: auto; margin-top: 0; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 400;
            padding: 20px;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            border: 2px solid var(--accent-gold);
        }
        .modal-content h2 { text-align: center; margin-bottom: 20px; }
        
        /* Responsive */
        @media (max-width: 400px) {
            .battle-slot { width: 62px; height: 38px; font-size: 0.6rem; }
            .battle-row { gap: 5px; }
            .preview-header { flex-direction: column; gap: 10px; }
            .preview-title { font-size: 0.85rem; }
            .battle-title { font-size: 0.95rem; }
        }
        @media (max-width: 420px) {
            .quick-select-content { width: 100%; padding: 12px; max-height: 85vh; }
            .quick-select-header h3 { font-size: 0.85rem; }
        }
        @media (max-width: 360px) {
            .form-row { flex-direction: column; }
            .nav-btn { font-size: 0.6rem; }
            .nav-btn span.icon { font-size: 1rem; }
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        
        /* War Planner */
        .war-planner-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 768px) { .war-planner-grid { grid-template-columns: 1fr; } }
        
        .war-enemy-section {
            background: rgba(139, 0, 0, 0.1);
            border: 1px solid rgba(139, 0, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
        }
        .war-enemy-title {
            font-size: 0.85rem;
            color: #f44336;
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(139, 0, 0, 0.3);
        }
		.war-enemy-grid { display: flex; flex-direction: column; gap: 4px; align-items: center; }
		.war-row { display: flex; gap: 3px; justify-content: center; }
		.war-row .autocomplete-wrapper { margin-bottom: 0; width: 70px; }
		.war-row input { padding: 6px 4px; font-size: 0.7rem; text-align: center; }
		.war-pet-row .autocomplete-wrapper { width: 100px; }
		.war-pet-row input { font-size: 0.65rem; }
        
        .war-result-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            animation: fadeIn 0.3s ease;
        }
        .war-result-card.perfect { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(46, 125, 50, 0.3); }
        .war-result-card.good { border-color: var(--accent-gold); }
        .war-result-card.conflicts { border-color: #ef6c00; }
        
        .war-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        .war-result-rank { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--accent-gold); }
        .war-conflict-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .war-conflict-badge.perfect { background: var(--accent-green); color: white; }
        .war-conflict-badge.good { background: var(--accent-gold); color: #000; }
        .war-conflict-badge.bad { background: #ef6c00; color: white; }
        
        .war-formations-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (max-width: 768px) { .war-formations-grid { grid-template-columns: 1fr; } }
        
        .war-formation-box {
            background: var(--bg-input);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border);
        }
        .war-formation-box h4 {
            font-size: 0.75rem;
            color: var(--accent-gold);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .war-formation-box .formation-id { font-size: 0.65rem; color: var(--text-muted); }
        .war-formation-box .heroes-list { font-size: 0.75rem; color: var(--text-light); line-height: 1.5; }
        .war-formation-box .hero-conflict { color: #ff5722; font-weight: 700; background: rgba(255, 87, 34, 0.2); padding: 1px 4px; border-radius: 3px; }
        .war-formation-box .pet-info { font-size: 0.7rem; color: var(--accent-gold); margin-top: 5px; }
        
        .war-vs-enemy { font-size: 0.65rem; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); }
        .war-match-score { font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .war-match-score.high { background: var(--accent-green); color: white; }
        .war-match-score.medium { background: var(--accent-gold); color: #000; }
        .war-match-score.low { background: #757575; color: white; }
		/* War Summary Box */
		.war-summary-box {
			background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(212, 175, 55, 0.02));
			border: 1px solid rgba(212, 175, 55, 0.3);
			border-radius: 12px;
			padding: 15px;
			margin-bottom: 15px;
			text-align: center;
		}
		.war-summary-box h3 { font-size: 1rem; margin-bottom: 12px; }
		.war-summary-stats { display: flex; justify-content: center; gap: 25px; margin-bottom: 12px; }
		.war-stat { display: flex; flex-direction: column; align-items: center; }
		.war-stat-value { font-family: 'Cinzel', serif; font-size: 1.3rem; color: var(--accent-gold); }
		.war-stat-value.green { color: #4caf50; }
		.war-stat-value.orange { color: #ff9800; }
		.war-stat-label { font-size: 0.7rem; color: var(--text-muted); }
		.war-legend { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
		.legend-item { font-size: 0.7rem; color: var(--text-muted); display: flex; align-items: center; gap: 5px; }
		.legend-item .dot { width: 10px; height: 10px; border-radius: 50%; }
		.legend-item .dot.green { background: #4caf50; }
		.legend-item .dot.yellow { background: #ffc107; }
		.legend-item .dot.orange { background: #ff9800; }

		/* War Result Badges */
		.war-result-badges { display: flex; gap: 8px; align-items: center; }
		.war-score-badge {
			padding: 3px 10px;
			border-radius: 12px;
			font-size: 0.75rem;
			font-weight: 600;
		}
		.war-score-badge.high { background: rgba(76, 175, 80, 0.2); color: #4caf50; border: 1px solid #4caf50; }
		.war-score-badge.medium { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
		.war-score-badge.low { background: rgba(255, 152, 0, 0.2); color: #ff9800; border: 1px solid #ff9800; }

		/* War Match Bar */
		.war-match-bar {
			height: 4px;
			background: var(--bg-dark);
			border-radius: 2px;
			overflow: hidden;
			margin-bottom: 5px;
		}
		.war-match-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
		.war-match-fill.high { background: #4caf50; }
		.war-match-fill.medium { background: #ffc107; }
		.war-match-fill.low { background: #ff9800; }

		/* War Conflicts Summary */
		.war-conflicts-summary {
			margin-top: 12px;
			padding: 10px;
			background: rgba(255, 87, 34, 0.1);
			border: 1px dashed rgba(255, 87, 34, 0.3);
			border-radius: 8px;
			font-size: 0.75rem;
			color: var(--text-muted);
		}
		.conflict-hero {
			color: #ff5722;
			font-weight: 700;
			background: rgba(255, 87, 34, 0.2);
			padding: 2px 6px;
			border-radius: 4px;
			margin: 0 2px;
		}
        
        /* War Preview - kompaktowy podgląd */
        .war-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 900px) { .war-preview-grid { grid-template-columns: 1fr; } }
        
        .war-preview-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
        }
        .war-preview-card h3 {
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
		
		#war-autosave-info {
			opacity: 0.7;
			transition: opacity 0.3s;
		}
		#war-autosave-info:hover {
			opacity: 1;
		}
		
		#tab-search .btn {
			position: relative;
			overflow: hidden;
		}
		#tab-search .btn::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			background: rgba(255, 255, 255, 0.2);
			border-radius: 50%;
			transform: translate(-50%, -50%);
			transition: width 0.4s, height 0.4s;
		}
		#tab-search .btn:hover::after {
			width: 300px;
			height: 300px;
		}
				
        .compact-battle-section {
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 8px;
        }
        .compact-battle-section.enemy {
            background: rgba(139, 0, 0, 0.08);
            border: 1px solid rgba(139, 0, 0, 0.2);
        }
        .compact-battle-section.player {
            background: rgba(46, 125, 50, 0.08);
            border: 1px solid rgba(46, 125, 50, 0.2);
        }
        
        .compact-battle-title {
            font-size: 0.7rem;
            text-align: center;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .compact-battle-title.enemy { color: #f44336; }
        .compact-battle-title.player { color: #4caf50; }
        
        .compact-grid { display: flex; flex-direction: column; align-items: center; gap: 3px; }
        .compact-row { display: flex; gap: 4px; justify-content: center; }
        
        .compact-slot {
			width: 50px;
			height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            text-align: center;
            padding: 2px;
        }
        .compact-slot.empty {
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }
        .compact-slot.filled {
            background: var(--bg-input);
            border: 1px solid;
            font-weight: 600;
        }
        .compact-slot.matched { background: rgba(76, 175, 80, 0.2) !important; }
        .compact-slot.conflict { background: rgba(255, 87, 34, 0.2) !important; border-color: #ff5722 !important; }
        
        .compact-pet {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.6rem;
            margin: 5px 0;
        }
        .compact-pet.empty { background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.1); color: var(--text-muted); }
        .compact-pet.filled { background: rgba(212,175,55,0.1); border: 1px solid var(--accent-gold); color: var(--accent-gold); }
        
        .compact-vs { text-align: center; font-size: 0.7rem; color: var(--accent-gold); margin: 5px 0; }
        
        .match-info {
            margin-top: 10px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 6px;
            font-size: 0.65rem;
        }
        .match-info .matched { color: #4caf50; }
        .match-info .missing { color: #ef5350; }
        .match-info .label { color: var(--text-muted); margin-right: 5px; }
    </style>
	
	<!-- Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-XX1PXS6V13"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	  gtag('config', 'G-XX1PXS6V13');
	</script>
</head>
<body>
	<div class="modal" id="guild-password-modal">
		<div class="modal-content">
			<h2>🔐 <span data-i18n="guild.title">Strona gildii</span></h2>
			<p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.85rem;" data-i18n="guild.enterPassword">Wpisz hasło gildii aby wejść</p>
			<input type="password" id="guild-password" data-i18n-placeholder="guild.passwordPlaceholder" placeholder="Hasło gildii..." style="margin-bottom: 10px;">
			<button class="btn" onclick="tryGuildLogin()" data-i18n="guild.enter">WEJDŹ</button>
			<p id="guild-error" style="color: #ef5350; text-align: center; margin-top: 10px; font-size: 0.8rem; display: none;"></p>
		</div>
	</div>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="color: var(--accent-gold);" data-i18n="loading">Ładowanie danych...</div>
    </div>
    
    <div class="modal hidden" id="admin-modal">
        <div class="modal-content">
            <h2>🔐 <span data-i18n="admin.title">Panel Administratora</span></h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 20px; font-size: 0.85rem;" data-i18n="admin.enterPassword">Wpisz hasło administratora</p>
            <input type="password" id="admin-password" data-i18n-placeholder="admin.passwordPlaceholder" placeholder="Hasło..." style="margin-bottom: 10px;">
            <button class="btn btn-admin" onclick="tryAdminLogin()" data-i18n="admin.login">ZALOGUJ</button>
            <button class="btn btn-secondary" onclick="closeAdminModal()" data-i18n="common.cancel">Anuluj</button>
        </div>
    </div>

    <header>
        <h1 onclick="headerClick()">⚔️ SOULS ONLINE ⚔️</h1>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 3px;">
            <span data-i18n="header.subtitle">Wyszukiwarka kontr-formacji</span>
            <span class="admin-badge" id="admin-badge" style="display: none;">ADMIN</span>
        </p>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Łączenie...</span>
            </div>
            <div class="status-item">
                <span>📊 <span id="total-count">0</span> <span data-i18n="status.formations">formacji</span></span>
            </div>
        </div>
		<div class="header-controls">
			<div class="lang-switcher">
				<button class="lang-btn active" onclick="setLanguage('pl')" title="Polski">🇵🇱</button>
				<button class="lang-btn" onclick="setLanguage('en')" title="English">🇬🇧</button>
			</div>
			<div class="theme-switcher">
				<button class="theme-btn" id="theme-toggle" onclick="toggleTheme()" title="Zmień motyw">
					<span class="theme-icon">🌙</span>
				</button>
			</div>
		</div>
    </header>
    
    <!-- Tab: Wyszukiwarka -->
    <div id="tab-search" class="tab-content active">
        <div class="section">
            <h2>🔍 <span data-i18n="search.title">Szukaj kontr-formacji</span></h2>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;" data-i18n="search.subtitle">
                Wpisz skład przeciwnika (lub wybierz tagami)
            </p>
            
            <div class="search-form-tags">
                <div id="quick-tags-container">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.75rem;" data-i18n="common.loading">Ładowanie...</div>
                </div>
            </div>
            
			<div class="search-formation-grid">
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 1</label><input type="text" id="search-pos1" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos1"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 2</label><input type="text" id="search-pos2" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos2"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 3</label><input type="text" id="search-pos3" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos3"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 4</label><input type="text" id="search-pos4" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos4"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 5</label><input type="text" id="search-pos5" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos5"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 6</label><input type="text" id="search-pos6" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos6"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 7</label><input type="text" id="search-pos7" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos7"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 8</label><input type="text" id="search-pos8" placeholder="Hero" autocomplete="off" data-type="hero"><div class="autocomplete-list" id="list-search-pos8"></div></div>
				</div>
				<div class="autocomplete-wrapper search-pet-wrapper" style="max-width: 200px; margin: 15px auto 0;">
					<label>🐾 Pet</label>
					<input type="text" id="search-pet" placeholder="Pet" autocomplete="off" data-type="pet">
					<div class="autocomplete-list" id="list-search-pet"></div>
				</div>
			</div>
            
            <button class="btn" onclick="searchFormations()">🔍 <span data-i18n="search.btn">SZUKAJ</span></button>
            <button class="btn btn-secondary" onclick="clearSearch()" style="margin-top: 8px;">✖ <span data-i18n="search.clear">Wyczyść</span></button>
        </div>
        
        <div id="results-section">
            <div class="empty-state">
                <p data-i18n="search.emptyState">Wpisz postacie przeciwnika i kliknij "Szukaj"</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Baza danych -->
    <div id="tab-database" class="tab-content">
        <div class="section">
            <h2>📚 <span data-i18n="database.title">Pełna baza formacji</span></h2>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-total">0</div>
                    <div class="stat-label" data-i18n="database.statsAll">Wszystkich</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-base">0</div>
                    <div class="stat-label" data-i18n="database.statsBase">Bazowych</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="db-stat-user">0</div>
                    <div class="stat-label" data-i18n="database.statsUser">Dodanych</div>
                </div>
            </div>
            
			<div class="filter-bar">
				<button class="filter-btn active" data-filter="all" onclick="setDbFilter('all')" data-i18n="database.filterAll">Wszystkie</button>
				<button class="filter-btn" data-filter="base" onclick="setDbFilter('base')" data-i18n="database.filterBase">Bazowe</button>
				<button class="filter-btn" data-filter="user" onclick="setDbFilter('user')" data-i18n="database.filterUser">Dodane</button>
				<button class="filter-btn" data-filter="favorites" onclick="setDbFilter('favorites')">⭐ <span data-i18n="database.filterFavorites">Ulubione</span></button>
				<input type="text" class="search-input" id="db-search" data-i18n-placeholder="database.searchPlaceholder" placeholder="🔍 Szukaj..." oninput="filterDatabase()">
			</div>

			<div class="sort-bar">
				<span class="sort-label" data-i18n="database.sortLabel">Sortuj:</span>
				<button class="sort-btn active" data-sort="id-asc" onclick="setDbSort('id-asc')" title="ID rosnąco">ID ↑</button>
				<button class="sort-btn" data-sort="id-desc" onclick="setDbSort('id-desc')" title="ID malejąco">ID ↓</button>
				<button class="sort-btn" data-sort="name-asc" onclick="setDbSort('name-asc')" title="Nazwa A-Z">A-Z</button>
				<button class="sort-btn" data-sort="name-desc" onclick="setDbSort('name-desc')" title="Nazwa Z-A">Z-A</button>
				<button class="sort-btn" data-sort="date-desc" onclick="setDbSort('date-desc')" title="Najnowsze">🕐 ↓</button>
				<button class="sort-btn" data-sort="date-asc" onclick="setDbSort('date-asc')" title="Najstarsze">🕐 ↑</button>
			</div>
            
            <div id="database-list" class="database-list"></div>
        </div>
    </div>
    
    <!-- Tab: Podgląd -->
    <div id="tab-view" class="tab-content">
        <div class="section">
            <h2>👁️ <span data-i18n="preview.title">Podgląd formacji</span></h2>
            <div class="id-lookup">
                <input type="number" id="lookup-id" data-i18n-placeholder="preview.idPlaceholder" placeholder="Wpisz ID (np. 12)">
                <button class="btn" onclick="lookupById()" data-i18n="preview.showBtn">POKAŻ</button>
            </div>
        </div>
        
        <div id="formation-display">
            <div class="empty-state">
                <p data-i18n="preview.emptyState">Wpisz ID aby zobaczyć układ formacji</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Dodaj -->
    <div id="tab-add" class="tab-content">
        <div class="section">
            <h2>➕ <span data-i18n="add.title">Dodaj nową formację</span></h2>
            
            <div class="add-form-tags">
                <div class="active-field-indicator" id="active-field-indicator">
                    <span data-i18n="quickSelect.selectFor">Wybierz dla</span>: <strong id="active-field-name">—</strong>
                </div>
                <div id="add-form-tags-container"></div>
            </div>
            
            <div class="autocomplete-wrapper full-width" style="margin-bottom: 15px;">
                <label data-i18n="add.nameLabel">Nazwa formacji</label>
                <input type="text" id="add-name" data-i18n-placeholder="add.namePlaceholder" placeholder="np. Nick 01-01-2026 W1 / Kontra Dark-Undead v1">
            </div>
            
			<div class="add-formations-grid">    
				<div class="add-form-section">
					<h3>👹 <span data-i18n="add.enemyTeam">Skład przeciwnika</span></h3>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 1 <span class="quick-pick" onclick="openQuickSelect('add-enemy1', 'Przeciwnik Poz 1')">🏷️</span></label><input type="text" id="add-enemy1" data-type="hero"><div class="autocomplete-list" id="list-add-enemy1"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 2 <span class="quick-pick" onclick="openQuickSelect('add-enemy2', 'Przeciwnik Poz 2')">🏷️</span></label><input type="text" id="add-enemy2" data-type="hero"><div class="autocomplete-list" id="list-add-enemy2"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 3 <span class="quick-pick" onclick="openQuickSelect('add-enemy3', 'Przeciwnik Poz 3')">🏷️</span></label><input type="text" id="add-enemy3" data-type="hero"><div class="autocomplete-list" id="list-add-enemy3"></div></div>
					</div>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 4 <span class="quick-pick" onclick="openQuickSelect('add-enemy4', 'Przeciwnik Poz 4')">🏷️</span></label><input type="text" id="add-enemy4" data-type="hero"><div class="autocomplete-list" id="list-add-enemy4"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 5 <span class="quick-pick" onclick="openQuickSelect('add-enemy5', 'Przeciwnik Poz 5')">🏷️</span></label><input type="text" id="add-enemy5" data-type="hero"><div class="autocomplete-list" id="list-add-enemy5"></div></div>
					</div>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 6 <span class="quick-pick" onclick="openQuickSelect('add-enemy6', 'Przeciwnik Poz 6')">🏷️</span></label><input type="text" id="add-enemy6" data-type="hero"><div class="autocomplete-list" id="list-add-enemy6"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 7 <span class="quick-pick" onclick="openQuickSelect('add-enemy7', 'Przeciwnik Poz 7')">🏷️</span></label><input type="text" id="add-enemy7" data-type="hero"><div class="autocomplete-list" id="list-add-enemy7"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 8 <span class="quick-pick" onclick="openQuickSelect('add-enemy8', 'Przeciwnik Poz 8')">🏷️</span></label><input type="text" id="add-enemy8" data-type="hero"><div class="autocomplete-list" id="list-add-enemy8"></div></div>
					</div>
					<div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
						<label>Pet <span class="quick-pick" onclick="openQuickSelect('add-enemyPet', 'Przeciwnik Pet')">🏷️</span></label>
						<input type="text" id="add-enemyPet" data-type="pet">
						<div class="autocomplete-list" id="list-add-enemyPet"></div>
					</div>
				</div>
				
				<div class="add-form-section">
					<h3>⚔️ <span data-i18n="add.yourTeam">Twoja kontra</span></h3>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 1 <span class="quick-pick" onclick="openQuickSelect('add-my1', 'Twój Poz 1')">🏷️</span></label><input type="text" id="add-my1" data-type="hero"><div class="autocomplete-list" id="list-add-my1"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 2 <span class="quick-pick" onclick="openQuickSelect('add-my2', 'Twój Poz 2')">🏷️</span></label><input type="text" id="add-my2" data-type="hero"><div class="autocomplete-list" id="list-add-my2"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 3 <span class="quick-pick" onclick="openQuickSelect('add-my3', 'Twój Poz 3')">🏷️</span></label><input type="text" id="add-my3" data-type="hero"><div class="autocomplete-list" id="list-add-my3"></div></div>
					</div>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 4 <span class="quick-pick" onclick="openQuickSelect('add-my4', 'Twój Poz 4')">🏷️</span></label><input type="text" id="add-my4" data-type="hero"><div class="autocomplete-list" id="list-add-my4"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 5 <span class="quick-pick" onclick="openQuickSelect('add-my5', 'Twój Poz 5')">🏷️</span></label><input type="text" id="add-my5" data-type="hero"><div class="autocomplete-list" id="list-add-my5"></div></div>
					</div>
					<div class="form-row">
						<div class="autocomplete-wrapper"><label>Poz 6 <span class="quick-pick" onclick="openQuickSelect('add-my6', 'Twój Poz 6')">🏷️</span></label><input type="text" id="add-my6" data-type="hero"><div class="autocomplete-list" id="list-add-my6"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 7 <span class="quick-pick" onclick="openQuickSelect('add-my7', 'Twój Poz 7')">🏷️</span></label><input type="text" id="add-my7" data-type="hero"><div class="autocomplete-list" id="list-add-my7"></div></div>
						<div class="autocomplete-wrapper"><label>Poz 8 <span class="quick-pick" onclick="openQuickSelect('add-my8', 'Twój Poz 8')">🏷️</span></label><input type="text" id="add-my8" data-type="hero"><div class="autocomplete-list" id="list-add-my8"></div></div>
					</div>
					<div class="autocomplete-wrapper" style="max-width: 200px; margin: 10px auto 0;">
						<label>Pet <span class="quick-pick" onclick="openQuickSelect('add-myPet', 'Twój Pet')">🏷️</span></label>
						<input type="text" id="add-myPet" data-type="pet">
						<div class="autocomplete-list" id="list-add-myPet"></div>
					</div>
				</div>
			</div>
		<div class="autocomplete-wrapper full-width" style="margin-top: 15px;">
			<label>💬 <span data-i18n="add.commentLabel">Komentarz (opcjonalnie)</span></label>
			<input type="text" id="add-comment" data-i18n-placeholder="add.commentPlaceholder" placeholder="np. Unikać Death, Silbren u przeciwnika, kolejność speed: xxx > yyy > zzz, Pao runa PR, itp.">
		</div>

		<div class="admin-only-option" id="add-base-option" style="display: none; margin-top: 15px; padding: 12px; background: rgba(106, 27, 154, 0.1); border: 1px solid var(--accent-purple); border-radius: 8px;">
			<label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem;">
				<input type="checkbox" id="add-isBase" style="width: 18px; height: 18px; cursor: pointer;">
				<span>👑 <span data-i18n="add.markAsBase">Oznacz jako formację BAZOWĄ</span></span>
			</label>
			<p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; margin-left: 28px;" data-i18n="add.baseHint">Formacje bazowe są oznaczone jako "BAZA"</p>
		</div>

		<button class="btn btn-success" onclick="saveFormation()">💾 <span data-i18n="add.saveBtn">ZAPISZ FORMACJĘ</span></button>
            <button class="btn btn-secondary" onclick="clearAddForm()" style="margin-top: 8px;">✖ <span data-i18n="common.clear">Wyczyść</span></button>
        </div>
    </div>
    
    <!-- Tab: Planer Wojny (Admin) -->
    <div id="tab-war" class="tab-content">
        <div class="section">
            <h2>⚔️ Planer Wojny - 3 składy</h2>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 15px; text-align: center;">
                Wpisz 3 składy wrogów, a system zaproponuje optymalne kontr-formacje bez powtórzeń bohaterów
            </p>
            
            <div class="war-planner-grid">
				<!-- Wróg 1 -->
				<div class="war-enemy-section">
					<h3 class="war-enemy-title">⚔️ Walka 1</h3>
					<div class="war-enemy-grid">
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h1" placeholder="1" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h1"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h2" placeholder="2" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h2"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h3" placeholder="3" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h3"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h4" placeholder="4" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h4"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h5" placeholder="5" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h5"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h6" placeholder="6" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h6"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h7" placeholder="7" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h7"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-h8" placeholder="8" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-h8"></div></div>
						</div>
						<div class="war-row war-pet-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e1-pet" placeholder="🐾 Pet" data-type="pet" autocomplete="off"><div class="autocomplete-list" id="list-war-e1-pet"></div></div>
						</div>
					</div>
				</div>
                
				<!-- Wróg 2 -->
				<div class="war-enemy-section">
					<h3 class="war-enemy-title">⚔️ Walka 2</h3>
					<div class="war-enemy-grid">
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h1" placeholder="1" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h1"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h2" placeholder="2" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h2"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h3" placeholder="3" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h3"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h4" placeholder="4" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h4"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h5" placeholder="5" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h5"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h6" placeholder="6" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h6"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h7" placeholder="7" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h7"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-h8" placeholder="8" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-h8"></div></div>
						</div>
						<div class="war-row war-pet-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e2-pet" placeholder="🐾 Pet" data-type="pet" autocomplete="off"><div class="autocomplete-list" id="list-war-e2-pet"></div></div>
						</div>
					</div>
				</div>
                
				<!-- Wróg 3 -->
				<div class="war-enemy-section">
					<h3 class="war-enemy-title">⚔️ Walka 3</h3>
					<div class="war-enemy-grid">
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h1" placeholder="1" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h1"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h2" placeholder="2" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h2"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h3" placeholder="3" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h3"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h4" placeholder="4" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h4"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h5" placeholder="5" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h5"></div></div>
						</div>
						<div class="war-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h6" placeholder="6" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h6"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h7" placeholder="7" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h7"></div></div>
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-h8" placeholder="8" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-h8"></div></div>
						</div>
						<div class="war-row war-pet-row">
							<div class="autocomplete-wrapper"><input type="text" id="war-e3-pet" placeholder="🐾 Pet" data-type="pet" autocomplete="off"><div class="autocomplete-list" id="list-war-e3-pet"></div></div>
						</div>
					</div>
				</div>
            </div>
            
			<button class="btn btn-success" onclick="findWarFormations()" style="margin-top: 15px;">🎯 ZNAJDŹ OPTYMALNE SKŁADY</button>
			<div style="display: flex; gap: 10px; margin-top: 8px;">
				<button class="btn btn-secondary" onclick="clearWarPlanner()" style="flex: 1;">✖ Wyczyść</button>
				<button class="btn btn-secondary" onclick="loadWarPlanner()" style="flex: 1;" id="load-war-btn">📂 Wczytaj ostatnie</button>
			</div>
			<div id="war-autosave-info" style="text-align: center; font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;"></div>
        </div>
        
        <div id="war-results-section">
            <div class="empty-state">
                <p>Wpisz składy 3 wrogów i kliknij "Znajdź optymalne składy"</p>
            </div>
        </div>
    </div>
    
    <!-- Tab: Podgląd Wojny (Admin) -->
    <div id="tab-war-preview" class="tab-content">
        <div class="section">
            <h2>👁️ Podgląd Wojny - 3 składy</h2>
            <button class="btn btn-secondary" onclick="switchTab('war')" style="margin-bottom: 15px;">← Wróć do planera</button>
            <div id="war-preview-content">
                <div class="empty-state">
                    <p>Wybierz kombinację z planera wojny</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tab: Ustawienia -->
    <div id="tab-settings" class="tab-content">
        <div class="section">
            <h2>⚙️ <span data-i18n="settings.title">Import / Eksport</span></h2>
            
            <div class="info-box" id="connection-info">
                <strong>🔗 <span data-i18n="settings.status">Status</span>:</strong> <span data-i18n="settings.checking">Sprawdzanie połączenia...</span>
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 20px 0 10px;">📤 <span data-i18n="settings.exportTitle">Eksport do CSV</span></h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;" data-i18n="settings.exportDesc">Pobierz wszystkie formacje jako plik CSV</p>
            <button class="btn" onclick="exportToCSV()">📤 <span data-i18n="settings.exportBtn">Eksportuj CSV</span></button>
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">📥 <span data-i18n="settings.importTitle">Import z CSV</span></h3>
            <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;" data-i18n="settings.importDesc">Wczytaj formacje z pliku CSV (ten sam format co eksport)</p>
            <button class="btn btn-success" onclick="document.getElementById('csv-input').click()">📥 <span data-i18n="settings.importBtn">Importuj CSV</span></button>
            <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="importFromCSV(event)">
            
            <h3 style="font-size: 0.85rem; color: var(--text-muted); margin: 25px 0 10px;">🔄 <span data-i18n="settings.syncTitle">Synchronizacja</span></h3>
            <button class="btn btn-secondary" onclick="refreshData()">🔄 <span data-i18n="settings.refreshBtn">Odśwież dane</span></button>
        </div>
    </div>
    
    <!-- Tab: Admin -->
    <div id="tab-admin" class="tab-content">
        <div class="section admin-section">
            <h2>👑 <span data-i18n="admin.panelTitle">Panel Administratora</span></h2>
            
            <div class="info-box admin">
                <strong>🔐 <span data-i18n="admin.modeActive">Tryb Admin aktywny</span></strong><br>
                <span data-i18n="admin.modeDesc">Możesz zarządzać bohaterami, petami i usuwać dowolne formacje.</span>
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 20px 0 10px;">⚔️ <span data-i18n="admin.heroes">Bohaterowie</span> (<span id="heroes-count">0</span>)</h3>
            <div class="entity-list" id="heroes-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-hero-name" data-i18n-placeholder="admin.heroNamePlaceholder" placeholder="Nazwa bohatera">
                <select id="new-hero-race">
                    <option value="Dark">Dark</option>
                    <option value="Light">Light</option>
                    <option value="Undead">Undead</option>
                    <option value="Elf">Elf</option>
                    <option value="Fire">Fire</option>
                    <option value="Human">Human</option>
                </select>
                <button class="btn btn-success btn-small" onclick="addHero()">➕</button>
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">🐾 <span data-i18n="admin.pets">Pety</span> (<span id="pets-count">0</span>)</h3>
            <div class="entity-list" id="pets-list"></div>
            <div class="add-entity-form">
                <input type="text" id="new-pet-name" data-i18n-placeholder="admin.petNamePlaceholder" placeholder="Nazwa peta">
                <button class="btn btn-success btn-small" onclick="addPet()">➕</button>
            </div>
            
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">📋 <span data-i18n="admin.manageFormations">Zarządzanie formacjami</span></h3>
            <button class="btn btn-danger" onclick="deleteAllUserFormations()">🗑️ <span data-i18n="admin.deleteAllUser">Usuń wszystkie formacje użytkowników</span></button>
            
            <h3 style="font-size: 0.85rem; color: var(--accent-purple); margin: 25px 0 10px;">🚪 <span data-i18n="admin.session">Sesja</span></h3>
            <button class="btn btn-secondary" onclick="adminLogout()">🚪 <span data-i18n="admin.logout">Wyloguj z trybu Admin</span></button>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('search')"><span class="icon">🔍</span><span data-i18n="nav.search">Szukaj</span></button>
        <button class="nav-btn" onclick="switchTab('database')"><span class="icon">📚</span><span data-i18n="nav.database">Baza</span></button>
        <button class="nav-btn" onclick="switchTab('view')"><span class="icon">👁️</span><span data-i18n="nav.preview">Podgląd</span></button>
        <button class="nav-btn" onclick="switchTab('add')"><span class="icon">➕</span><span data-i18n="nav.add">Dodaj</span></button>
        <button class="nav-btn admin-only" id="nav-settings" onclick="switchTab('settings')"><span class="icon">⚙️</span><span data-i18n="nav.import">Import</span></button>
        <button class="nav-btn admin-only" id="nav-war" onclick="switchTab('war')"><span class="icon">⚔️</span><span>Wojna</span></button>
        <button class="nav-btn admin-only" id="nav-admin" onclick="switchTab('admin')"><span class="icon">👑</span><span>Admin</span></button>
    </nav>
    
	<!-- Modal edycji formacji -->
	<div class="modal hidden" id="edit-modal">
		<div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
			<h2>✏️ <span data-i18n="edit.title">Edytuj formację</span> #<span id="edit-id"></span></h2>
			
			<div class="autocomplete-wrapper" style="margin: 15px 0;">
				<label data-i18n="add.nameLabel">Nazwa formacji</label>
				<input type="text" id="edit-name">
			</div>
			
			<div class="add-form-section">
				<h3>⚔️ <span data-i18n="add.yourTeam">Twój skład</span></h3>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 1</label><input type="text" id="edit-my1" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my1"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 2</label><input type="text" id="edit-my2" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my2"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 3</label><input type="text" id="edit-my3" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my3"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 4</label><input type="text" id="edit-my4" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my4"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 5</label><input type="text" id="edit-my5" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my5"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 6</label><input type="text" id="edit-my6" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my6"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 7</label><input type="text" id="edit-my7" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my7"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 8</label><input type="text" id="edit-my8" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-my8"></div></div>
				</div>
				<div class="autocomplete-wrapper" style="max-width: 150px; margin: 8px auto;">
					<label>🐾 Pet</label>
					<input type="text" id="edit-myPet" data-type="pet" autocomplete="off">
					<div class="autocomplete-list" id="list-edit-myPet"></div>
				</div>
			</div>
			
			<div class="add-form-section" style="margin-top: 15px;">
				<h3>👹 <span data-i18n="add.enemyTeam">Skład przeciwnika</span></h3>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 1</label><input type="text" id="edit-enemy1" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy1"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 2</label><input type="text" id="edit-enemy2" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy2"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 3</label><input type="text" id="edit-enemy3" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy3"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 4</label><input type="text" id="edit-enemy4" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy4"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 5</label><input type="text" id="edit-enemy5" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy5"></div></div>
				</div>
				<div class="form-row">
					<div class="autocomplete-wrapper"><label>Poz 6</label><input type="text" id="edit-enemy6" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy6"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 7</label><input type="text" id="edit-enemy7" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy7"></div></div>
					<div class="autocomplete-wrapper"><label>Poz 8</label><input type="text" id="edit-enemy8" data-type="hero" autocomplete="off"><div class="autocomplete-list" id="list-edit-enemy8"></div></div>
				</div>
				<div class="autocomplete-wrapper" style="max-width: 150px; margin: 8px auto;">
					<label>🐾 Pet</label>
					<input type="text" id="edit-enemyPet" data-type="pet" autocomplete="off">
					<div class="autocomplete-list" id="list-edit-enemyPet"></div>
				</div>
			</div>
			
			<div class="autocomplete-wrapper" style="margin: 15px 0;">
				<label>💬 <span data-i18n="add.commentLabel">Komentarz</span></label>
				<input type="text" id="edit-comment">
			</div>

			<div style="margin: 15px 0; padding: 12px; background: rgba(106, 27, 154, 0.1); border: 1px solid var(--accent-purple); border-radius: 8px;">
				<label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem;">
					<input type="checkbox" id="edit-isBase" style="width: 18px; height: 18px; cursor: pointer;">
					<span>👑 <span data-i18n="add.markAsBase">Oznacz jako formację BAZOWĄ</span></span>
				</label>
			</div>

			<button class="btn btn-success" onclick="saveEditFormation()">💾 <span data-i18n="edit.saveBtn">ZAPISZ ZMIANY</span></button>
			<button class="btn btn-secondary" onclick="closeEditModal()" style="margin-top: 8px;"><span data-i18n="common.cancel">Anuluj</span></button>
		</div>
	</div>
	
    <div class="toast" id="toast"></div>

    <div class="quick-select-modal hidden" id="quick-select-modal">
        <div class="quick-select-content">
            <div class="quick-select-header">
                <h3>🏷️ <span data-i18n="quickSelect.title">Szybki wybór</span></h3>
                <button class="quick-select-close" onclick="closeQuickSelect()">✕</button>
            </div>
            <div class="quick-select-target" id="quick-select-target">
                <span data-i18n="quickSelect.selectFor">Wybierz dla</span>: <strong>—</strong>
            </div>
            <div id="quick-select-tags"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // =====================================================
        // KONFIGURACJA I ZMIENNE GLOBALNE
        // =====================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAZSC5B3HfX1AxOKFR06ixlFh0cgdwKY7M",
            authDomain: "souls-online-war.firebaseapp.com",
            databaseURL: "https://souls-online-war-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "souls-online-war",
            storageBucket: "souls-online-war.firebasestorage.app",
            messagingSenderId: "700986594564",
            appId: "1:700986594564:web:114ff3c81a42edb1d2ac51"
        };
        
        let db, formationsRef, heroesRef, petsRef;
        let allFormations = [];
        let isOnline = false, isAdmin = false;
        let headerClickCount = 0, headerClickTimer = null;
        let favorites = JSON.parse(localStorage.getItem('souls_favorites') || '[]');
        let currentLang = localStorage.getItem('souls_lang') || 'pl';
        let currentDbFilter = 'all';
		let currentDbSort = 'id-asc';
        let quickSelectTarget = null, activeAddField = null, activeSearchField = null, editingFormationId = null;
		let currentTheme = localStorage.getItem('souls_theme') || 'dark';
		let isGuildAuthenticated = false;

		// ========== KONFIGURACJA ZABEZPIECZEŃ ==========
		const GUILD_PASSWORD_ENABLED = true; // Zmień na true aby włączyć hasło na wejście
		// ===============================================

		// Hashe haseł (SHA-256)
		const GUILD_PASSWORD_HASH = '249dc54f04e8c635d90121519b23214d62bf91c4f28edc27ec8c989bc897de70';
		const ADMIN_PASSWORD_HASH = '73e27fdb26c47415340900ae682ca124348f26663db2f797fb7cee6232126ac5';
        
        let heroes = [
            {name:"Dmitri",race:"Dark"},{name:"Roze",race:"Dark"},{name:"Nebula",race:"Dark"},{name:"Zeke",race:"Dark"},
            {name:"Benzel",race:"Dark"},{name:"Lilith",race:"Dark"},{name:"Bahzam",race:"Dark"},{name:"Zagrako",race:"Dark"},
            {name:"Lumen",race:"Light"},{name:"Akmon",race:"Light"},{name:"Leovalt",race:"Light"},{name:"Lena",race:"Light"},
            {name:"Ulion",race:"Light"},{name:"Nuel",race:"Light"},{name:"Solina",race:"Light"},{name:"Taros",race:"Light"},
            {name:"Muerte",race:"Undead"},{name:"Melantha",race:"Undead"},{name:"Nox",race:"Undead"},{name:"Ripper",race:"Undead"},
            {name:"Fleta",race:"Undead"},{name:"Ash",race:"Undead"},{name:"Dextor",race:"Undead"},{name:"Carmen",race:"Undead"},
            {name:"Zenon",race:"Undead"},{name:"Amanda",race:"Undead"},{name:"Void",race:"Undead"},{name:"Harfa",race:"Undead"},
            {name:"Serena",race:"Elf"},{name:"Oneric",race:"Elf"},{name:"Elara",race:"Elf"},{name:"CoCo",race:"Elf"},
            {name:"Babu",race:"Elf"},{name:"Sander",race:"Elf"},{name:"Tania",race:"Elf"},{name:"Galan",race:"Elf"},
            {name:"Aolmond",race:"Elf"},{name:"LuLu",race:"Elf"},{name:"Fiona",race:"Elf"},{name:"Abala",race:"Elf"},
            {name:"Bella",race:"Fire"},{name:"Lupico",race:"Fire"},{name:"Paopao",race:"Fire"},{name:"Jack",race:"Fire"},
            {name:"Dolucos",race:"Fire"},{name:"Aruru",race:"Fire"},{name:"Kaion",race:"Fire"},{name:"Paru",race:"Fire"},
            {name:"Naru",race:"Fire"},{name:"Telfer",race:"Fire"},{name:"Lagou",race:"Fire"},
            {name:"Morra",race:"Human"},{name:"Scarlet",race:"Human"},{name:"Kyle",race:"Human"},{name:"Adora",race:"Human"},
            {name:"Rakan",race:"Human"},{name:"Olga",race:"Human"},{name:"Idina",race:"Human"},{name:"Ken",race:"Human"},
            {name:"Calix",race:"Human"},{name:"Odelia",race:"Human"},{name:"Milia",race:"Human"},{name:"Richelle",race:"Human"},
            {name:"Liandra",race:"Human"}
        ];
        
        let pets = ["Gladis","Nasrune","Romanelle","Tianum","Hamm","Spooky","Mystet","Bloombell","Silbren","Vailo","Estelle","Banavi","Moko"];
        
        // =====================================================
        // TŁUMACZENIA
        // =====================================================
        
        const translations = {
            pl: {
                'loading': 'Ładowanie danych...', 'common.loading': 'Ładowanie...', 'common.cancel': 'Anuluj', 'common.clear': 'Wyczyść',
                'header.subtitle': 'Wyszukiwarka kontr-formacji', 'status.connecting': 'Łączenie...', 'status.online': 'Online', 'status.offline': 'Offline', 'status.formations': 'formacji',
                'nav.search': 'Szukaj', 'nav.database': 'Baza', 'nav.preview': 'Podgląd', 'nav.add': 'Dodaj', 'nav.import': 'Import',
                'search.title': 'Szukaj kontr-formacji', 'search.subtitle': 'Wpisz skład przeciwnika (lub wybierz tagami)', 'search.btn': 'SZUKAJ', 'search.clear': 'Wyczyść',
                'search.emptyState': 'Wpisz postacie przeciwnika i kliknij "Szukaj"', 'search.results': 'Wyniki', 'search.found': 'Znaleziono', 'search.noResults': 'Nie znaleziono pasujących formacji',
                'search.enemy': 'Przeciwnik', 'search.missing': 'Brak', 'search.allSlotsFull': 'Wszystkie pola zajęte!', 'search.petSlotFull': 'Pole Pet już zajęte!',
                'search.enterAtLeastOne': 'Wpisz przynajmniej jedną postać!', 'search.selected': 'Wybrano',
                'database.title': 'Pełna baza formacji', 'database.statsAll': 'Wszystkich', 'database.statsBase': 'Bazowych', 'database.statsUser': 'Dodanych',
                'database.filterAll': 'Wszystkie', 'database.filterBase': 'Bazowe', 'database.filterUser': 'Dodane', 'database.filterFavorites': 'Ulubione',
                'database.searchPlaceholder': '🔍 Szukaj...', 'database.noFormations': 'Brak formacji',
                'preview.title': 'Podgląd formacji', 'preview.idPlaceholder': 'Wpisz ID (np. 12)', 'preview.showBtn': 'POKAŻ',
                'preview.emptyState': 'Wpisz ID aby zobaczyć układ formacji', 'preview.notFound': 'Nie znaleziono formacji',
                'preview.enemy': 'PRZECIWNIK', 'preview.yourTeam': 'TWÓJ SKŁAD', 'preview.noPet': 'Brak peta', 'preview.invalidId': 'Wpisz prawidłowy numer ID!',
                'add.title': 'Dodaj nową formację', 'add.nameLabel': 'Nazwa formacji', 'add.namePlaceholder': 'np. Nick 01-01-2026 W1 / Kontra Dark-Undead v1',
                'add.yourTeam': 'Twój skład', 'add.enemyTeam': 'Skład przeciwnika', 'add.commentLabel': 'Komentarz (opcjonalnie)',
                'add.commentPlaceholder': 'np. Unikać Death, Silbren u przeciwnika, kolejność speed: xxx > yyy > zzz, Pao runa PR, itp.', 'add.saveBtn': 'ZAPISZ FORMACJĘ',
                'add.enterName': 'Podaj nazwę formacji!', 'add.addAtLeastOne': 'Dodaj przynajmniej jedną postać!',
                'add.unknownHeroes': 'Nieznani bohaterowie', 'add.unknownPets': 'Nieznane pety', 'add.saved': 'Zapisano formację',
                'settings.title': 'Import / Eksport', 'settings.status': 'Status', 'settings.checking': 'Sprawdzanie połączenia...',
                'settings.online': 'Połączono z bazą danych.', 'settings.offline': 'Brak połączenia z bazą.',
                'settings.exportTitle': 'Eksport do CSV', 'settings.exportDesc': 'Pobierz wszystkie formacje jako plik CSV', 'settings.exportBtn': 'Eksportuj CSV',
                'settings.importTitle': 'Import z CSV', 'settings.importDesc': 'Wczytaj formacje z pliku CSV (ten sam format co eksport)', 'settings.importBtn': 'Importuj CSV',
                'settings.syncTitle': 'Synchronizacja', 'settings.refreshBtn': 'Odśwież dane', 'settings.exported': 'Wyeksportowano', 'settings.imported': 'Zaimportowano',
                'admin.title': 'Panel Administratora', 'admin.enterPassword': 'Wpisz hasło administratora', 'admin.passwordPlaceholder': 'Hasło...', 'admin.login': 'ZALOGUJ',
                'admin.panelTitle': 'Panel Administratora', 'admin.modeActive': 'Tryb Admin aktywny', 'admin.modeDesc': 'Możesz zarządzać bohaterami, petami i usuwać dowolne formacje.',
                'admin.heroes': 'Bohaterowie', 'admin.pets': 'Pety', 'admin.heroNamePlaceholder': 'Nazwa bohatera', 'admin.petNamePlaceholder': 'Nazwa peta',
                'admin.manageFormations': 'Zarządzanie formacjami', 'admin.deleteAllUser': 'Usuń wszystkie formacje użytkowników', 'admin.loadBase': 'Załaduj bazę startową (126)',
                'admin.session': 'Sesja', 'admin.logout': 'Wyloguj z trybu Admin', 'admin.loggedIn': 'Zalogowano jako Administrator!', 'admin.loggedOut': 'Wylogowano z trybu Admin',
                'admin.wrongPassword': 'Nieprawidłowe hasło!', 'admin.alreadyLogged': 'Już jesteś zalogowany jako Admin',
                'admin.heroAdded': 'Dodano bohatera', 'admin.heroDeleted': 'Usunięto', 'admin.heroExists': 'Bohater już istnieje!',
                'admin.petAdded': 'Dodano peta', 'admin.petExists': 'Pet już istnieje!', 'admin.enterHeroName': 'Podaj nazwę bohatera!', 'admin.enterPetName': 'Podaj nazwę peta!',
                'admin.confirmDeleteHero': 'Usunąć bohatera', 'admin.confirmDeletePet': 'Usunąć peta', 'admin.confirmDeleteAllUser': 'Na pewno usunąć WSZYSTKIE formacje dodane przez użytkowników?',
                'admin.confirmLoadBase': 'Załadować 126 bazowych formacji?', 'admin.deletedUserFormations': 'Usunięto formacji użytkowników',
                'admin.loadingBase': 'Ładowanie bazy... To może chwilę potrwać.', 'admin.loadedBase': 'Załadowano formacji!',
                'quickSelect.title': 'Szybki wybór', 'quickSelect.selectFor': 'Wybierz dla',
                'quickTags.expandAll': 'Rozwiń wszystkie tagi', 'quickTags.collapseAll': 'Zwiń wszystkie tagi', 'quickTags.pets': 'Pety',
                'common.error': 'Błąd', 'common.noConnection': 'Brak połączenia z bazą!', 'common.formationDeleted': 'Formacja usunięta!',
                'common.cannotDeleteBase': 'Nie możesz usunąć formacji bazowej!', 'common.confirmDelete': 'Usunąć formację',
                'common.addedToFavorites': 'Dodano do ulubionych ⭐', 'common.removedFromFavorites': 'Usunięto z ulubionych',
				'common.adminRequired': 'Tylko admin może usuwać formacje!', 'database.sortLabel': 'Sortuj:',
				'edit.title': 'Edytuj formację', 'edit.saveBtn': 'ZAPISZ ZMIANY', 'add.markAsBase': 'Oznacz jako formację BAZOWĄ',
				'add.baseHint': 'Formacje bazowe są oznaczone jako "BAZA".', 'preview.added': 'Dodano', 'preview.edited': 'Edytowano',
				'guild.title': 'Strona gildii',
				'guild.enterPassword': 'Wpisz hasło gildii aby wejść',
				'guild.passwordPlaceholder': 'Hasło gildii...',
				'guild.enter': 'WEJDŹ',
				'guild.wrongPassword': 'Nieprawidłowe hasło!',
                'badge.base': 'BAZA', 'badge.user': 'DODANA'
            },
            en: {
                'loading': 'Loading data...', 'common.loading': 'Loading...', 'common.cancel': 'Cancel', 'common.clear': 'Clear',
                'header.subtitle': 'Counter-formation finder', 'status.connecting': 'Connecting...', 'status.online': 'Online', 'status.offline': 'Offline', 'status.formations': 'formations',
                'nav.search': 'Search', 'nav.database': 'Database', 'nav.preview': 'Preview', 'nav.add': 'Add', 'nav.import': 'Import',
                'search.title': 'Search counter-formations', 'search.subtitle': 'Enter enemy composition (or use tags)', 'search.btn': 'SEARCH', 'search.clear': 'Clear',
                'search.emptyState': 'Enter enemy heroes and click "Search"', 'search.results': 'Results', 'search.found': 'Found', 'search.noResults': 'No matching formations found',
                'search.enemy': 'Enemy', 'search.missing': 'Missing', 'search.allSlotsFull': 'All slots are full!', 'search.petSlotFull': 'Pet slot is full!',
                'search.enterAtLeastOne': 'Enter at least one hero!', 'search.selected': 'Selected',
                'database.title': 'Full formation database', 'database.statsAll': 'Total', 'database.statsBase': 'Base', 'database.statsUser': 'Added',
                'database.filterAll': 'All', 'database.filterBase': 'Base', 'database.filterUser': 'Added', 'database.filterFavorites': 'Favorites',
                'database.searchPlaceholder': '🔍 Search...', 'database.noFormations': 'No formations',
                'preview.title': 'Formation preview', 'preview.idPlaceholder': 'Enter ID (e.g. 12)', 'preview.showBtn': 'SHOW',
                'preview.emptyState': 'Enter ID to see formation layout', 'preview.notFound': 'Formation not found',
                'preview.enemy': 'ENEMY', 'preview.yourTeam': 'YOUR TEAM', 'preview.noPet': 'No pet', 'preview.invalidId': 'Enter a valid ID number!',
                'add.title': 'Add new formation', 'add.nameLabel': 'Formation name', 'add.namePlaceholder': 'e.g. Nick 01-01-2026 W1 / Counter Dark-Undead v1',
                'add.yourTeam': 'Your team', 'add.enemyTeam': 'Enemy team', 'add.commentLabel': 'Comment (optional)',
                'add.commentPlaceholder': 'e.g. Avoid Death, Silbren on enemy, speed order: xxx > yyy > zzz, Pao rune PR, etc.', 'add.saveBtn': 'SAVE FORMATION',
                'add.enterName': 'Enter formation name!', 'add.addAtLeastOne': 'Add at least one hero!',
                'add.unknownHeroes': 'Unknown heroes', 'add.unknownPets': 'Unknown pets', 'add.saved': 'Formation saved',
                'settings.title': 'Import / Export', 'settings.status': 'Status', 'settings.checking': 'Checking connection...',
                'settings.online': 'Connected to database.', 'settings.offline': 'No database connection.',
                'settings.exportTitle': 'Export to CSV', 'settings.exportDesc': 'Download all formations as CSV file', 'settings.exportBtn': 'Export CSV',
                'settings.importTitle': 'Import from CSV', 'settings.importDesc': 'Load formations from CSV file (same format as export)', 'settings.importBtn': 'Import CSV',
                'settings.syncTitle': 'Synchronization', 'settings.refreshBtn': 'Refresh data', 'settings.exported': 'Exported', 'settings.imported': 'Imported',
                'admin.title': 'Administrator Panel', 'admin.enterPassword': 'Enter administrator password', 'admin.passwordPlaceholder': 'Password...', 'admin.login': 'LOGIN',
                'admin.panelTitle': 'Administrator Panel', 'admin.modeActive': 'Admin mode active', 'admin.modeDesc': 'You can manage heroes, pets and delete any formations.',
                'admin.heroes': 'Heroes', 'admin.pets': 'Pets', 'admin.heroNamePlaceholder': 'Hero name', 'admin.petNamePlaceholder': 'Pet name',
                'admin.manageFormations': 'Manage formations', 'admin.deleteAllUser': 'Delete all user formations', 'admin.loadBase': 'Load base data (126)',
                'admin.session': 'Session', 'admin.logout': 'Logout from Admin mode', 'admin.loggedIn': 'Logged in as Administrator!', 'admin.loggedOut': 'Logged out from Admin mode',
                'admin.wrongPassword': 'Wrong password!', 'admin.alreadyLogged': 'Already logged in as Admin',
                'admin.heroAdded': 'Hero added', 'admin.heroDeleted': 'Deleted', 'admin.heroExists': 'Hero already exists!',
                'admin.petAdded': 'Pet added', 'admin.petExists': 'Pet already exists!', 'admin.enterHeroName': 'Enter hero name!', 'admin.enterPetName': 'Enter pet name!',
                'admin.confirmDeleteHero': 'Delete hero', 'admin.confirmDeletePet': 'Delete pet', 'admin.confirmDeleteAllUser': 'Are you sure you want to delete ALL user formations?',
                'admin.confirmLoadBase': 'Load 126 base formations?', 'admin.deletedUserFormations': 'Deleted user formations',
                'admin.loadingBase': 'Loading base... This may take a moment.', 'admin.loadedBase': 'Loaded formations!',
                'quickSelect.title': 'Quick select', 'quickSelect.selectFor': 'Select for',
                'quickTags.expandAll': 'Expand all', 'quickTags.collapseAll': 'Collapse all', 'quickTags.pets': 'Pets',
                'common.error': 'Error', 'common.noConnection': 'No database connection!', 'common.formationDeleted': 'Formation deleted!',
                'common.cannotDeleteBase': 'Cannot delete base formation!', 'common.confirmDelete': 'Delete formation',
                'common.addedToFavorites': 'Added to favorites ⭐', 'common.removedFromFavorites': 'Removed from favorites',
				'common.adminRequired': 'Only admin can delete formations!', 'database.sortLabel': 'Sort:',
				'edit.title': 'Edit formation', 'edit.saveBtn': 'SAVE CHANGES', 'add.markAsBase': 'Mark as BASE formation',
				'add.baseHint': 'Base formations are marked as "BASE".', 'preview.added': 'Added', 'preview.edited': 'Edited',
				'guild.title': 'Guild page',
				'guild.enterPassword': 'Enter guild password to access',
				'guild.passwordPlaceholder': 'Guild password...',
				'guild.enter': 'ENTER',
				'guild.wrongPassword': 'Wrong password!',
                'badge.base': 'BASE', 'badge.user': 'ADDED'
            }
        };
        
        const t = key => translations[currentLang][key] || translations['pl'][key] || key;
        
        // =====================================================
        // FUNKCJE POMOCNICZE
        // =====================================================
        
        const $ = id => document.getElementById(id);
        const normalize = str => (str || '').trim().toLowerCase();
        const getPetName = p => typeof p === 'string' ? p : p.name;
		
		// Hashowanie SHA-256
		async function hashPassword(password) {
			const encoder = new TextEncoder();
			const data = encoder.encode(password);
			const hashBuffer = await crypto.subtle.digest('SHA-256', data);
			const hashArray = Array.from(new Uint8Array(hashBuffer));
			return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
		}
		
		// Sprawdź czy użytkownik ma dostęp do gildii
		async function checkGuildAccess() {
			// Jeśli hasło wyłączone - zawsze przepuść
			if (!GUILD_PASSWORD_ENABLED) {
				isGuildAuthenticated = true;
				return true;
			}
			
			const savedHash = localStorage.getItem('souls_guild_access');
			if (savedHash === GUILD_PASSWORD_HASH) {
				isGuildAuthenticated = true;
				$('guild-password-modal').classList.add('hidden');
				return true;
			}
			$('guild-password-modal').classList.remove('hidden');
			$('loading').classList.add('hidden');
			return false;
		}

		// Próba logowania do gildii
		async function tryGuildLogin() {
			const password = $('guild-password').value;
			if (!password) {
				showGuildError(t('guild.wrongPassword'));
				return;
			}
			
			const hash = await hashPassword(password);
			
			if (hash === GUILD_PASSWORD_HASH) {
				localStorage.setItem('souls_guild_access', hash);
				isGuildAuthenticated = true;
				$('guild-password-modal').classList.add('hidden');
				$('loading').classList.remove('hidden');
				location.reload();
			} else {
				showGuildError(t('guild.wrongPassword'));
				$('guild-password').value = '';
			}
		}

		function showGuildError(msg) {
			const err = $('guild-error');
			err.textContent = msg;
			err.style.display = 'block';
			setTimeout(() => err.style.display = 'none', 3000);
		}
				
		// Formatuj datę do czytelnego formatu (z godziną jeśli != 00:00)
		function formatDate(isoString) {
			if (!isoString) return null;
			const date = new Date(isoString);
			const dateStr = date.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
			
			// Pokaż godzinę tylko jeśli nie jest 00:00
			const hours = date.getHours();
			const minutes = date.getMinutes();
			if (hours === 0 && minutes === 0) {
				return dateStr;
			}
			const timeStr = date.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
			return `${dateStr}, ${timeStr}`;
		}
        
		function initTheme() {
			if (currentTheme === 'light') {
				document.documentElement.setAttribute('data-theme', 'light');
				updateThemeButton('light');
			} else {
				document.documentElement.removeAttribute('data-theme');
				updateThemeButton('dark');
			}
		}

		function toggleTheme() {
			if (currentTheme === 'dark') {
				currentTheme = 'light';
				document.documentElement.setAttribute('data-theme', 'light');
			} else {
				currentTheme = 'dark';
				document.documentElement.removeAttribute('data-theme');
			}
			
			localStorage.setItem('souls_theme', currentTheme);
			updateThemeButton(currentTheme);
			showToast(currentTheme === 'light' ? '☀️ Tryb dzienny' : '🌙 Tryb nocny');
		}

		function updateThemeButton(theme) {
			const btn = $('theme-toggle');
			if (!btn) return;
			
			const icon = btn.querySelector('.theme-icon');
			if (icon) {
				icon.textContent = theme === 'light' ? '☀️' : '🌙';
			}
			btn.title = theme === 'light' ? 'Przełącz na tryb nocny' : 'Przełącz na tryb dzienny';
		}
		
        // Pobierz wartości z wielu pól
        function getFieldValues(prefix, count, suffix = '') {
            const values = [];
            for (let i = 1; i <= count; i++) {
                const el = $(`${prefix}${i}${suffix}`);
                if (el) values.push(el.value.trim());
            }
            return values;
        }
        
        // Ustaw/wyczyść walidację inputa
        function setValidation(input, isValid) {
            if (isValid === null) {
                input.classList.remove('invalid-hero', 'valid-hero');
            } else {
                input.classList.toggle('invalid-hero', !isValid);
                input.classList.toggle('valid-hero', isValid);
            }
        }
        
        // Waliduj bohatera/peta
        function validateInput(input) {
            const val = input.value.trim().toLowerCase();
            if (!val) { setValidation(input, null); return; }
            
            const type = input.dataset.type;
            let isValid = false;
            
            if (type === 'hero') {
                isValid = heroes.some(h => h.name.toLowerCase() === val);
            } else if (type === 'pet') {
                isValid = pets.some(p => getPetName(p).toLowerCase() === val);
            }
            
            setValidation(input, isValid);
        }
        
        // =====================================================
        // FIREBASE
        // =====================================================
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            formationsRef = db.ref('formations');
            heroesRef = db.ref('heroes');
            petsRef = db.ref('pets');
            
            formationsRef.on('value', snap => {
                allFormations = snap.val() ? Object.values(snap.val()).sort((a, b) => a.id - b.id) : [];
                updateUI();
                $('loading').classList.add('hidden');
                setOnlineStatus(true);
            }, () => { setOnlineStatus(false); $('loading').classList.add('hidden'); });
            
            heroesRef.on('value', snap => {
                if (snap.val()) {
                    heroes = Object.values(snap.val()).sort((a, b) => a.name.localeCompare(b.name));
                    if (isAdmin) renderHeroesList();
                }
            });
            
            petsRef.on('value', snap => {
                if (snap.val()) {
                    pets = Object.values(snap.val()).map(getPetName).sort();
                    if (isAdmin) renderPetsList();
                }
            });
            
            db.ref('.info/connected').on('value', snap => setOnlineStatus(snap.val() === true));
        } catch (e) {
            console.error('Firebase error:', e);
            setOnlineStatus(false);
            $('loading').classList.add('hidden');
        }
        
        // =====================================================
        // UI
        // =====================================================
        
        function setOnlineStatus(online) {
            isOnline = online;
            $('status-dot').className = `status-dot ${online ? 'online' : 'offline'}`;
            $('status-text').textContent = t(online ? 'status.online' : 'status.offline');
            const info = $('connection-info');
            if (info) info.innerHTML = `<strong>${online ? '🟢' : '🔴'} ${t(online ? 'status.online' : 'status.offline')}:</strong> ${t(online ? 'settings.online' : 'settings.offline')}`;
        }
        
        function updateUI() {
            $('total-count').textContent = allFormations.length;
            $('db-stat-total').textContent = allFormations.length;
            $('db-stat-base').textContent = allFormations.filter(f => f.isBase).length;
            $('db-stat-user').textContent = allFormations.filter(f => !f.isBase).length;
            filterDatabase();
            generateQuickTags();
            generateAddFormTags();
        }
        
        function showToast(msg, isError = false) {
            const toast = $('toast');
            toast.textContent = msg;
            toast.className = `toast show${isError ? ' error' : ''}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function switchTab(name) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.nav-btn[onclick="switchTab('${name}')"]`)?.classList.add('active');
            $(`tab-${name}`)?.classList.add('active');
        }
        
        // =====================================================
        // TŁUMACZENIA
        // =====================================================
        
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('souls_lang', lang);
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');
            applyTranslations();
            filterDatabase();
            generateQuickTags();
            generateAddFormTags();
            const lookupId = $('lookup-id').value;
            if (lookupId && $('tab-view').classList.contains('active')) showFormation(parseInt(lookupId));
        }
        
        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.getAttribute('data-i18n')));
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
            setOnlineStatus(isOnline);
        }
        
        // =====================================================
        // QUICK TAGS - UNIWERSALNA FUNKCJA
        // =====================================================
        
        const RACE_ORDER = ['Dark', 'Light', 'Human', 'Fire', 'Elf', 'Undead'];
        const RACE_EMOJI = { Dark: '🌑', Light: '☀️', Human: '👤', Fire: '🔥', Elf: '🌿', Undead: '💀' };
        
		function buildTagsHTML(raceGroups, petsData, clickHandler, petClickHandler, showCounts = false) {
			let html = `<div class="quick-tags-expand-all"><button class="expand-all-btn" onclick="toggleAllTags(this.closest('.search-form-tags, .add-form-tags'))">▼ ${t('quickTags.expandAll')}</button></div>`;
			
			RACE_ORDER.forEach(race => {
				if (raceGroups[race]?.length) {
					html += `<div class="quick-tags-section"><div class="quick-tags-header" onclick="toggleQuickTagSection(this)"><span class="toggle-icon">▶</span>${RACE_EMOJI[race]} ${race} (${raceGroups[race].length})</div><div class="quick-tags-content"><div class="quick-tags">${raceGroups[race].map(h => `<span class="quick-tag tag-${race.toLowerCase()}" onclick="${clickHandler}('${h.name || h}')"${showCounts && h.count ? ` title="${h.count}x"` : ''}>${h.name || h}</span>`).join('')}</div></div></div>`;
				}
			});
			
			if (petsData?.length) {
				html += `<div class="quick-tags-section"><div class="quick-tags-header" onclick="toggleQuickTagSection(this)"><span class="toggle-icon">▶</span>🐾 ${t('quickTags.pets')} (${petsData.length})</div><div class="quick-tags-content"><div class="quick-tags">${petsData.map(p => `<span class="quick-tag tag-pet" onclick="${petClickHandler}('${p.name || p}')"${showCounts && p.count ? ` title="${p.count}x"` : ''}>${p.name || p}</span>`).join('')}</div></div></div>`;
			}
			
			return html;
		}
        
        function generateQuickTags() {
            if (!allFormations.length) return;
            
            const heroCounts = {}, petCounts = {};
            const heroRaceMap = {};
            heroes.forEach(h => heroRaceMap[h.name.toLowerCase()] = h.race);
            
            allFormations.forEach(f => {
                f.enemy.filter(h => h).forEach(h => heroCounts[h] = (heroCounts[h] || 0) + 1);
                if (f.enemyPet) petCounts[f.enemyPet] = (petCounts[f.enemyPet] || 0) + 1;
            });
            
            const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
            Object.entries(heroCounts).forEach(([name, count]) => {
                const race = heroRaceMap[name.toLowerCase()];
                if (race && raceGroups[race]) raceGroups[race].push({ name, count });
            });
            RACE_ORDER.forEach(r => raceGroups[r].sort((a, b) => a.name.localeCompare(b.name)));
            
            const petsData = Object.entries(petCounts).sort((a, b) => a[0].localeCompare(b[0])).map(([name, count]) => ({ name, count }));
            
            $('quick-tags-container').innerHTML = buildTagsHTML(raceGroups, petsData, 'addToSearch', 'addPetToSearch', true);
            updateSearchTagsSelection();
        }
        
        function generateAddFormTags() {
            const container = $('add-form-tags-container');
            if (!container) return;
            
            const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
            heroes.forEach(h => raceGroups[h.race]?.push(h.name));
            RACE_ORDER.forEach(r => raceGroups[r].sort((a, b) => a.localeCompare(b)));
            
            container.innerHTML = buildTagsHTML(raceGroups, pets, "addTagToActiveField", "addTagToActiveField");
            updateAddFormTagsSelection();
        }
        
        function toggleQuickTagSection(header) {
            header.classList.toggle('expanded');
            header.nextElementSibling.classList.toggle('show');
        }
        
        function toggleAllTags(container) {
            const sections = container.querySelectorAll('.quick-tags-section');
            const btn = container.querySelector('.expand-all-btn');
            const allExpanded = container.querySelectorAll('.quick-tags-header.expanded').length === sections.length;
            
            sections.forEach(s => {
                s.querySelector('.quick-tags-header').classList.toggle('expanded', !allExpanded);
                s.querySelector('.quick-tags-content').classList.toggle('show', !allExpanded);
            });
            btn.textContent = allExpanded ? `▼ ${t('quickTags.expandAll')}` : `▲ ${t('quickTags.collapseAll')}`;
        }
        
        // =====================================================
        // WYSZUKIWARKA
        // =====================================================
		function addToSearch(heroName) {
			// Sprawdź czy już jest - jeśli tak, usuń (toggle)
			for (let i = 1; i <= 8; i++) {
				const input = $(`search-pos${i}`);
				if (input.value.trim().toLowerCase() === heroName.toLowerCase()) {
					input.value = '';
					updateSearchTagsSelection();
					updateSearchCounter();
					return;
				}
			}
			
			// Jeśli jest aktywne pole, dodaj tam
			if (activeSearchField) {
				const activeInput = $(activeSearchField);
				if (activeInput && activeInput.id.startsWith('search-pos')) {
					activeInput.value = heroName;
					updateSearchTagsSelection();
					updateSearchCounter();
					return;
				}
			}
			
			// W przeciwnym razie dodaj do pierwszego wolnego
			for (let i = 1; i <= 8; i++) {
				const input = $(`search-pos${i}`);
				if (!input.value.trim()) {
					input.value = heroName;
					updateSearchTagsSelection();
					updateSearchCounter();
					return;
				}
			}
			showToast(t('search.allSlotsFull'), true);
		}
        
		function addPetToSearch(petName) {
			const petInput = $('search-pet');
			
			// Toggle - jeśli ten sam pet, usuń
			if (petInput.value.trim().toLowerCase() === petName.toLowerCase()) {
				petInput.value = '';
			} 
			// Jeśli pole pet jest aktywne LUB puste, wpisz
			else if (activeSearchField === 'search-pet' || !petInput.value.trim()) {
				petInput.value = petName;
			} 
			else {
				showToast(t('search.petSlotFull'), true);
				return;
			}
			updateSearchTagsSelection();
			updateSearchCounter();
		}
        
        function updateSearchCounter() {
            let count = getFieldValues('search-pos', 8).filter(v => v).length;
            if ($('search-pet').value.trim()) count++;
            
            let counter = $('search-counter');
            if (count > 0) {
                if (!counter) {
                    counter = document.createElement('div');
                    counter.id = 'search-counter';
                    counter.className = 'search-counter';
                    $('quick-tags-container').parentNode.insertBefore(counter, $('quick-tags-container').nextSibling);
                }
                counter.innerHTML = `${t('search.selected')}: <strong>${count}</strong> / 6`;
            } else counter?.remove();
        }
        
        function updateSearchTagsSelection() {
            const values = [...getFieldValues('search-pos', 8), $('search-pet')?.value.trim()].filter(v => v).map(normalize);
            document.querySelectorAll('#quick-tags-container .quick-tag').forEach(tag => {
                tag.classList.toggle('selected', values.includes(tag.textContent.toLowerCase()));
            });
        }
        
        function searchFormations() {
            const searchHeroes = getFieldValues('search-pos', 8).filter(v => v).map(normalize);
            const searchPet = normalize($('search-pet').value);
            
            if (!searchHeroes.length && !searchPet) { showToast(t('search.enterAtLeastOne'), true); return; }
            
            const results = allFormations.map(f => {
                const enemyHeroes = f.enemy.filter(h => h).map(normalize);
                const enemyPet = normalize(f.enemyPet);
                const matchedHeroes = searchHeroes.filter(sh => enemyHeroes.some(eh => eh === sh || eh.startsWith(sh)));
                const petMatched = searchPet && (enemyPet === searchPet || enemyPet.startsWith(searchPet));
                const score = matchedHeroes.length + (petMatched ? 1 : 0);
                return score > 0 ? { formation: f, matchedHeroes, petMatched, score, maxScore: searchHeroes.length + (searchPet ? 1 : 0) } : null;
            }).filter(Boolean).sort((a, b) => b.score - a.score);
            
            displayResults(results, searchHeroes);
        }
        
        function displayResults(results, searchHeroes) {
            if (!results.length) {
                $('results-section').innerHTML = `<div class="empty-state"><p>${t('search.noResults')}</p></div>`;
                return;
            }
            
            $('results-section').innerHTML = `<div class="results-header"><h3>${t('search.results')}</h3><span class="results-count">${t('search.found')}: ${results.length}</span></div>` +
                results.map(r => {
                    const f = r.formation;
                    const enemyDisplay = f.enemy.filter(h => h).map(h => r.matchedHeroes.some(mh => normalize(h) === mh || normalize(h).startsWith(mh)) ? `<span class="matched-hero">${h}</span>` : h).join(', ');
                    const petDisplay = r.petMatched ? `<span class="matched-hero">${f.enemyPet}</span>` : (f.enemyPet || '—');
                    const missingHeroes = searchHeroes.filter(sh => !r.matchedHeroes.includes(sh));
                    return `<div class="result-card" onclick="showFormation(${f.id})"><div class="result-card-header"><span class="result-id">ID: ${f.id}${f.isBase ? '' : ` <span class="badge user-badge">${t('badge.user')}</span>`}</span><span class="match-score match-${Math.min(r.score, 6)}">${r.score}/${r.maxScore}</span></div><div class="result-name">${f.name}</div><div class="result-heroes">${t('search.enemy')}: ${enemyDisplay} + ${petDisplay}</div>${missingHeroes.length ? `<div class="result-missing">❌ ${t('search.missing')}: ${missingHeroes.join(', ')}</div>` : ''}</div>`;
                }).join('');
        }
        
        function clearSearch() {
            for (let i = 1; i <= 8; i++) $(`search-pos${i}`).value = '';
            $('search-pet').value = '';
            $('results-section').innerHTML = `<div class="empty-state"><p>${t('search.emptyState')}</p></div>`;
            document.querySelectorAll('.quick-tag.selected').forEach(t => t.classList.remove('selected'));
            $('search-counter')?.remove();
        }
        
        // =====================================================
        // FORMULARZ DODAWANIA
        // =====================================================
        
        function addTagToActiveField(value, type) {
            if (!activeAddField) { showToast(currentLang === 'pl' ? 'Najpierw kliknij w pole!' : 'Click a field first!', true); return; }
            
            const input = $(activeAddField);
            if (!input) return;
            
            const isPetField = activeAddField.includes('Pet');
            const isHeroTag = !['Gladis','Nasrune','Romanelle','Tianum','Hamm','Spooky','Mystet','Bloombell','Silbren','Vailo','Estelle','Banavi','Moko'].includes(value);
            
            if (isPetField && isHeroTag) { showToast(currentLang === 'pl' ? 'To pole jest na Peta!' : 'This field is for Pet!', true); return; }
            if (!isPetField && !isHeroTag) { showToast(currentLang === 'pl' ? 'Wybierz pole Pet!' : 'Select a Pet field!', true); return; }
            
            const isMySection = activeAddField.includes('add-my');
            const sectionFields = isPetField ? [isMySection ? 'add-myPet' : 'add-enemyPet'] : 
                (isMySection ? [1,2,3,4,5,6,7,8].map(i => `add-my${i}`) : [1,2,3,4,5,6,7,8].map(i => `add-enemy${i}`));
            
            for (const fieldId of sectionFields) {
                const field = $(fieldId);
                if (field?.value.trim().toLowerCase() === value.toLowerCase()) {
                    field.value = '';
                    setValidation(field, null);
                    updateAddFormTagsSelection();
                    return;
                }
            }
            
            input.value = value;
            setValidation(input, true);
            updateAddFormTagsSelection();
        }
        
        function updateAddFormTagsSelection() {
            const isMySection = activeAddField ? activeAddField.includes('add-my') : true;
            const activeValues = [];
            
            const prefix = isMySection ? 'add-my' : 'add-enemy';
            for (let i = 1; i <= 8; i++) {
                const val = $(`${prefix}${i}`)?.value.trim().toLowerCase();
                if (val) activeValues.push(val);
            }
            const pet = $(`${prefix}Pet`)?.value.trim().toLowerCase();
            if (pet) activeValues.push(pet);
            
            document.querySelectorAll('#add-form-tags-container .quick-tag').forEach(tag => {
                tag.classList.toggle('selected', activeValues.includes(tag.textContent.toLowerCase()));
            });
            
            updateAddFormCounter();
        }
        
        function updateAddFormCounter() {
            // Liczymy tylko wypełnione pola (max 5 heroes + 1 pet = 6 na każdą stronę)
            let myHeroes = 0, myPet = 0, enemyHeroes = 0, enemyPet = 0;
            
            for (let i = 1; i <= 8; i++) {
                if ($(`add-my${i}`)?.value.trim()) myHeroes++;
                if ($(`add-enemy${i}`)?.value.trim()) enemyHeroes++;
            }
            if ($('add-myPet')?.value.trim()) myPet = 1;
            if ($('add-enemyPet')?.value.trim()) enemyPet = 1;
            
            const myTotal = Math.min(myHeroes, 5) + myPet; // Max 5 bohaterów + 1 pet
            const enemyTotal = Math.min(enemyHeroes, 5) + enemyPet;
            
            let counter = $('add-form-counter');
            if (myHeroes > 0 || enemyHeroes > 0 || myPet || enemyPet) {
                if (!counter) {
                    counter = document.createElement('div');
                    counter.id = 'add-form-counter';
                    counter.className = 'search-counter';
                    counter.style.cssText = 'display:block;width:100%;margin-bottom:15px;';
                    $('add-form-tags-container')?.parentNode.insertBefore(counter, $('add-form-tags-container'));
                }
                const yourLabel = currentLang === 'en' ? 'Your team' : 'Twój skład';
                const enemyLabel = currentLang === 'en' ? 'Enemy' : 'Przeciwnik';
                counter.innerHTML = `⚔️ ${yourLabel}: <strong>${myTotal}</strong>/6 &nbsp;│&nbsp; 👹 ${enemyLabel}: <strong>${enemyTotal}</strong>/6`;
            } else counter?.remove();
        }
        
		async function saveFormation() {
			if (!isOnline) { showToast(t('common.noConnection'), true); return; }
			
			let name = $('add-name').value.trim();
			
			// Jeśli brak nazwy, wygeneruj automatycznie
			if (!name) {
				const now = new Date();
				const dateStr = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
				const timeStr = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
				name = `${dateStr} ${timeStr}`;
			}
			
			const my = getFieldValues('add-my', 8);
			const enemy = getFieldValues('add-enemy', 8);
			const myPet = $('add-myPet').value.trim();
			const enemyPet = $('add-enemyPet').value.trim();
			
			if (!my.filter(h => h).length && !enemy.filter(h => h).length) { showToast(t('add.addAtLeastOne'), true); return; }
			
			const allHeroNames = heroes.map(h => h.name.toLowerCase());
			const invalidHeroes = [...my, ...enemy].filter(h => h && !allHeroNames.includes(h.toLowerCase()));
			if (invalidHeroes.length) { showToast(`${t('add.unknownHeroes')}: ${invalidHeroes.slice(0, 3).join(', ')}`, true); return; }
			
			const allPetNames = pets.map(p => getPetName(p).toLowerCase());
			const invalidPets = [myPet, enemyPet].filter(p => p && !allPetNames.includes(p.toLowerCase()));
			if (invalidPets.length) { showToast(`${t('add.unknownPets')}: ${invalidPets.join(', ')}`, true); return; }
			
			const newId = allFormations.length ? Math.max(...allFormations.map(f => f.id)) + 1 : 1;
			
			// Checkbox isBase - tylko admin może oznaczyć jako bazową
			const isBase = isAdmin && $('add-isBase')?.checked || false;
			
			try {
				await formationsRef.child(String(newId)).set({
					id: newId, name, my, myPet, enemy, enemyPet,
					comment: $('add-comment').value.trim(),
					isBase: isBase,
					dateAdded: new Date().toISOString()
				});
				showToast(`${t('add.saved')} #${newId}${isBase ? ' (BAZA)' : ''}!`);
				clearAddForm();
			} catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
		}
        
		function clearAddForm() {
			$('add-name').value = '';
			$('add-comment').value = '';
			for (let i = 1; i <= 8; i++) {
				[$(`add-my${i}`), $(`add-enemy${i}`)].forEach(el => { if (el) { el.value = ''; setValidation(el, null); } });
			}
			[$('add-myPet'), $('add-enemyPet')].forEach(el => { if (el) { el.value = ''; setValidation(el, null); } });
			// Reset checkbox
			const isBaseCheckbox = $('add-isBase');
			if (isBaseCheckbox) isBaseCheckbox.checked = false;
			updateAddFormTagsSelection();
		}
        
        // =====================================================
        // QUICK SELECT MODAL
        // =====================================================
        
        function openQuickSelect(targetId, label) {
            quickSelectTarget = targetId;
            $('quick-select-target').innerHTML = `${t('quickSelect.selectFor')}: <strong>${label}</strong>`;
            
            const isPet = targetId.includes('Pet');
            const raceGroups = { Dark: [], Light: [], Human: [], Fire: [], Elf: [], Undead: [] };
            if (!isPet) heroes.forEach(h => raceGroups[h.race]?.push(h.name));
            RACE_ORDER.forEach(r => raceGroups[r].sort((a, b) => a.localeCompare(b)));
            
            $('quick-select-tags').innerHTML = isPet ? 
                `<div class="quick-tags-section"><div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)"><span class="toggle-icon">▶</span> 🐾 ${t('quickTags.pets')}</div><div class="quick-tags-content show"><div class="quick-tags">${pets.map(p => `<span class="quick-tag tag-pet" onclick="selectQuickItem('${getPetName(p)}')">${getPetName(p)}</span>`).join('')}</div></div></div>` :
                RACE_ORDER.filter(r => raceGroups[r].length).map(r => `<div class="quick-tags-section"><div class="quick-tags-header expanded" onclick="toggleQuickTagSection(this)"><span class="toggle-icon">▶</span>${RACE_EMOJI[r]} ${r} (${raceGroups[r].length})</div><div class="quick-tags-content show"><div class="quick-tags">${raceGroups[r].map(n => `<span class="quick-tag tag-${r.toLowerCase()}" onclick="selectQuickItem('${n}')">${n}</span>`).join('')}</div></div></div>`).join('');
            
            $('quick-select-modal').classList.remove('hidden');
        }
        
        function selectQuickItem(value) {
            if (quickSelectTarget) $(quickSelectTarget).value = value;
            closeQuickSelect();
        }
        
        function closeQuickSelect() {
            $('quick-select-modal').classList.add('hidden');
            quickSelectTarget = null;
        }
        
        // =====================================================
        // BAZA DANYCH
        // =====================================================
        function setDbFilter(filter) {
            currentDbFilter = filter;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.toggle('active', b.dataset.filter === filter));
            filterDatabase();
        }
		
		function setDbSort(sort) {
			currentDbSort = sort;
			document.querySelectorAll('.sort-btn[data-sort]').forEach(b => b.classList.toggle('active', b.dataset.sort === sort));
			filterDatabase();
		}

		function sortFormations(formations) {
			const sorted = [...formations];
			
			switch (currentDbSort) {
				case 'id-asc':
					sorted.sort((a, b) => a.id - b.id);
					break;
				case 'id-desc':
					sorted.sort((a, b) => b.id - a.id);
					break;
				case 'name-asc':
					sorted.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'pl'));
					break;
				case 'name-desc':
					sorted.sort((a, b) => (b.name || '').localeCompare(a.name || '', 'pl'));
					break;
				case 'date-desc':
					sorted.sort((a, b) => {
						const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
						const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
						return dateB - dateA;
					});
					break;
				case 'date-asc':
					sorted.sort((a, b) => {
						const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
						const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
						return dateA - dateB;
					});
					break;
			}
			
			return sorted;
		}
        
		function filterDatabase() {
			const searchTerm = normalize($('db-search')?.value || '');
			let formations = allFormations;
			
			if (currentDbFilter === 'base') formations = formations.filter(f => f.isBase);
			else if (currentDbFilter === 'user') formations = formations.filter(f => !f.isBase);
			else if (currentDbFilter === 'favorites') formations = formations.filter(f => favorites.includes(f.id));
			
			if (searchTerm) formations = formations.filter(f => normalize(f.name).includes(searchTerm));
			
			// Sortowanie
			formations = sortFormations(formations);
			
		$('database-list').innerHTML = formations.length ? formations.map(f => `
			<div class="db-item" onclick="showFormation(${f.id})">
				<div class="db-item-info">
					<div class="db-item-header"><span class="db-item-id">#${f.id}</span><span class="badge ${f.isBase ? 'base-badge' : 'user-badge'}">${t(f.isBase ? 'badge.base' : 'badge.user')}</span></div>
					<div class="db-item-name">${f.name}</div>
					<div class="db-item-details"><div>⚔️ ${f.my.filter(h => h).join(', ') || '—'} + ${f.myPet || '—'}</div><div>👹 ${f.enemy.filter(h => h).join(', ') || '—'} + ${f.enemyPet || '—'}</div></div>
				</div>
				<div class="db-item-date">${formatDate(f.dateAdded) ? `📅 ${formatDate(f.dateAdded)}` : ''}</div>
				<div class="db-item-actions">
					<button class="btn btn-small ${isFavorite(f.id) ? 'btn-favorite-active' : ''}" onclick="toggleFavorite(${f.id}, event)">${isFavorite(f.id) ? '⭐' : '☆'}</button>
					<button class="btn btn-small" onclick="event.stopPropagation(); showFormation(${f.id})">👁️</button>
					${isAdmin ? `<button class="btn btn-small btn-admin" onclick="event.stopPropagation(); openEditModal(${f.id})">✏️</button>` : ''}
					${isAdmin ? `<button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteFormation(${f.id})">🗑️</button>` : ''}
				</div>
			</div>`).join('') : `<div class="empty-state"><p>${t('database.noFormations')}</p></div>`;
        }
        
        // =====================================================
        // ULUBIONE
        // =====================================================
        
        const isFavorite = id => favorites.includes(id);
        
        function toggleFavorite(id, event) {
            event?.stopPropagation();
            const idx = favorites.indexOf(id);
            if (idx > -1) favorites.splice(idx, 1);
            else favorites.push(id);
            localStorage.setItem('souls_favorites', JSON.stringify(favorites));
            showToast(t(idx > -1 ? 'common.removedFromFavorites' : 'common.addedToFavorites'));
            filterDatabase();
        }
        
        function toggleFavoritePreview(id) {
            toggleFavorite(id);
            showFormation(id);
        }
        
        // =====================================================
        // PODGLĄD FORMACJI
        // =====================================================
        
        function lookupById() {
            const id = parseInt($('lookup-id').value.trim());
            if (!id || id < 1) { showToast(t('preview.invalidId'), true); return; }
            showFormation(id);
        }
        
        function showFormation(id) {
            const f = allFormations.find(x => x.id === id);
            if (!f) {
                $('formation-display').innerHTML = `<div class="empty-state"><p>${t('preview.notFound')} #${id}</p></div>`;
                return;
            }
            
            switchTab('view');
            $('lookup-id').value = id;
            
            const isFav = isFavorite(id);
            
			$('formation-display').innerHTML = `
				<div class="formation-preview">
					<div class="preview-header">
						<div class="preview-title"><span class="preview-id">#${f.id}</span>${f.name}<span class="formation-type-badge ${f.isBase ? 'base' : 'user'}">${t(f.isBase ? 'badge.base' : 'badge.user')}</span></div>
						<div class="preview-actions">
							${isAdmin ? `<button class="btn btn-small btn-admin" onclick="openEditModal(${id})">✏️</button>` : ''}
							<button class="btn btn-small ${isFav ? 'btn-favorite-active' : 'btn-secondary'}" onclick="toggleFavoritePreview(${id})">${isFav ? '⭐' : '☆'}</button>
						</div>
					</div>
					<div class="preview-meta">
						${formatDate(f.dateAdded) ? `<span class="preview-meta-item">📅 ${t('preview.added')}: ${formatDate(f.dateAdded)}</span>` : ''}
						${formatDate(f.lastEdited) ? `<span class="preview-meta-item">✏️ ${t('preview.edited')}: ${formatDate(f.lastEdited)}</span>` : ''}
					</div>
					<div class="battle-section enemy">
                        <div class="battle-title enemy-title"><span class="title-icon">👹</span>${t('preview.enemy')}</div>
                        <div style="text-align:center">${renderBattlePet(f.enemyPet)}</div>
                        ${renderBattleGrid(f.enemy, true)}
                        <div class="battle-arrows animated"><div class="battle-arrow down"></div></div>
                    </div>
                    <div class="vs-separator"><span class="vs-badge">VS</span></div>
                    <div class="battle-section player">
                        <div class="battle-arrows animated"><div class="battle-arrow up"></div></div>
                        ${renderBattleGrid(f.my, false)}
                        <div style="text-align:center">${renderBattlePet(f.myPet)}</div>
                        <div class="battle-title player-title"><span class="title-icon">⚔️</span>${t('preview.yourTeam')}</div>
                    </div>
                    ${f.comment ? `<div class="preview-comment"><span class="comment-icon">💬</span>${f.comment}</div>` : ''}
                </div>`;
        }
        
        function renderBattleGrid(arr, isEnemy) {
            const slot = i => {
                const name = arr[i] || '';
                if (!name) return `<div class="battle-slot empty"></div>`;
                const hero = heroes.find(h => h.name.toLowerCase() === name.toLowerCase());
                const rc = hero ? `race-${hero.race.toLowerCase()}` : '';
                return `<div class="battle-slot filled ${rc}"><span class="hero-name">${name}</span></div>`;
            };
            
            return isEnemy ? `<div class="battle-grid"><div class="battle-row">${slot(5)}${slot(6)}${slot(7)}</div><div class="battle-row">${slot(3)}${slot(4)}</div><div class="battle-row">${slot(0)}${slot(1)}${slot(2)}</div></div>` :
                `<div class="battle-grid"><div class="battle-row">${slot(0)}${slot(1)}${slot(2)}</div><div class="battle-row">${slot(3)}${slot(4)}</div><div class="battle-row">${slot(5)}${slot(6)}${slot(7)}</div></div>`;
        }
        
        function renderBattlePet(name) {
            return name ? `<div class="battle-pet filled"><span class="pet-icon">🐾</span><span>${name}</span></div>` :
                `<div class="battle-pet empty"><span class="pet-icon">🐾</span><span>${t('preview.noPet')}</span></div>`;
        }
        
		// =====================================================
		// EDYCJA FORMACJI
		// =====================================================
		function openEditModal(id) {
			if (!isAdmin) { showToast(t('common.adminRequired') || 'Tylko admin może edytować!', true); return; }
			
			const f = allFormations.find(x => x.id === id);
			if (!f) { showToast(t('preview.notFound'), true); return; }
			
			editingFormationId = id;
			
			// Wypełnij formularz danymi
			$('edit-id').textContent = id;
			$('edit-name').value = f.name || '';
			$('edit-comment').value = f.comment || '';
			
			// Checkbox isBase
			const isBaseCheckbox = $('edit-isBase');
			if (isBaseCheckbox) isBaseCheckbox.checked = f.isBase || false;
			
			// Twój skład
			for (let i = 1; i <= 8; i++) {
				const el = $(`edit-my${i}`);
				if (el) el.value = f.my[i - 1] || '';
			}
			$('edit-myPet').value = f.myPet || '';
			
			// Skład przeciwnika
			for (let i = 1; i <= 8; i++) {
				const el = $(`edit-enemy${i}`);
				if (el) el.value = f.enemy[i - 1] || '';
			}
			$('edit-enemyPet').value = f.enemyPet || '';
			
			$('edit-modal').classList.remove('hidden');
		}

		function closeEditModal() {
			$('edit-modal').classList.add('hidden');
			editingFormationId = null;
		}

		async function saveEditFormation() {
			if (!isAdmin || !editingFormationId) return;
			if (!isOnline) { showToast(t('common.noConnection'), true); return; }
			
			let name = $('edit-name').value.trim();
			
			// Jeśli brak nazwy, wygeneruj automatycznie
			if (!name) {
				const now = new Date();
				const dateStr = now.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit', year: 'numeric' });
				const timeStr = now.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' });
				name = `${dateStr} ${timeStr}`;
			}
			
			// Pobierz dane z formularza
			const my = [];
			for (let i = 1; i <= 8; i++) {
				my.push($(`edit-my${i}`)?.value.trim() || '');
			}
			
			const enemy = [];
			for (let i = 1; i <= 8; i++) {
				enemy.push($(`edit-enemy${i}`)?.value.trim() || '');
			}
			
			const myPet = $('edit-myPet').value.trim();
			const enemyPet = $('edit-enemyPet').value.trim();
			const comment = $('edit-comment').value.trim();
			
			// Checkbox isBase
			const isBase = $('edit-isBase')?.checked || false;
			
			try {
				await formationsRef.child(String(editingFormationId)).update({
					name,
					my,
					myPet,
					enemy,
					enemyPet,
					comment,
					isBase,
					lastEdited: new Date().toISOString()
				});
				
				showToast(`✅ Zaktualizowano formację #${editingFormationId}${isBase ? ' (BAZA)' : ''}`);
				closeEditModal();
				
				// Odśwież podgląd jeśli jest otwarty
				if ($('lookup-id').value == editingFormationId) {
					showFormation(editingFormationId);
				}
				// Odśwież listę w bazie danych
				filterDatabase();
			} catch (e) {
				showToast(`${t('common.error')}: ${e.message}`, true);
			}
		}
		
        // =====================================================
        // USUWANIE
        // =====================================================
		async function deleteFormation(id) {
			const f = allFormations.find(x => x.id === id);
			if (!f) return;
			if (!isAdmin) { showToast(t('common.adminRequired') || 'Tylko admin może usuwać formacje!', true); return; }
			if (!confirm(`${t('common.confirmDelete')} #${id}: "${f.name}"?`)) return;
            
            try {
                await formationsRef.child(String(id)).remove();
                showToast(t('common.formationDeleted'));
            } catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        async function deleteAllUserFormations() {
            if (!confirm(t('admin.confirmDeleteAllUser'))) return;
            try {
                const userF = allFormations.filter(f => !f.isBase);
                for (const f of userF) await formationsRef.child(String(f.id)).remove();
                showToast(`${t('admin.deletedUserFormations')}: ${userF.length}`);
            } catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        // =====================================================
        // ADMIN
        // =====================================================
        
        function headerClick() {
            headerClickCount++;
            clearTimeout(headerClickTimer);
            if (headerClickCount >= 5) {
                headerClickCount = 0;
                isAdmin ? showToast(t('admin.alreadyLogged')) : $('admin-modal').classList.remove('hidden');
            } else headerClickTimer = setTimeout(() => headerClickCount = 0, 2000);
        }
        
        function closeAdminModal() {
            $('admin-modal').classList.add('hidden');
            $('admin-password').value = '';
        }
        
		async function tryAdminLogin() {
			const password = $('admin-password').value;
			if (!password) {
				showToast('❌ ' + t('admin.wrongPassword'), true);
				return;
			}
			
			const hash = await hashPassword(password);
			
			if (hash === ADMIN_PASSWORD_HASH) {
				isAdmin = true;
				localStorage.setItem('souls_admin', hash);
				closeAdminModal();
				enableAdminMode();
				showToast('🔓 ' + t('admin.loggedIn'));
			} else {
				showToast('❌ ' + t('admin.wrongPassword'), true);
				$('admin-password').value = '';
			}
		}
        
		function enableAdminMode() {
			isAdmin = true;
			$('admin-badge').style.display = 'inline';
			$('nav-admin').classList.add('show');
			$('nav-settings').classList.add('show');
			$('nav-war').classList.add('show');
			// Pokaż opcję "formacja bazowa" w formularzu dodawania
			const baseOption = $('add-base-option');
			if (baseOption) baseOption.style.display = 'block';
			renderHeroesList();
			renderPetsList();
			filterDatabase();
		}
        
		function adminLogout() {
			isAdmin = false;
			localStorage.removeItem('souls_admin');
			$('admin-badge').style.display = 'none';
			$('nav-admin').classList.remove('show');
			$('nav-settings').classList.remove('show');
			$('nav-war').classList.remove('show');
			// Ukryj opcję "formacja bazowa" w formularzu dodawania
			const baseOption = $('add-base-option');
			if (baseOption) baseOption.style.display = 'none';
			switchTab('search');
			filterDatabase();
			showToast('🚪 ' + t('admin.loggedOut'));
		}
        
        function renderHeroesList() {
            $('heroes-count').textContent = heroes.length;
            const byRace = {};
            heroes.forEach(h => { (byRace[h.race] = byRace[h.race] || []).push(h); });
            
            $('heroes-list').innerHTML = Object.keys(byRace).sort().map(r =>
                `<div style="font-size:0.7rem;color:var(--accent-gold);margin:10px 0 5px;border-bottom:1px solid var(--border);padding-bottom:3px;">${r} (${byRace[r].length})</div>` +
                byRace[r].map(h => `<div class="entity-item"><span class="entity-name">${h.name}</span><button class="btn btn-danger btn-small" onclick="deleteHero('${h.name}')">🗑️</button></div>`).join('')
            ).join('') || `<p style="color:var(--text-muted);text-align:center;">${t('database.noFormations')}</p>`;
        }
        
        function renderPetsList() {
            $('pets-count').textContent = pets.length;
            $('pets-list').innerHTML = pets.map(p => `<div class="entity-item"><span class="entity-name">🐾 ${p}</span><button class="btn btn-danger btn-small" onclick="deletePet('${p}')">🗑️</button></div>`).join('') ||
                `<p style="color:var(--text-muted);text-align:center;">${t('database.noFormations')}</p>`;
        }
        
        async function addHero() {
            const name = $('new-hero-name').value.trim();
            const race = $('new-hero-race').value;
            if (!name) { showToast(t('admin.enterHeroName'), true); return; }
            if (heroes.some(h => h.name.toLowerCase() === name.toLowerCase())) { showToast(t('admin.heroExists'), true); return; }
            try {
                await heroesRef.child(name).set({ name, race });
                $('new-hero-name').value = '';
                showToast(`${t('admin.heroAdded')}: ${name}`);
            } catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        async function deleteHero(name) {
            if (!confirm(`${t('admin.confirmDeleteHero')} "${name}"?`)) return;
            try { await heroesRef.child(name).remove(); showToast(`${t('admin.heroDeleted')}: ${name}`); }
            catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        async function addPet() {
            const name = $('new-pet-name').value.trim();
            if (!name) { showToast(t('admin.enterPetName'), true); return; }
            if (pets.some(p => p.toLowerCase() === name.toLowerCase())) { showToast(t('admin.petExists'), true); return; }
            try {
                await petsRef.child(name).set({ name });
                $('new-pet-name').value = '';
                showToast(`${t('admin.petAdded')}: ${name}`);
            } catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        async function deletePet(name) {
            if (!confirm(`${t('admin.confirmDeletePet')} "${name}"?`)) return;
            try { await petsRef.child(name).remove(); showToast(`${t('admin.heroDeleted')}: ${name}`); }
            catch (e) { showToast(`${t('common.error')}: ${e.message}`, true); }
        }
        
        // =====================================================
        // IMPORT / EKSPORT
        // =====================================================
		function exportToCSV() {
			const headers = [
				'Lp', 'Nazwa',
				'moja1', 'moja2', 'moja3', 'moja4', 'moja5', 'moja6', 'moja7', 'moja8', 'mojPet',
				'enemy1', 'enemy2', 'enemy3', 'enemy4', 'enemy5', 'enemy6', 'enemy7', 'enemy8', 'enemyPet',
				'Komentarz', 'CzyBazowa'
			];
			
			const escapeCSV = (val) => {
				const str = String(val || '');
				// Jeśli zawiera przecinek, średnik, cudzysłów lub nową linię - owijamy w cudzysłowy
				if (str.includes(';') || str.includes(',') || str.includes('"') || str.includes('\n')) {
					return `"${str.replace(/"/g, '""')}"`;
				}
				return str;
			};
			
			const rows = allFormations.map(f => {
				// Upewnij się że my i enemy mają 8 elementów
				const myArr = f.my || [];
				const enemyArr = f.enemy || [];
				while (myArr.length < 8) myArr.push('');
				while (enemyArr.length < 8) enemyArr.push('');
				
				return [
					f.id,
					escapeCSV(f.name),
					...myArr.map(h => escapeCSV(h)),
					escapeCSV(f.myPet),
					...enemyArr.map(h => escapeCSV(h)),
					escapeCSV(f.enemyPet),
					escapeCSV(f.comment),
					f.isBase ? '1' : '0'
				].join(';');
			});
			
			const blob = new Blob(['\ufeff' + [headers.join(';'), ...rows].join('\n')], { type: 'text/csv;charset=utf-8;' });
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = `TABELA_${new Date().toISOString().slice(0,10)}.csv`;
			a.click();
			showToast(`${t('settings.exported')} ${allFormations.length} ${t('status.formations')}`);
		}
        
		async function importFromCSV(event) {
			const file = event.target.files[0];
			if (!file) return;
			if (!isOnline) { showToast(t('common.noConnection'), true); return; }
			
			const reader = new FileReader();
			reader.onload = async e => {
				try {
					const lines = e.target.result.split('\n').filter(l => l.trim());
					if (lines.length < 2) { showToast('Plik jest pusty lub ma tylko nagłówki', true); return; }
					
					const sep = lines[0].includes(';') ? ';' : ',';
					const headers = parseCSVLine(lines[0], sep).map(h => h.toLowerCase().trim());
					
					// Sprawdź czy mamy nowy format (z komentarzem) czy stary
					const hasComment = headers.includes('komentarz') || headers.length >= 22;
					
					let imported = 0, skipped = 0;
					let maxId = allFormations.length ? Math.max(...allFormations.map(f => f.id)) : 0;
					const existingIds = allFormations.map(f => f.id);
					
					for (let i = 1; i < lines.length; i++) {
						const vals = parseCSVLine(lines[i], sep);
						if (vals.length < 20) { skipped++; continue; }
						
						// Określ czy pierwsza kolumna to ID
						const startIdx = vals[0].match(/^\d+$/) ? 1 : 0;
						
						// Generuj nowe unikalne ID
						while (existingIds.includes(++maxId));
						existingIds.push(maxId);
						
						// Parsuj pola
						const myHeroes = vals.slice(startIdx + 1, startIdx + 9).map(cleanVal);
						const myPet = cleanVal(vals[startIdx + 9]);
						const enemyHeroes = vals.slice(startIdx + 10, startIdx + 18).map(cleanVal);
						const enemyPet = cleanVal(vals[startIdx + 18]);
						
						// Komentarz i isBase (jeśli dostępne)
						let comment = '';
						let isBase = false;
						
						if (hasComment && vals.length >= startIdx + 21) {
							comment = cleanVal(vals[startIdx + 19]);
							isBase = cleanVal(vals[startIdx + 20]) === '1';
						}
						
						await formationsRef.child(String(maxId)).set({
							id: maxId,
							name: cleanVal(vals[startIdx]) || `Import #${maxId}`,
							my: myHeroes,
							myPet: myPet,
							enemy: enemyHeroes,
							enemyPet: enemyPet,
							comment: comment,
							isBase: isBase,
							dateAdded: new Date().toISOString()
						});
						imported++;
					}
					
					let msg = `${t('settings.imported')} ${imported} ${t('status.formations')}!`;
					if (skipped > 0) msg += ` (${skipped} pominięto)`;
					showToast(msg);
					
				} catch (e) { 
					console.error('Import error:', e);
					showToast(`${t('common.error')}: ${e.message}`, true); 
				}
			};
			reader.readAsText(file);
			event.target.value = '';
		}
        
        function parseCSVLine(line, sep = ';') {
            const result = [];
            let current = '', inQuotes = false;
            for (const char of line) {
                if (char === '"') inQuotes = !inQuotes;
                else if (char === sep && !inQuotes) { result.push(current); current = ''; }
                else current += char;
            }
            result.push(current);
            return result;
        }
        
        const cleanVal = v => (v || '').replace(/"/g, '').trim();
        const refreshData = () => location.reload();
        
        // =====================================================
        // PLANER WOJNY - 3 SKŁADY
        // =====================================================
        
        function getWarEnemyTeam(enemyNum) {
            const heroes = [];
            for (let i = 1; i <= 8; i++) {
                const val = $(`war-e${enemyNum}-h${i}`)?.value.trim();
                if (val) heroes.push(normalize(val));
            }
            const pet = $(`war-e${enemyNum}-pet`)?.value.trim();
            return { heroes, pet: pet ? normalize(pet) : null };
        }
        
        function findMatchingFormations(enemyTeam, minMatch = 1) {
            const results = [];
            
            allFormations.forEach(f => {
                const enemyHeroes = f.enemy.filter(h => h).map(normalize);
                const enemyPet = normalize(f.enemyPet);
                
                // Licz dopasowania
                let matchedHeroes = enemyTeam.heroes.filter(eh => 
                    enemyHeroes.some(feh => feh === eh || feh.startsWith(eh) || eh.startsWith(feh))
                );
                
                const petMatched = enemyTeam.pet && enemyPet && 
                    (enemyPet === enemyTeam.pet || enemyPet.startsWith(enemyTeam.pet));
                
                const score = matchedHeroes.length + (petMatched ? 1 : 0);
                const maxScore = enemyTeam.heroes.length + (enemyTeam.pet ? 1 : 0);
                
                if (score >= minMatch) {
                    results.push({
                        formation: f,
                        score,
                        maxScore,
                        matchedHeroes,
                        petMatched
                    });
                }
            });
            
            return results.sort((a, b) => b.score - a.score);
        }
        
        function countHeroConflicts(formations) {
            const heroCount = {};
            const conflicts = [];
            
            formations.forEach((f, idx) => {
                f.formation.my.filter(h => h).forEach(hero => {
                    const h = normalize(hero);
                    if (!heroCount[h]) heroCount[h] = [];
                    heroCount[h].push(idx);
                });
            });
            
            // Znajdź konflikty (bohaterowie użyci więcej niż raz)
            Object.entries(heroCount).forEach(([hero, indices]) => {
                if (indices.length > 1) {
                    conflicts.push({ hero, usedIn: indices, count: indices.length });
                }
            });
            
            return {
                total: conflicts.reduce((sum, c) => sum + c.count - 1, 0),
                details: conflicts
            };
        }
        
        function findWarFormations() {
            const enemy1 = getWarEnemyTeam(1);
            const enemy2 = getWarEnemyTeam(2);
            const enemy3 = getWarEnemyTeam(3);
            
            // Sprawdź czy wprowadzono przynajmniej po jednym bohaterze
            if (!enemy1.heroes.length && !enemy2.heroes.length && !enemy3.heroes.length) {
                showToast('Wpisz przynajmniej jednego bohatera w każdym składzie!', true);
                return;
            }
            
            // Znajdź pasujące formacje dla każdego wroga
            const matches1 = findMatchingFormations(enemy1, 1).slice(0, 20);
            const matches2 = findMatchingFormations(enemy2, 1).slice(0, 20);
            const matches3 = findMatchingFormations(enemy3, 1).slice(0, 20);
            
            if (!matches1.length || !matches2.length || !matches3.length) {
                $('war-results-section').innerHTML = `
                    <div class="empty-state">
                        <p>❌ Nie znaleziono pasujących formacji dla wszystkich wrogów.</p>
                        <p style="font-size: 0.8rem; margin-top: 10px;">
                            Wróg 1: ${matches1.length} formacji<br>
                            Wróg 2: ${matches2.length} formacji<br>
                            Wróg 3: ${matches3.length} formacji
                        </p>
                    </div>`;
                return;
            }
            
            // Generuj wszystkie kombinacje i oceń konflikty
            const combinations = [];
            
            for (const m1 of matches1) {
                for (const m2 of matches2) {
                    // Pomiń jeśli ta sama formacja
                    if (m1.formation.id === m2.formation.id) continue;
                    
                    for (const m3 of matches3) {
                        // Pomiń jeśli ta sama formacja
                        if (m1.formation.id === m3.formation.id || m2.formation.id === m3.formation.id) continue;
                        
                        const conflicts = countHeroConflicts([m1, m2, m3]);
                        const totalScore = m1.score + m2.score + m3.score;
                        
                        combinations.push({
                            formations: [m1, m2, m3],
                            conflicts: conflicts.total,
                            conflictDetails: conflicts.details,
                            totalScore,
                            avgScore: totalScore / 3
                        });
                    }
                }
            }
            
			// Sortuj: priorytet dla wysokiego score z małą liczbą konfliktów
			// Wzór: score * 10 - conflicts * 5 (wysoki score jest ważniejszy)
			combinations.sort((a, b) => {
				const scoreA = a.totalScore * 10 - a.conflicts * 3;
				const scoreB = b.totalScore * 10 - b.conflicts * 3;
				if (scoreA !== scoreB) return scoreB - scoreA;
				// Przy remisie - mniej konfliktów wygrywa
				return a.conflicts - b.conflicts;
			});
            
			// Weź top 20 - pozwól na więcej opcji z konfliktami
			const top = combinations.slice(0, 20);
            
            displayWarResults(top, [enemy1, enemy2, enemy3]);
        }
        
		function displayWarResults(results, enemies) {
			if (!results.length) {
				$('war-results-section').innerHTML = `
					<div class="empty-state">
						<p>❌ Nie znaleziono żadnych kombinacji.</p>
					</div>`;
				return;
			}
			
			// Zapisz wyniki i enemies do globalnej zmiennej
			window.warResults = results.map(r => ({ ...r, enemies }));
			
			// Oblicz statystyki ogólne
			const perfectCount = results.filter(r => r.conflicts === 0).length;
			const avgScore = (results.reduce((sum, r) => sum + r.totalScore, 0) / results.length).toFixed(1);
			const maxPossibleScore = enemies.reduce((sum, e) => sum + e.heroes.length + (e.pet ? 1 : 0), 0);
			
			let html = `
				<div class="war-summary-box">
					<h3>🎯 Propozycje składów</h3>
					<div class="war-summary-stats">
						<div class="war-stat">
							<span class="war-stat-value">${results.length}</span>
							<span class="war-stat-label">kombinacji</span>
						</div>
						<div class="war-stat">
							<span class="war-stat-value ${perfectCount > 0 ? 'green' : 'orange'}">${perfectCount}</span>
							<span class="war-stat-label">idealnych</span>
						</div>
						<div class="war-stat">
							<span class="war-stat-value">${avgScore}/${maxPossibleScore}</span>
							<span class="war-stat-label">śr. trafień</span>
						</div>
					</div>
					<div class="war-legend">
						<span class="legend-item"><span class="dot green"></span> Idealne (0 konfliktów)</span>
						<span class="legend-item"><span class="dot yellow"></span> Dobre (1-2 konflikty)</span>
						<span class="legend-item"><span class="dot orange"></span> Do rozważenia (3+ konfliktów)</span>
					</div>
				</div>
				<p style="font-size:0.75rem;color:var(--text-muted);margin:15px 0;text-align:center;">
					Kliknij w propozycję aby zobaczyć szczegółowy podgląd
				</p>`;
			
			results.forEach((combo, idx) => {
				const cardClass = combo.conflicts === 0 ? 'perfect' : combo.conflicts <= 2 ? 'good' : 'conflicts';
				const badgeClass = combo.conflicts === 0 ? 'perfect' : combo.conflicts <= 2 ? 'good' : 'bad';
				const badgeText = combo.conflicts === 0 ? '✓ IDEALNE' : `${combo.conflicts} konflikt${combo.conflicts === 1 ? '' : combo.conflicts < 5 ? 'y' : 'ów'}`;
				
				// Zbierz wszystkie konfliktowe bohaterów
				const conflictHeroes = new Set();
				combo.conflictDetails.forEach(c => conflictHeroes.add(c.hero));
				
				// Oblicz ogólną ocenę (0-100%)
				const maxPossible = combo.formations.reduce((sum, m) => sum + m.maxScore, 0);
				const scorePercent = maxPossible > 0 ? Math.round((combo.totalScore / maxPossible) * 100) : 0;
				const scoreClass = scorePercent >= 80 ? 'high' : scorePercent >= 50 ? 'medium' : 'low';
				
				html += `
					<div class="war-result-card ${cardClass}" onclick="showWarPreview(${idx})">
						<div class="war-result-header">
							<span class="war-result-rank">#${idx + 1}</span>
							<div class="war-result-badges">
								<span class="war-score-badge ${scoreClass}">${scorePercent}% trafień</span>
								<span class="war-conflict-badge ${badgeClass}">${badgeText}</span>
							</div>
						</div>
						<div class="war-formations-grid">
							${combo.formations.map((m, i) => {
								const f = m.formation;
								const myHeroes = f.my.filter(h => h);
								const enemy = enemies[i];
								const scoreClass = m.score >= 4 ? 'high' : m.score >= 2 ? 'medium' : 'low';
								const matchPercent = m.maxScore > 0 ? Math.round((m.score / m.maxScore) * 100) : 0;
								
								return `
									<div class="war-formation-box">
										<h4>
											⚔️ Walka ${i + 1}
											<span class="formation-id">#${f.id}</span>
										</h4>
										<div class="heroes-list">
											${myHeroes.slice(0, 5).map(h => {
												const isConflict = conflictHeroes.has(normalize(h));
												return isConflict ? `<span class="hero-conflict">${h}</span>` : h;
											}).join(', ') || '—'}
											${myHeroes.length > 5 ? '...' : ''}
										</div>
										${f.myPet ? `<div class="pet-info">🐾 ${f.myPet}</div>` : ''}
										<div class="war-vs-enemy">
											<div class="war-match-bar">
												<div class="war-match-fill ${scoreClass}" style="width: ${matchPercent}%"></div>
											</div>
											<span class="war-match-score ${scoreClass}">${m.score}/${m.maxScore}</span>
										</div>
									</div>`;
							}).join('')}
						</div>
						${combo.conflictDetails.length ? `
							<div class="war-conflicts-summary">
								⚠️ <strong>Konflikty:</strong> ${combo.conflictDetails.map(c => 
									`<span class="conflict-hero">${c.hero}</span>`
								).join(', ')}
							</div>` : ''}
					</div>`;
			});
			
			$('war-results-section').innerHTML = html;
		}
        
		// =====================================================
		// WAR PLANNER - ZAPIS/ODCZYT Z LOCALSTORAGE
		// =====================================================

		function saveWarPlannerToStorage() {
			const data = {
				enemies: [],
				savedAt: new Date().toISOString()
			};
			
			for (let e = 1; e <= 3; e++) {
				const enemy = { heroes: [], pet: '' };
				for (let h = 1; h <= 8; h++) {
					enemy.heroes.push($(`war-e${e}-h${h}`)?.value.trim() || '');
				}
				enemy.pet = $(`war-e${e}-pet`)?.value.trim() || '';
				data.enemies.push(enemy);
			}
			
			// Zapisz tylko jeśli jest cokolwiek wypełnione
			const hasData = data.enemies.some(e => e.heroes.some(h => h) || e.pet);
			if (hasData) {
				localStorage.setItem('souls_war_planner', JSON.stringify(data));
				updateWarAutosaveInfo();
			}
		}

		function loadWarPlanner() {
			const saved = localStorage.getItem('souls_war_planner');
			if (!saved) {
				showToast('Brak zapisanych składów', true);
				return;
			}
			
			try {
				const data = JSON.parse(saved);
				
				for (let e = 1; e <= 3; e++) {
					const enemy = data.enemies[e - 1];
					if (!enemy) continue;
					
					for (let h = 1; h <= 8; h++) {
						const el = $(`war-e${e}-h${h}`);
						if (el) el.value = enemy.heroes[h - 1] || '';
					}
					const petEl = $(`war-e${e}-pet`);
					if (petEl) petEl.value = enemy.pet || '';
				}
				
				const savedDate = new Date(data.savedAt);
				const timeAgo = getTimeAgo(savedDate);
				showToast(`✅ Wczytano składy (${timeAgo})`);
				updateWarAutosaveInfo();
			} catch (e) {
				showToast('Błąd wczytywania danych', true);
			}
		}

		function updateWarAutosaveInfo() {
			const info = $('war-autosave-info');
			if (!info) return;
			
			const saved = localStorage.getItem('souls_war_planner');
			if (!saved) {
				info.innerHTML = '';
				return;
			}
			
			try {
				const data = JSON.parse(saved);
				const savedDate = new Date(data.savedAt);
				const timeAgo = getTimeAgo(savedDate);
				const filledCount = data.enemies.filter(e => e.heroes.some(h => h) || e.pet).length;
				info.innerHTML = `💾 Ostatni zapis: ${timeAgo} (${filledCount}/3 walki)`;
			} catch (e) {
				info.innerHTML = '';
			}
		}

		function getTimeAgo(date) {
			const now = new Date();
			const diff = Math.floor((now - date) / 1000); // sekundy
			
			if (diff < 60) return 'przed chwilą';
			if (diff < 3600) return `${Math.floor(diff / 60)} min temu`;
			if (diff < 86400) return `${Math.floor(diff / 3600)} godz. temu`;
			if (diff < 604800) return `${Math.floor(diff / 86400)} dni temu`;
			return date.toLocaleDateString('pl-PL');
		}

		function setupWarPlannerAutosave() {
			// Nasłuchuj zmian we wszystkich polach war planner
			for (let e = 1; e <= 3; e++) {
				for (let h = 1; h <= 8; h++) {
					const el = $(`war-e${e}-h${h}`);
					if (el) {
						el.addEventListener('input', debounce(saveWarPlannerToStorage, 500));
						el.addEventListener('blur', saveWarPlannerToStorage);
					}
				}
				const petEl = $(`war-e${e}-pet`);
				if (petEl) {
					petEl.addEventListener('input', debounce(saveWarPlannerToStorage, 500));
					petEl.addEventListener('blur', saveWarPlannerToStorage);
				}
			}
			
			// Pokaż info o ostatnim zapisie
			updateWarAutosaveInfo();
		}

		// Funkcja debounce - opóźnia wykonanie
		function debounce(func, wait) {
			let timeout;
			return function(...args) {
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(this, args), wait);
			};
		}
		
		function clearWarPlanner(keepStorage = false) {
			for (let e = 1; e <= 3; e++) {
				for (let h = 1; h <= 8; h++) {
					const el = $(`war-e${e}-h${h}`);
					if (el) el.value = '';
				}
				const pet = $(`war-e${e}-pet`);
				if (pet) pet.value = '';
			}
			$('war-results-section').innerHTML = `
				<div class="empty-state">
					<p>Wpisz składy 3 wrogów i kliknij "Znajdź optymalne składy"</p>
				</div>`;
			window.warResults = null;
			
			// Nie czyść storage - użytkownik może chcieć wczytać ponownie
			// Ale zaktualizuj info
			updateWarAutosaveInfo();
		}
        
        function showWarPreview(comboIndex) {
            const combo = window.warResults?.[comboIndex];
            if (!combo) return;
            window.currentWarCombo = combo;
            switchTab('war-preview');
            renderWarPreview();
        }
        
		function renderCompactGridFromArray(heroesArr, matchedHeroes, showConflicts, conflictSet, isEnemy = false) {
			const slot = (name) => {
				if (!name) return `<div class="compact-slot empty">—</div>`;
				const hero = heroes.find(h => h.name.toLowerCase() === name.toLowerCase());
				const race = hero?.race?.toLowerCase() || '';
				const normName = normalize(name);
				
				// Sprawdź czy to trafiony bohater (zielone tło)
				const isMatched = matchedHeroes.some(mh => mh === normName || mh.startsWith(normName) || normName.startsWith(mh));
				
				// Sprawdź czy to konflikt (pomarańczowe obramowanie)
				const isConflict = showConflicts && conflictSet && conflictSet.has(normName);
				
				let classes = 'compact-slot filled';
				if (race) classes += ` race-${race}`;
				if (isMatched) classes += ' matched';
				if (isConflict) classes += ' conflict';
				
				let style = race ? `border-color:var(--race-${race});color:var(--race-${race})` : '';
				
				return `<div class="${classes}" style="${style}">${name}</div>`;
			};
			
			// Użyj tablicy z zachowaniem pozycji (8 slotów)
			const h = [];
			for (let i = 0; i < 8; i++) {
				h.push(heroesArr[i] || '');
			}
			
			// Układ 3-2-3 - odwrócony dla wroga
			if (isEnemy) {
				return `
					<div class="compact-row">${slot(h[5])}${slot(h[6])}${slot(h[7])}</div>
					<div class="compact-row">${slot(h[3])}${slot(h[4])}</div>
					<div class="compact-row">${slot(h[0])}${slot(h[1])}${slot(h[2])}</div>
				`;
			} else {
				return `
					<div class="compact-row">${slot(h[0])}${slot(h[1])}${slot(h[2])}</div>
					<div class="compact-row">${slot(h[3])}${slot(h[4])}</div>
					<div class="compact-row">${slot(h[5])}${slot(h[6])}${slot(h[7])}</div>
				`;
			}
		}
		
		function renderWarPreview() {
			const combo = window.currentWarCombo;
			if (!combo) {
				$('war-preview-content').innerHTML = `<div class="empty-state"><p>Wybierz kombinację z planera wojny</p></div>`;
				return;
			}
			
			// Zbierz wszystkich bohaterów użytych w "TWÓJ SKŁAD" aby wykryć konflikty
			const allMyHeroes = {};
			combo.formations.forEach((match, idx) => {
				match.formation.my.filter(h => h).forEach(hero => {
					const h = normalize(hero);
					if (!allMyHeroes[h]) allMyHeroes[h] = [];
					allMyHeroes[h].push(idx);
				});
			});
			
			// Znajdź konflikty (bohaterowie użyci więcej niż raz)
			const conflictHeroes = new Set();
			Object.entries(allMyHeroes).forEach(([hero, indices]) => {
				if (indices.length > 1) conflictHeroes.add(hero);
			});
			
			let html = `<div class="war-preview-grid">`;
			
			combo.formations.forEach((match, idx) => {
				const f = match.formation;
				const searchedEnemy = combo.enemies[idx]; // to co user wpisał
				
				// Porównaj: które z wpisanych przez usera są w bazie
				const enemyHeroesInDb = f.enemy.filter(h => h).map(normalize);
				const searchedHeroesNorm = searchedEnemy.heroes;
				const matchedHeroes = searchedHeroesNorm.filter(sh => 
					enemyHeroesInDb.some(eh => eh === sh || eh.startsWith(sh) || sh.startsWith(eh))
				);
				const missingHeroes = searchedHeroesNorm.filter(sh => !matchedHeroes.includes(sh));
				
				html += `
				<div class="war-preview-card">
					<h3>⚔️ Walka ${idx + 1} <span style="font-size:0.7rem;color:var(--text-muted);">#${f.id}</span></h3>
					
					<div class="compact-battle-section enemy">
						<div class="compact-battle-title enemy">👹 WRÓG (z bazy)</div>
						<div style="text-align:center">
							<div class="compact-pet ${f.enemyPet ? 'filled' : 'empty'}">🐾 ${f.enemyPet || '—'}</div>
						</div>
						<div class="compact-grid">
							${renderCompactGridFromArray(f.enemy, matchedHeroes, false, null, true)}
						</div>
					</div>
					
					<div class="compact-vs">⚔️ VS ⚔️</div>
					
					<div class="compact-battle-section player">
						<div class="compact-battle-title player">⚔️ TWÓJ SKŁAD</div>
						<div class="compact-grid">
							${renderCompactGridFromArray(f.my, [], true, conflictHeroes, false)}
						</div>
						<div style="text-align:center">
							<div class="compact-pet ${f.myPet ? 'filled' : 'empty'}">🐾 ${f.myPet || '—'}</div>
						</div>
					</div>
					
					<div class="match-info">
						<div><span class="label">🔍 Szukano:</span> ${searchedHeroesNorm.map(h => h.charAt(0).toUpperCase() + h.slice(1)).join(', ') || '—'}</div>
						<div><span class="label">✅ Trafione:</span> <span class="matched">${matchedHeroes.length ? matchedHeroes.map(h => h.charAt(0).toUpperCase() + h.slice(1)).join(', ') : '—'}</span></div>
						<div><span class="label">❌ Nie znaleziono:</span> <span class="missing">${missingHeroes.length ? missingHeroes.map(h => h.charAt(0).toUpperCase() + h.slice(1)).join(', ') : '—'}</span></div>
						<div style="margin-top:5px;"><span class="label">💬</span> ${f.comment || 'Brak komentarza'}</div>
					</div>
				</div>`;
			});
			
			html += `</div>`;
			
			// Podsumowanie konfliktów
			if (conflictHeroes.size > 0) {
				const conflictList = [];
				Object.entries(allMyHeroes).forEach(([hero, indices]) => {
					if (indices.length > 1) {
						conflictList.push(`<strong style="color:#ff5722;">${hero.charAt(0).toUpperCase() + hero.slice(1)}</strong> (walki ${indices.map(i => i + 1).join(', ')})`);
					}
				});
				html += `<div class="section" style="margin-top:15px;border-color:#ff5722;">
					<h3 style="color:#ff5722;font-size:0.9rem;">⚠️ Konflikty bohaterów</h3>
					<p style="font-size:0.8rem;color:var(--text-muted);margin-top:10px;">${conflictList.join('<br>')}</p>
				</div>`;
			} else {
				html += `<div class="section" style="margin-top:15px;border-color:var(--accent-green);">
					<h3 style="color:var(--accent-green);font-size:0.9rem;">✅ Brak konfliktów!</h3>
					<p style="font-size:0.8rem;color:var(--text-muted);margin-top:10px;">Żaden bohater nie powtarza się między składami.</p>
				</div>`;
			}
			
			$('war-preview-content').innerHTML = html;
		}
        
        function setupAutocomplete() {
            document.querySelectorAll('input[data-type]').forEach(input => {
                const list = $('list-' + input.id);
                const type = input.dataset.type;

				// Dla pól war-* i edit-* używamy standardowej listy autocomplete
				const isWarField = input.id.startsWith('war-');
				const isEditField = input.id.startsWith('edit-') && !['edit-name', 'edit-comment', 'edit-id'].includes(input.id);
                let dynamicList = null;
                
				if (isWarField && !list) {
					dynamicList = document.createElement('div');
					dynamicList.className = 'autocomplete-list';
					dynamicList.id = 'list-' + input.id;
					input.parentNode.style.position = 'relative';
					input.parentNode.appendChild(dynamicList);
				}
                
                const targetList = list || dynamicList;
                if (!targetList) return;
                
                input.addEventListener('input', () => {
                    if (input.id.startsWith('add-') && !['add-name', 'add-comment'].includes(input.id)) {
                        validateInput(input);
                        updateAddFormTagsSelection();
                    }
                    if (input.id.startsWith('search-')) updateSearchTagsSelection();
                    
                    const val = input.value.toLowerCase();
                    if (val.length < 1) { targetList.classList.remove('show'); return; }
                    
                    const items = type === 'pet' ? pets : heroes;
                    const filtered = type === 'pet' ? items.filter(p => p.toLowerCase().startsWith(val)).slice(0, 6) :
                        items.filter(h => h.name.toLowerCase().startsWith(val)).slice(0, 6);
                    
                    if (!filtered.length) { targetList.classList.remove('show'); return; }
                    
                    targetList.innerHTML = filtered.map(item => type === 'pet' ?
                        `<div class="autocomplete-item" data-value="${item}">${item}</div>` :
                        `<div class="autocomplete-item race-${item.race.toLowerCase()}" data-value="${item.name}">${item.name} <span class="race">(${item.race})</span></div>`
                    ).join('');
                    
                    targetList.classList.add('show');
                    targetList.querySelectorAll('.autocomplete-item').forEach(item => {
                        item.addEventListener('click', () => {
                            input.value = item.dataset.value;
                            targetList.classList.remove('show');
                            // Walidacja tylko dla pól add-*
                            if (input.id.startsWith('add-') && !['add-name', 'add-comment'].includes(input.id)) {
                                setValidation(input, true);
                            }
                            updateAddFormTagsSelection();
                        });
                    });
                });
                
                input.addEventListener('blur', () => setTimeout(() => {
                    targetList.classList.remove('show');
                    if (input.id.startsWith('search-')) updateSearchTagsSelection();
                    if (input.id.startsWith('add-') && !['add-name', 'add-comment'].includes(input.id)) updateAddFormTagsSelection();
                }, 200));
            });
        }
        
        // =====================================================
        // INICJALIZACJA
        // =====================================================
		document.addEventListener('DOMContentLoaded', async () => {
			// Listener dla Enter przy haśle gildii
			$('guild-password')?.addEventListener('keydown', e => { if (e.key === 'Enter') tryGuildLogin(); });
			
			// Sprawdź hasło gildii PRZED wszystkim
			const hasAccess = await checkGuildAccess();
			if (!hasAccess) return;
			
			initTheme();
			setupAutocomplete();
            if (localStorage.getItem('souls_admin') === ADMIN_PASSWORD_HASH) enableAdminMode();
            applyTranslations();
            
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLanguage('${currentLang}')"]`)?.classList.add('active');
            
            $('admin-password').addEventListener('keydown', e => { if (e.key === 'Enter') tryAdminLogin(); });
            
			document.querySelectorAll('#tab-search input[data-type]').forEach(input => {
				input.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); searchFormations(); } });
				input.addEventListener('focus', () => { activeSearchField = input.id; });
				input.addEventListener('blur', () => { setTimeout(() => { activeSearchField = null; }, 200); });
			});
            
            $('lookup-id').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); lookupById(); } });
            
			$('quick-select-modal').addEventListener('click', e => { if (e.target === $('quick-select-modal')) closeQuickSelect(); });
			$('edit-modal')?.addEventListener('click', e => { if (e.target === $('edit-modal')) closeEditModal(); });
			document.addEventListener('keydown', e => { 
				if (e.key === 'Escape') {
					if (!$('quick-select-modal').classList.contains('hidden')) closeQuickSelect();
					if (!$('edit-modal').classList.contains('hidden')) closeEditModal();
				}
			});
            
            const tabAdd = $('tab-add');
            if (tabAdd) {
                tabAdd.addEventListener('focusin', e => {
                    if (e.target.tagName === 'INPUT' && e.target.id.startsWith('add-')) {
                        activeAddField = e.target.id;
                        const indicator = $('active-field-indicator');
                        const nameEl = $('active-field-name');
                        if (indicator && nameEl) {
                            const fieldId = e.target.id.replace('add-', '');
                            let fieldName = fieldId;
                            if (fieldId.startsWith('enemy')) {
                                const num = fieldId.replace('enemy', '').replace('Pet', '');
                                fieldName = currentLang === 'en' ? (fieldId.includes('Pet') ? 'Enemy Pet' : 'Enemy ' + num) : (fieldId.includes('Pet') ? 'Przeciwnik Pet' : 'Przeciwnik ' + num);
                            } else if (fieldId.startsWith('my')) {
                                const num = fieldId.replace('my', '').replace('Pet', '');
                                fieldName = currentLang === 'en' ? (fieldId.includes('Pet') ? 'Your Pet' : 'Your ' + num) : (fieldId.includes('Pet') ? 'Twój Pet' : 'Twój ' + num);
                            }
                            nameEl.textContent = fieldName;
                            indicator.classList.add('show');
                            updateAddFormTagsSelection();
                        }
                    }
                });
                
				tabAdd.addEventListener('keydown', e => {
								if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
									e.preventDefault();
									document.querySelectorAll('.autocomplete-list.show').forEach(l => l.classList.remove('show'));
									saveFormation();
								}
							});
						}
						
						// Setup autosave dla War Planner
						setupWarPlannerAutosave();
					});
    </script>
</body>
</html>


